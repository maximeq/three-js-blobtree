var Blobtree=function(t,e,i){"use strict";function s(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function r(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var s=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,s.get?s:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var o=s(e),n=s(i),h=r(i);function a(t,e,i){let s=`${t}: ${e} is duplicated. Your bundle includes ${e} twice. Please repair your bundle.`;try{if(void 0===THREE[e])return void(THREE[e]=i);if(THREE[e]!==i)throw s}catch(e){if(e===s)throw e;console.warn(`${t}: Duplication check unavailable.`+e)}}var p={types:{},register:function(t,e){if(this.types[t])throw"Error : cannot register type "+t+", this name is already registered.";this.types[t]=e},fromJSON:function(t){var e=this.types[t.type];if(!e)throw"Error : type found in JSON ("+t.type+" is not registered in the Blobtree library.";return e.fromJSON(t)}},l=p;const u=o.default,v=l;var m,g,_=0,y=function(){this.id=_++,this.aabb=new u.Box3,this.valid_aabb=!1,this.parentNode=null};y.prototype.constructor=y,y.type="Element",v.register(y.type,y),y.prototype.toJSON=function(){return{type:this.getType()}},y.prototype.clone=function(){return v.fromJSON(this.toJSON())},y.prototype.getParentNode=function(){return this.parentNode},y.prototype.getType=function(){return y.type},y.prototype.computeHelpVariables=function(){this.computeAABB()},y.prototype.computeAABB=function(){throw"Error : computeAABB is abstract, should have been overwritten"},y.prototype.getAABB=function(){return this.aabb},y.prototype.isValidAABB=function(){return this.valid_aabb},y.prototype.invalidAABB=function(){this.valid_aabb=!1,null!==this.parentNode&&this.parentNode.isValidAABB()&&this.parentNode.invalidAABB()},y.prototype.invalidAll=function(){this.invalidAABB()},y.prototype.prepareForEval=function(){throw"ERROR : prepareForEval is a virtual function, should be re-implemented in all element(error occured in Element.js"},y.prototype.value=function(t,e){throw"ERROR : value is an abstract function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"},y.prototype.numericalGradient=(m={v:0},g=["x","y","z"],function(t,e,i){for(var s=i||1e-5,r=0;r<3;++r)t[g[r]]=t[g[r]]+s,this.value(t,m),e[g[r]]=m.v,t[g[r]]=t[g[r]]-2*s,this.value(t,m),e[g[r]]=(e[g[r]]-m.v)/(2*s),t[g[r]]=t[g[r]]+s}),y.prototype.getAreas=function(){return[]},y.prototype.distanceTo=function(t){throw"ERROR : distanceTo is a virtual function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"},y.prototype.heuristicStepWithin=function(){throw"ERROR : heuristicStepWithin is a virtual function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"},y.prototype.trim=function(t,e,i){},y.prototype.count=function(t){return 0};var d=y;const f=d,b=l;var w=function(){f.call(this),this.children=[]};(w.prototype=Object.create(f.prototype)).constructor=w,w.type="Node",b.register(w.type,w),w.prototype.getType=function(){return w.type},w.prototype.toJSON=function(){var t=f.prototype.toJSON.call(this);t.children=[];for(var e=0;e<this.children.length;++e)t.children.push(this.children[e].toJSON());return t},w.prototype.clone=function(){return b.fromJSON(this.toJSON())},w.prototype.prepareForEval=function(){console.error("prepareForEval is a pure virtual function, should be reimplemented in every node class")},w.prototype.invalidAll=function(){if(this.invalidAABB(),this.children)for(var t=0;t<this.children.length;t++)this.children[t].invalidAll()},w.prototype.destroy=function(){for(var t=this.children.slice(0,this.children.length),e=0;e<t.length;e++)t[e].destroy();if(0!==this.children.length)throw"Error : children length should be 0";if(null!==this.parentNode&&this.parentNode.removeChild(this),null!==this.parentNode)throw"Error : parent node should be null at this point";this.children.length=0},w.prototype.addChild=function(t){null!==t.parentNode&&t.parentNode.removeChild(t),this.children.push(t),t.parentNode=this,this.invalidAABB()},w.prototype.removeChild=function(t){for(var e=0,i=this.children;i[e]!==t&&e<i.length;)++e;if(e==i.length)throw"c does not belong to the children of this node";i[e]=i[i.length-1],i.pop(),this.invalidAABB(),t.parentNode=null},w.prototype.computeAABB=function(){this.aabb.makeEmpty();for(var t=0;t<this.children.length;t++)this.children[t].computeAABB(),this.aabb.union(this.children[t].getAABB())},w.prototype.getAreas=function(){if(!this.valid_aabb)throw"Error : cannot call getAreas on a not prepared for eval nod, please call PrepareForEval first. Node concerned is a "+this.getType();for(var t=[],e=0;e<this.children.length;e++)t.push.apply(t,this.children[e].getAreas());return t},w.prototype.distanceTo=function(t){for(var e=1e7,i=0;i<this.children.length;i++)e=Math.min(e,this.children[i].distanceTo(t));return e},w.prototype.heuristicStepWithin=function(){for(var t=1e7,e=0;e<this.children.length;e++)t=Math.min(t,this.children[e].heuristicStepWithin());return t},w.prototype.trim=function(t,e,i){for(var s=e.length,r=0;r<this.children.length;r++)this.children[r].getAABB().intersectsBox(t)||(e.push(this.children[r]),i.push(this));for(r=s;r<e.length;++r)this.removeChild(e[r]);for(r=0;r<this.children.length;r++)this.children[r].trim(t,e,i)},w.prototype.count=function(t){var e=0;this instanceof t&&e++;for(var i=0;i<this.children.length;i++)e+=this.children[i].count(t);return e};var x=w;const V=o.default;var S={};S.last_mov_pt=new V.Vector3,S.grad=new V.Vector3,S.eval_res_g=new V.Vector3(0,0,0),S.eval_res={v:0,g:null},S.vec=new V.Vector3,S.safeNewton3D=function(t,e,i,s,r,o,n){n.copy(e);for(var h=1,a=0,c=!1;2!=a&&h<=r&&!c;){if(this.last_mov_pt.copy(n),this.eval_res.g=this.eval_res_g,t.value(n,this.eval_res),this.grad.copy(this.eval_res.g),0!==this.grad.x||0!==this.grad.y||0!==this.grad.z){var p=this.grad.length(),l=(i-this.eval_res.v)/p;if(l<s&&l>-s?(l=l>0?s/p:-s/p,a++):a=0,this.grad.normalize().multiplyScalar(l),n.add(this.grad),this.vec.subVectors(n,e).lengthSq()>o*o)return void n.copy(e)}else c=!0;++h}c&&n.copy(e)},S.safeNewton1D=function(t,e,i,s,r,o,n,h,a,c){if(this.eval_res.g=this.eval_res_g,0===i.x&&0===i.y&&0===i.z)throw"Error : search direction is null";if(h<=0)throw"Error: epsilon <= 0, convergence will nuke your face or loop";if(o<s||o>r)throw"Error : starting absc is not in boundaries";for(var p=o,l=new V.Vector3,u=0,v=0;r-s>h&&v<a;)t.value(l.copy(i).multiplyScalar(p).add(e),this.eval_res),this.eval_res.v>n?s=p:r=p,0!==(u=this.eval_res.g.dot(i))?((p+=(n-this.eval_res.v)/u)>=r||p<=s)&&(p=.5*(r+s)):p=.5*(r+s),++v;c.p_absc=.5*(r+s),c.p.copy(i).multiplyScalar(p).add(e),void 0!==c.g&&(0===v&&t.value(c.p,this.eval_res),c.g.copy(this.eval_res.g))},S.dichotomy1D=function(t,e,i,s,r,o,n,h){this.eval_res.g=null;var a=(new V.Vector3).copy(e),c=new V.Vector3,p=-(s/=2),l=p;e.sub(c.copy(i).multiplyScalar(s));for(var u=0;s>o&&u<n;)u++,a.copy(e),l=p,s/=2,t.value(e,this.eval_res),this.eval_res.v<r?(e.add(c.copy(i).multiplyScalar(s)),p+=s):(e.sub(c.copy(i).multiplyScalar(s)),p-=s);h.p.copy(e.add(a).divideScalar(2)),h.p_absc=(l+p)/2,h.p.copy(e),h.p_absc=p,h.g&&(this.eval_res.g=this.eval_res_g,t.value(h.p,this.eval_res),h.g.copy(this.eval_res.g))};var A=S;const M=o.default;var T=function(t){if(t=t||{},void 0!==arguments[1])throw"Error : Blobtree Material now takes only 1 argument.";this.color=new M.Color(void 0!==t.color?t.color:11184810),this.roughness=void 0!==t.roughness?t.roughness:0,this.metalness=void 0!==t.metalness?t.metalness:0,this.emissive=new M.Color(void 0!==t.emissive?t.emissive:0)};T.prototype.toJSON=function(){return{color:"#"+this.color.getHexString(),roughness:this.roughness,metalness:this.metalness,emissive:`#${this.emissive.getHexString()}`}},T.fromJSON=function(t){return new T({color:new M.Color(t.color),roughness:t.roughness,metalness:t.metalness,emissive:t.emissive})},T.prototype.clone=function(){return new T({color:this.color,roughness:this.roughness,metalness:this.metalness,emissive:this.emissive})},T.prototype.copy=function(t){this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.emissive.copy(t.emissive)},T.prototype.set=function(t,e,i){this.color.copy(t),this.roughness=e,this.metalness=i},T.prototype.setParams=function(t){this.color.copy(t.color?t.color:this.color),this.roughness=void 0!==t.roughness?t.roughness:this.roughness,this.metalness=void 0!==t.metalness?t.metalness:this.metalness,this.emissive.copy(void 0!==t.emissive?t.emissive:this.emissive)},T.prototype.getColor=function(){return this.color},T.prototype.getRoughness=function(){return this.roughness},T.prototype.getMetalness=function(){return this.metalness},T.prototype.getEmissive=function(){return this.emissive},T.prototype.equals=function(t){return this.color.equals(t.color)&&this.metalness===t.metalness&&this.roughness===t.roughness&&this.emissive.equals(t.emissive)},T.prototype.lerp=function(t,e){this.color.lerp(t.color,e),this.roughness=(1-e)*this.roughness+e*t.roughness,this.metalness=(1-e)*this.metalness+e*t.metalness,this.emissive.lerp(t.emissive,e)},T.prototype.triMean=function(t,e,i,s,r,o,n){return this.color.r=(s*t.color.r+r*e.color.r+o*i.color.r)/n,this.color.g=(s*t.color.g+r*e.color.g+o*i.color.g)/n,this.color.b=(s*t.color.b+r*e.color.b+o*i.color.b)/n,this.roughness=(s*t.roughness+r*e.roughness+o*i.roughness)/n,this.metalness=(s*t.metalness+r*e.metalness+o*i.metalness)/n,this.emissive.r=(s*t.emissive.r+r*e.emissive.r+o*i.emissive.r)/n,this.emissive.g=(s*t.emissive.g+r*e.emissive.g+o*i.emissive.g)/n,this.emissive.b=(s*t.emissive.b+r*e.emissive.b+o*i.emissive.b)/n,this},T.prototype.weightedMean=function(t,e,i){this.color.setRGB(0,0,0),this.roughness=0,this.metalness=0,this.emissive.setScalar(0);const s=void 0===i?t.length:i;let r=0;for(let i=0;i<s;++i)this.color.r+=e[i]*t[i].color.r,this.color.g+=e[i]*t[i].color.g,this.color.b+=e[i]*t[i].color.b,this.roughness+=e[i]*t[i].roughness,this.metalness+=e[i]*t[i].metalness,this.emissive.r+=e[i]*t[i].emissive.r,this.emissive.g+=e[i]*t[i].emissive.g,this.emissive.b+=e[i]*t[i].emissive.b,r+=e[i];return 0!==r?(this.color.r/=r,this.color.g/=r,this.color.b/=r,this.roughness/=r,this.metalness/=r,this.emissive.r/=r,this.emissive.g/=r,this.emissive.b/=r):(this.color.setScalar(0),this.roughness=0,this.metalness=0,this.emissive.setScalar(0)),this},T.areEqualsArrays=function(t,e,i,s,r){console.warn("Material.areEqualsArrays is deprecated, please use your own comparison function using Material.equals.");for(var o=!0,n=1;n<arguments.length;n++)o=o&&(null===t&&null===arguments[n]||null!==t&&null!==arguments[n]);if(!o)return o;if(null===t)return!0;for(n=1;n<arguments.length;n++){var h=!0;if(arguments[n].length!==t.length)return!1;for(var a=0;a<t.length;++a)h=h&&t[a].equals(arguments[n][a]);o=o&&h}return o},T.defaultMaterial=new T;var P=T;const B=o.default,N=l,F=x,k=P;var D=function(t,e){if(F.call(this),this.ricci_n=t,e){var i=this;e.forEach((function(t){i.addChild(t)}))}this.tmp_v_arr=new Float32Array(0),this.tmp_m_arr=new Array(0),this.tmp_res={v:0,g:null,m:null},this.tmp_g=new B.Vector3,this.tmp_m=new k};(D.prototype=Object.create(F.prototype)).constructor=D,D.type="RicciNode",N.register(D.type,D),D.prototype.getType=function(){return D.type},D.prototype.toJSON=function(){var t=F.prototype.toJSON.call(this);return t.ricci=this.ricci_n,t},D.fromJSON=function(t){for(var e=new D(t.ricci),i=0;i<t.children.length;++i)e.addChild(N.fromJSON(t.children[i]));return e},D.prototype.prepareForEval=function(){if(!this.valid_aabb){this.aabb=new B.Box3;for(var t=0;t<this.children.length;++t){var e=this.children[t];e.prepareForEval(),this.aabb.union(e.getAABB())}if(this.valid_aabb=!0,this.tmp_v_arr.length<this.children.length){this.tmp_v_arr=new Float32Array(2*this.children.length),this.tmp_m_arr.length=2*this.children.length;for(t=0;t<this.tmp_m_arr.length;++t)this.tmp_m_arr[t]=new k({roughness:0,metalness:0})}}},D.prototype.value=function(t,e){var i=this.children.length,s=this.tmp_res;if(s.g=e.g?this.tmp_g:null,s.m=e.m?this.tmp_m:null,e.v=0,e.m&&e.m.copy(k.defaultMaterial),e.g?e.g.set(0,0,0):void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)&&0!==i){for(var r=this.tmp_v_arr,o=this.tmp_m_arr,n=0,h=0,a=0;a<i;++a)if(this.children[a].aabb.containsPoint(t))if(this.children[a].value(t,s),s.v>0){var c=Math.pow(s.v,this.ricci_n-1);h+=s.v*c,e.g&&(s.g.multiplyScalar(c),e.g.add(s.g)),e.m&&(r[n]=s.v*c,o[n].copy(s.m),n++),(e.step||e.stepOrtho)&&(e.step=Math.min(e.step,this.children[a].heuristicStepWithin()))}else void 0!==e.step&&(e.step=Math.min(e.step,this.children[a].distanceTo(t)));else(e.step||e.stepOrtho)&&(e.step=Math.min(e.step,this.children[a].distanceTo(t)));e.v=Math.pow(h,1/this.ricci_n),0!==e.v&&(e.g&&e.g.multiplyScalar(e.v/h),e.m&&e.m.weightedMean(o,r,n))}else if(void 0!==e.step&&0!==this.children.length){var p=this.children[0].heuristicStepWithin();for(a=1;a<this.children.length;++a)p=Math.min(p,this.children[a].heuristicStepWithin());e.step=this.aabb.distanceToPoint(t)+p}void 0!==e.stepOrtho&&(e.stepOrtho=e.step)},D.prototype.setRicciN=function(t){this.ricci_n!=t&&(this.ricci_n=t,this.invalidAABB())},D.prototype.getRicciN=function(){return this.ricci_n};var z=D;const O=o.default,E=l,R=z,j=A;var q,C,I,J,K,G,H,L,U=function(){R.call(this,64),this.valid_aabb=!0,this.iso_value=1,this.trimmed=[],this.trim_parents=[]};(U.prototype=Object.create(R.prototype)).constructor=U,U.type="RootNode",E.register(U.type,U),U.prototype.getType=function(){return U.type},U.prototype.toJSON=function(){var t=R.prototype.toJSON.call(this);return t.iso=this.iso_value,t},U.fromJSON=function(t){for(var e=new U(t.ricci),i=0;i<t.children.length;++i)e.addChild(E.fromJSON(t.children[i]));return e},U.prototype.getIsoValue=function(){return this.iso_value},U.prototype.setIsoValue=function(t){this.iso_value=t},U.prototype.getNeutralValue=function(){return 0},U.prototype.invalidAABB=function(){this.valid_aabb=!1},U.prototype.internalTrim=function(t){if(0!==this.trimmed.length||0!==this.trim_parents.length)throw"Error : you should not call internal trim if you have not untrimmed before. Call untrim or use externalTrim";this.trim(t,this.trimmed,this.trim_parents)},U.prototype.externalTrim=function(t,e,i){this.trim(t,e,i)},U.prototype.internalUntrim=function(){this.untrim(this.trimmed,this.trim_parents),this.trimmed.length=0,this.trim_parents.length=0},U.prototype.untrim=function(t,e){if(t.length!==e.length)throw"Error : trimmed and parents arrays should have the same length";for(var i=0;i<t.length;++i)e[i].addChild(t[i])},U.prototype.isEmpty=function(){return 0==this.children.length},U.prototype.intersectRayBlob=(q=new O.Vector3,C=new O.Vector3,I=new O.Vector3,J={v:0,g:new O.Vector3,step:0},K={p:new O.Vector3,g:new O.Vector3,p_absc:0},G=0,H=0,L=0,function(t,e,i,s){for(q.copy(t.origin),C.copy(t.direction),C.normalize(),L=0,J.g=null,this.value(q,J);J.v<this.iso_value&&L<i;)q.add(I.copy(C).multiplyScalar(J.step)),L+=J.step,G=J.step,H=J.v,this.value(q,J);return J.v>=this.iso_value&&(j.safeNewton1D(this,q,C.multiplyScalar(-1),0,G,G*(this.iso_value-J.v)/(H-J.v),this.iso_value,G/512,10,K),e.distance=L-K.p_absc,e.point=K.p.clone(),e.g&&e.g.copy(K.g),!0)}),U.prototype.intersectOrthoRayBlob=function(){var t=new O.Vector3,e=new O.Vector3,i={step:0},s=new O.Vector3,r={},o=0,n=0,h=1e-7,a=-1;return function(c,p,l,u){for(u.axis.z?t.set(this.aabb.min.x+c,this.aabb.min.y+p,this.aabb.min.z+h):u.axis.y?t.set(this.aabb.min.x+c,this.aabb.min.y+h,this.aabb.min.z+p):u.axis.z&&t.set(this.aabb.min.x+h,this.aabb.min.y+c,this.aabb.min.z+p),i.step=u.get(this.aabb.max)-u.get(this.aabb.min),this.value(t,i),o=h,a=-1;u.get(t)<u.get(this.aabb.max);){for(;(i.v-1)*a>=0&&u.get(t)<u.get(this.aabb.max);)u.add(t,i.step),o=i.step,i.step=u.get(this.aabb.max)-u.get(t),this.value(t,i);if(u.get(t)<u.get(this.aabb.max)){for(a*=-1,e.copy(t),n=u.get(t),o/=2,u.add(t,-o),r.g=null;o>.1;)n=u.get(t),o/=2,this.value(t,r),(r.v-1)*a<0?u.add(t,o):u.add(t,-o);u.add(t,n),u.divide(t,2),r.g=s,this.value(t,r),l.push({point:t.clone(),gradient:r.g.clone()}),t.copy(e)}}}}();var W=U;const Z=o.default,$=l,X=x,Y=P;var Q=function(t,e,i){X.call(this),this.addChild(t),this.addChild(e),this.alpha=i||1,this.clamped=0,this.tmp_res0={v:0,g:new Z.Vector3(0,0,0),m:new Y},this.tmp_res1={v:0,g:new Z.Vector3(0,0,0),m:new Y},this.g0=new Z.Vector3,this.m0=new Y,this.g1=new Z.Vector3,this.m1=new Y,this.tmp_v_arr=new Float32Array(2),this.tmp_m_arr=[null,null]};(Q.prototype=Object.create(X.prototype)).constructor=Q,Q.type="DifferenceNode",$.register(Q.type,Q),Q.prototype.getAlpha=function(){return this.alpha},Q.prototype.setAlpha=function(t){this.alpha!=t&&(this.alpha=t,this.invalidAABB())},Q.prototype.toJSON=function(){var t=X.prototype.toJSON.call(this);return t.alpha=this.alpha,t},Q.fromJSON=function(t){var e=new Q;return this.children[0]=$.fromJSON(t.children[0]),this.children[1]=$.fromJSON(t.children[1]),e},Q.prototype.prepareForEval=function(){this.valid_aabb||(this.children[0].prepareForEval(),this.children[1].prepareForEval(),this.aabb.copy(this.children[0].getAABB()),this.valid_aabb=!0)},Q.prototype.value=function(t,e){this.children.length;var i=this.tmp_v_arr,s=this.tmp_m_arr,r=this.tmp_res0,o=this.tmp_res1;if(r.g=e.g?this.g0:null,r.m=e.m?this.m0:null,o.g=e.g?this.g1:null,o.m=e.m?this.m1:null,e.v=0,o.v=0,r.v=0,e.m&&(e.m.copy(Y.defaultMaterial),o.m.copy(Y.defaultMaterial),r.m.copy(Y.defaultMaterial)),e.g?(e.g.set(0,0,0),o.g.set(0,0,0),r.g.set(0,0,0)):void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)){if(this.children[0].aabb.containsPoint(t))if(this.children[0].value(t,r),this.children[1].aabb.containsPoint(t)&&this.children[1].value(t,o),0===o.v)e.v=r.v,e.g&&e.g.copy(r.g),e.m&&e.m.copy(r.m);else{var n=Math.pow(o.v,this.alpha);e.v=Math.max(this.clamped,r.v-o.v*Math.pow(o.v,this.alpha-1)),e.g&&(e.v===this.clamped?e.g.set(0,0,0):(o.g.multiplyScalar(n),e.g.subVectors(r.g,o.g))),e.m&&(i[0]=r.v,i[1]=o.v,s[0]=r.m,s[1]=o.m,e.m.weightedMean(s,i,2))}}else void 0!==e.step&&(e.step=this.aabb.distanceToPoint(t)+.3)},Q.prototype.trim=function(t,e,i){for(var s=0;s<this.children.length;s++)this.children[s].trim(t,e,i)};var tt=Q;const et=o.default,it=l,st=x,rt=P;var ot=function(t){if(st.call(this),t){var e=this;t.forEach((function(t){e.addChild(t)}))}this.tmp_res={v:0,g:null,m:null},this.tmp_g=new et.Vector3,this.tmp_m=new rt};(ot.prototype=Object.create(st.prototype)).constructor=ot,ot.type="MinNode",it.register(ot.type,ot),ot.prototype.getType=function(){return ot.type},ot.fromJSON=function(t){for(var e=new ot,i=0;i<t.children.length;++i)e.addChild(it.fromJSON(t.children[i]));return e},ot.prototype.prepareForEval=function(){if(!this.valid_aabb){this.aabb=new et.Box3;for(var t=0;t<this.children.length;++t){var e=this.children[t];e.prepareForEval(),this.aabb.union(e.getAABB())}this.valid_aabb=!0}},ot.prototype.value=function(t,e){var i=this.children.length,s=this.tmp_res;if(s.g=e.g?this.tmp_g:null,s.m=e.m?this.tmp_m:null,e.v=0,e.m&&e.m.copy(rt.defaultMaterial),e.g?e.g.set(0,0,0):void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)&&0!==i){e.v=Number.MAX_VALUE;for(var r=0;r<i;++r){if(this.children[r].value(t,s),s.v<e.v&&(e.v=s.v,e.g&&e.g.copy(s.g),e.m&&e.m.copy(s.m),e.step||e.stepOrtho))throw"Not implemented";e.v=Math.min(e.v,s.v)}}else if(e.steo||e.stepOrtho)throw"Not implemented"},ot.prototype.trim=function(t,e,i){for(var s=0;s<this.children.length;s++)this.children[s].trim(t,e,i)};var nt=ot;const ht=d,at=l;var ct=function(){ht.call(this),this.materials=[]};(ct.prototype=Object.create(ht.prototype)).constructor=ct,ct.type="Primitive",at.register(ct.type,ct),ct.prototype.toJSON=function(t){var e=ht.prototype.toJSON.call(this);e.materials=[];for(var i=0;i<this.materials.length;++i)e.materials.push(this.materials[i].toJSON());return e},ct.prototype.setMaterials=function(t){if(t.length!==this.materials.length)throw"Error : trying to set "+t.length+" materials on a primitive with only "+this.materials.length;for(var e=0;e<t.length;++e)t[e].equals(this.materials[e])||(this.materials[e].copy(t[e]),this.invalidAABB())},ct.prototype.getMaterials=function(){return this.materials},ct.prototype.computeAABB=function(){throw"Primitive.prototype.computeAABB  Must be reimplemented in all inherited class."},ct.prototype.destroy=function(){null!==this.parentNode&&this.parentNode.removeChild(this)},ct.prototype.getAreas=function(){throw"ERROR : getAreas is an abstract function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"},ct.prototype.computeHelpVariables=function(){throw"ERROR : computeHelpVariables is a virtual function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"},ct.prototype.count=function(t){return this instanceof t?1:0};var pt=ct,lt={KS:2};lt.KIS=1/lt.KS,lt.KS2=4,lt.KIS2=1/(lt.KS*lt.KS),lt.Poly6Eval=function(t){var e=1-lt.KIS2*t*t;return e>0?e*e*e:0},lt.Poly6EvalSq=function(t){var e=1-lt.KIS2*t;return e>0?e*e*e:0},lt.GetIsoValueAtDistanceGeom0D=function(t,e,i){if(t%2!=0)throw"degree should be even";if(i<e){var s=1-i*i/(e*e);return Math.pow(s,t/2)}return 0},lt.Poly4NF0D=1/lt.GetIsoValueAtDistanceGeom0D(4,lt.KS,1),lt.Poly6NF0D=1/lt.GetIsoValueAtDistanceGeom0D(6,lt.KS,1),lt.GetIsoValueAtDistanceGeom1D=function(t,e,i){if(t%2!=0)throw"degree should be even";if(i<e){for(var s=1-i*i/(e*e),r=2*e*Math.sqrt(s),o=0;o!=t;)r*=(o+=2)/(1+o)*s;return r}return 0},lt.Poly4NF1D=1/lt.GetIsoValueAtDistanceGeom1D(4,lt.KS,1),lt.Poly6NF1D=1/lt.GetIsoValueAtDistanceGeom1D(6,lt.KS,1),lt.GetIsoValueAtDistanceGeom2D=function(t,e,i){if(i<e){var s=t+2,r=1-i*i/(e*e);return 2*Math.PI/s*e*e*Math.pow(r,.5*s)}return 0},lt.Poly4NF2D=1/lt.GetIsoValueAtDistanceGeom2D(4,lt.KS,1),lt.Poly6NF2D=1/lt.GetIsoValueAtDistanceGeom2D(6,lt.KS,1);var ut=lt;const vt=l,mt=pt;var gt=function(){mt.call(this),this.volType=gt.DIST,this.v=[]};gt.DIST="dist",gt.CONVOL="convol",gt.prototype=Object.create(mt.prototype),gt.prototype.constructor=gt,gt.type="ScalisPrimitive",vt.register(gt.type,gt),gt.prototype.getType=function(){return gt.type},gt.prototype.toJSON=function(){var t=mt.prototype.toJSON.call(this);t.v=[],t.volType=this.volType;for(var e=0;e<this.v.length;++e)t.v.push(this.v[e].toJSON());return t},gt.prototype.mutableVolType=function(){return!1},gt.prototype.setVolType=function(t){t!==this.volType&&(this.volType=t,this.invalidAABB())},gt.prototype.getVolType=function(){return this.volType},gt.prototype.computeAABB=function(){this.aabb.makeEmpty();for(var t=0;t<this.v.length;t++)this.aabb.union(this.v[t].getAABB())};var _t=gt;const yt=o.default,dt=ut;var ft=0,bt=function(t,e){this.pos=t.clone(),this.thickness=e,this.id=ft++,this.prim=null,this.aabb=new yt.Box3,this.valid_aabb=!1};bt.prototype.setPrimitive=function(t){null===this.prim&&(this.prim=t)},bt.prototype.toJSON=function(){return{position:{x:this.pos.x,y:this.pos.y,z:this.pos.z},thickness:this.thickness}},bt.fromJSON=function(t){return new bt(new yt.Vector3(t.position.x,t.position.y,t.position.z),t.thickness)},bt.prototype.setPos=function(t){this.valid_aabb=!1,this.pos.copy(t),this.prim.invalidAABB()},bt.prototype.setThickness=function(t){this.valid_aabb=!1,this.thickness=t,this.prim.invalidAABB()},bt.prototype.setAll=function(t,e){this.valid_aabb=!1,this.pos=t,this.thickness=e,this.prim.invalidAABB()},bt.prototype.getPos=function(){return this.pos},bt.prototype.getThickness=function(){return this.thickness},bt.prototype.getAABB=function(){return this.valid_aabb||(this.computeAABB(),this.valid_aabb=!0),this.aabb},bt.prototype.computeAABB=function(){var t=this.getPos(),e=this.getThickness()*dt.KS;this.aabb.set(new yt.Vector3(t.x-e,t.y-e,t.z-e),new yt.Vector3(t.x+e,t.y+e,t.z+e))},bt.prototype.equals=function(t){return this.pos.equals(t.pos)&&this.thickness===t.thickness};var wt=bt,xt=function(){};xt.prototype.sphereIntersect=function(t){throw"Error : sphereIntersect is abstract, should have been overwritten"},xt.prototype.contains=function(t){throw"Error : contains is abstract, should have been overwritten"},xt.prototype.getAcc=function(t,e){throw"Error : getAcc is abstract, should have been overwritten"},xt.prototype.getNiceAcc=function(t){throw"Error : getNiceAcc is abstract, should have been overwritten"},xt.prototype.getCurrAcc=function(t){throw"Error : getCurrAcc is abstract, should have been overwritten"},xt.prototype.getRawAcc=function(t){throw"Error : getRawAcc is abstract, should have been overwritten"},xt.prototype.getMinAcc=function(){throw"Error : getRawAcc is abstract, should have been overwritten"},xt.prototype.getMinRawAcc=function(){throw"Error : getRawAcc is abstract, should have been overwritten"};var Vt=xt,St={nice:.3,raw:1,curr:.3},At=St;const Mt=o.default,Tt=Vt,Pt=At;var Bt,Nt=function(t,e,i){Tt.call(this),this.p=new Mt.Vector3(t.x,t.y,t.z),this.r=e,this.accFactor=i||1};(Nt.prototype=Object.create(Tt.prototype)).constructor=Nt,Nt.prototype.sphereIntersect=(Bt=new Mt.Vector3,function(t){Bt.subVectors(t.center,this.p);var e=t.radius+this.radius;return Bt.lengthSq()<e*e}),Nt.prototype.contains=function(){var t=new Mt.Vector3;return function(e){return t.subVectors(e,this.p),t.lengthSq()<this.r*this.r}}(),Nt.prototype.getAcc=function(t,e){return this.radius*e},Nt.prototype.getNiceAcc=function(t){return this.getAcc(t,Pt.nice*this.accFactor)},Nt.prototype.getCurrAcc=function(t){return this.getAcc(t,Pt.curr*this.accFactor)},Nt.prototype.getRawAcc=function(t){return this.getAcc(t,Pt.raw*this.accFactor)},Nt.prototype.getMinAcc=function(){return Pt.curr*this.r*this.accFactor},Nt.prototype.getMinRawAcc=function(){return Pt.raw*this.r*this.accFactor},Nt.prototype.getAxisProjectionMinStep=function(t,e){var i=1e8,s=e-this.p[t];return s<-2*this.r?i=Math.min(i,Math.max(Math.abs(s+this.r),Pt.curr*this.r*this.accFactor)):s<2*this.r&&(i=Math.min(i,Pt.curr*this.r*this.accFactor)),i};var Ft=Nt;const kt=o.default,Dt=l,zt=P,Ot=_t,Et=wt,Rt=ut,jt=Ft;var qt=function(t,e,i,s){Ot.call(this),this.v.push(t),this.v[0].setPrimitive(this),this.volType=e,this.density=i,this.materials.push(s),this.v_to_p=new kt.Vector3};(qt.prototype=Object.create(Ot.prototype)).constructor=qt,qt.type="ScalisPoint",Dt.register(qt.type,qt),qt.prototype.getType=function(){return qt.type},qt.prototype.toJSON=function(){var t=Ot.prototype.toJSON.call(this);return t.density=this.density,t},qt.fromJSON=function(t){var e=Et.fromJSON(t.v[0]),i=zt.fromJSON(t.materials[0]);return new qt(e,t.volType,t.density,i)},qt.prototype.setDensity=function(t){this.density=t,this.invalidAABB()},qt.prototype.getDensity=function(){return this.density},qt.prototype.setMaterial=function(t){this.materials[0].copy(t),this.invalidAABB()},qt.prototype.computeHelpVariables=function(){this.computeAABB()},qt.prototype.prepareForEval=function(){this.valid_aabb||(this.computeHelpVariables(),this.valid_aabb=!0)},qt.prototype.getAreas=function(){if(this.valid_aabb)return[{aabb:this.aabb,bv:new jt(this.v[0].getPos(),Rt.KS*this.v[0].getThickness(),Rt.KIS),obj:this}];throw"ERROR : Cannot get area of invalid primitive"},qt.prototype.heuristicStepWithin=function(){return this.v[0].getThickness()/3},qt.prototype.value=function(t,e){if(!this.valid_aabb)throw"Error : PrepareForEval should have been called";var i=this.v[0].getThickness();this.v_to_p.subVectors(t,this.v[0].getPos());var s=this.v_to_p.lengthSq()/(i*i),r=1-Rt.KIS2*s;if(r>0){if(e.v=this.density*r*r*r*Rt.Poly6NF0D,e.g){var o=-this.density*Rt.KIS2*6*this.v_to_p.length()*r*r*Rt.Poly6NF0D/(i*i);e.g.copy(this.v_to_p).normalize().multiplyScalar(o)}e.m&&e.m.copy(this.materials[0])}else e.v=0,e.g&&e.g.set(0,0,0),e.m&&e.m.copy(zt.defaultMaterial)},qt.prototype.distanceTo=function(t){return t.distanceTo(this.v[0].getPos())};var Ct=qt;const It=o.default,Jt=ut,Kt=Vt,Gt=At;var Ht=function(t,e,i,s){Kt.call(this),this.p0=new It.Vector3(t.x,t.y,t.z),this.p1=new It.Vector3(e.x,e.y,e.z),this.thick0=i,this.thick1=s,this.unit_dir=(new It.Vector3).subVectors(e,t),this.length=this.unit_dir.length(),this.unit_dir.normalize(),this.vector=new It.Vector3,this.p0_to_p=this.vector,this.p0_to_p_sqrnorm=0,this.x_p_2D=0,this.y_p_2D=0,this.y_p_2DSq=0,this.ortho_vec_x=this.thick0-this.thick1,this.ortho_vec_y=this.length,this.p_proj_x=0,this.p_proj_y=0,this.abs_diff_thick=Math.abs(this.ortho_vec_x)};(Ht.prototype=Object.create(Kt.prototype)).constructor=Ht,Ht.prototype.proj_computation=function(t){this.p0_to_p=this.vector,this.p0_to_p.subVectors(t,this.p0),this.p0_to_p_sqrnorm=this.p0_to_p.lengthSq(),this.x_p_2D=this.p0_to_p.dot(this.unit_dir),this.y_p_2DSq=this.p0_to_p_sqrnorm-this.x_p_2D*this.x_p_2D,this.y_p_2D=this.y_p_2DSq>0?Math.sqrt(this.y_p_2DSq):0;var e=-this.y_p_2D/this.ortho_vec_y;this.p_proj_x=this.x_p_2D+e*this.ortho_vec_x,this.p_proj_y=0},Ht.prototype.sphereIntersect=function(t){if(this.proj_computation(t.center),this.p_proj_x<0)return Math.sqrt(this.p0_to_p_sqrnorm)-t.radius<this.thick0*Jt.KS;if(this.p_proj_x>this.length)return this.vector.subVectors(t.center,this.p1),Math.sqrt(this.vector.lengthSq())-t.radius<this.thick1*Jt.KS;var e=this.x_p_2D-this.p_proj_x,i=e*e+this.y_p_2DSq,s=this.p_proj_x/this.length,r=this.thick0*(1-s)+s*this.thick1,o=t.radius+r*Jt.KS;return i<o*o},Ht.prototype.contains=function(t){if(this.proj_computation(t),this.p_proj_x<0)return this.p0_to_p_sqrnorm<this.thick0*this.thick0*Jt.KS2;if(this.p_proj_x>this.length)return this.vector.subVectors(t,this.p1),this.vector.lengthSq()<this.thick1*this.thick1*Jt.KS2;var e=this.x_p_2D-this.p_proj_x,i=this.y_p_2D-this.p_proj_y,s=e*e+i*i,r=this.p_proj_x/this.length,o=this.thick0*(1-r)+r*this.thick1;return s<o*o*Jt.KS2},Ht.prototype.getAcc=function(t,e){this.proj_computation(t.center);var i=this.abs_diff_thick/this.length,s=t.radius*Math.sqrt(1+i*i)*.5,r=this.p_proj_x;if((r+=this.thick0>this.thick1?s:-s)<0)return this.thick0*e;if(r>this.length)return this.thick1*e;var o=r/this.length;return(this.thick0*(1-o)+o*this.thick1)*e},Ht.prototype.getNiceAcc=function(t){return this.getAcc(t,Gt.nice)},Ht.prototype.getCurrAcc=function(t){return this.getAcc(t,Gt.curr)},Ht.prototype.getRawAcc=function(t){return this.getAcc(t,Gt.raw)},Ht.prototype.getMinAcc=function(){return Gt.curr*Math.min(this.thick0,this.thick1)},Ht.prototype.getMinRawAcc=function(){return Gt.raw*Math.min(this.thick0,this.thick1)},Ht.prototype.getAxisProjectionMinStep=function(t,e){var i,s,r,o=Number.MAX_VALUE,n=this.p0[t]<this.p1[t]?this.p0:this.p1;n===this.p0?(i=this.p1,s=this.thick0,r=this.thick1):(i=this.p0,s=this.thick1,r=this.thick0);var h=e-n[t];h<-2*s?o=Math.min(o,Math.max(Math.abs(h+2*s),Gt.curr*s)):h<2*s&&(o=Math.min(o,Gt.curr*s)),(h=e-i[t])<-2*r?o=Math.min(o,Math.max(Math.abs(h+2*r),Gt.curr*r)):h<2*r&&(o=Math.min(o,Gt.curr*r));var a=e-n[t],c=i[t]-n[t];return a>0&&a<c&&0!==c&&(o=Math.min(o,Gt.curr*(s+a/c*(r-s)))),o};var Lt=Ht;const Ut=o.default,Wt=l,Zt=P,$t=_t,Xt=wt,Yt=ut,Qt=Lt;var te,ee,ie,se,re=function(t,e,i,s,r){$t.call(this),this.v.length=2,this.v[0]=t,this.v[1]=e,t.setPrimitive(this),e.setPrimitive(this),this.volType=i,this.density=s,this.materials=r,this.clipped_l1=1,this.clipped_l2=0,this.vector=new Ut.Vector3,this.cycle=new Ut.Vector3,this.proj=new Ut.Vector3,this.v0_p=this.v[0].getPos(),this.v1_p=this.v[1].getPos(),this.dir=new Ut.Vector3,this.lengthSq=0,this.length=0,this.unit_dir=new Ut.Vector3,this.weight_p1=0,this.c0=0,this.c1=0,this.increase_unit_dir=new Ut.Vector3,this.p_min=new Ut.Vector3,this.weight_min=0,this.inv_weight_min=0,this.unit_delta_weight=0,this.maxbound=0,this.maxboundSq=0,this.cyl_bd0=0,this.cyl_bd1=0,this.f0f1f2=new Ut.Vector3,this.tmpVec1=new Ut.Vector3,this.tmpVec2=new Ut.Vector3,this.computeHelpVariables()};re.prototype=Object.create($t.prototype),re.constructor=re,re.type="ScalisSegment",Wt.register(re.type,re),re.prototype.getType=function(){return re.type},re.prototype.toJSON=function(){var t=$t.prototype.toJSON.call(this);return t.density=this.density,t},re.fromJSON=function(t){var e=Xt.fromJSON(t.v[0]),i=Xt.fromJSON(t.v[1]),s=[Zt.fromJSON(t.materials[0]),Zt.fromJSON(t.materials[1])];return new re(e,i,t.volType,t.density,s)},re.prototype.mutableVolType=function(){return!0},re.prototype.setDensity=function(t){this.density=t,this.invalidAABB()},re.prototype.getDensity=function(){return this.density},re.prototype.setVolType=function(t){if(t!=$t.CONVOL&&t!=$t.DIST)throw"ERROR : volType must be set to ScalisPrimitive.CONVOL or ScalisPrimitive.DIST";this.volType!=t&&(this.volType=t,this.invalidAABB())},re.prototype.getVolType=function(){return this.volType},re.prototype.prepareForEval=function(){this.valid_aabb||(this.computeHelpVariables(),this.valid_aabb=!0)},re.prototype.getAreas=function(){if(this.valid_aabb)return[{aabb:this.aabb,bv:new Qt(this.v[0].getPos(),this.v[1].getPos(),this.v[0].getThickness(),this.v[1].getThickness(),this.length,this.unit_dir),obj:this}];throw"ERROR : Cannot get area of invalid primitive"},re.prototype.computeHelpVariables=function(){this.v0_p=this.v[0].getPos(),this.v1_p=this.v[1].getPos(),this.dir.subVectors(this.v1_p,this.v0_p),this.lengthSq=this.dir.lengthSq(),this.length=Math.sqrt(this.lengthSq),this.unit_dir.copy(this.dir).normalize(),this.weight_p1=this.v[1].getThickness(),this.c0=this.v[0].getThickness(),this.c1=this.v[1].getThickness()-this.v[0].getThickness();var t=this.v[0].getThickness()*Yt.KS,e=this.v[1].getThickness()*Yt.KS;this.maxbound=Math.max(t,e),this.maxboundSq=this.maxbound*this.maxbound,this.cyl_bd0=Math.min(-t,this.length-e),this.cyl_bd1=Math.max(this.length+e,t),this.increase_unit_dir.copy(this.unit_dir),this.c1<0?(this.p_min.copy(this.v1_p),this.weight_min=this.weight_p1,this.inv_weight_min=1/this.weight_p1,this.increase_unit_dir.negate(),this.unit_delta_weight=-this.c1/this.length):(this.p_min.copy(this.v0_p),this.weight_min=this.c0,this.inv_weight_min=1/this.c0,this.unit_delta_weight=this.c1/this.length),this.computeAABB()},re.prototype.value=function(t,e){switch(this.volType){case $t.DIST:this.evalDist(t,e);break;case $t.CONVOL:this.evalConvol(t,e);break;default:throw"Unknown volType, cannot evaluate."}},re.prototype.evalDist=(te={v:0},ee=new Ut.Vector3,function(t,e){var i=this.vector;i.subVectors(t,this.v[0].getPos());var s=i.dot(this.dir),r=i.lengthSq(),o=this.lengthSq*this.c0+s*this.c1,n=this.c1<0?0:1;o>0&&(n=(n=s*this.c0+r*this.c1)<0?0:n>o?1:n/o);var h=Math.sqrt(n*(n*this.lengthSq-2*s)+r),a=this.c0+n*this.c1;if(e.v=this.density*Yt.Poly6Eval(h/a)*Yt.Poly6NF0D,e.m&&this.evalMat(t,e),e.g){var c=1e-5,p=this.density/c;ee.copy(t),ee.x+=c,this.evalDist(ee,te),e.g.x=p*(te.v-e.v),ee.x-=c,ee.y+=c,this.evalDist(ee,te),e.g.y=p*(te.v-e.v),ee.y-=c,ee.z+=c,this.evalDist(ee,te),e.g.z=p*(te.v-e.v)}}),re.prototype.evalMat=function(t,e){var i=this.vector;i.subVectors(t,this.v[0].getPos());var s=this.unit_dir.dot(i)/this.length;s>1?e.m.copy(this.materials[1]):s<=0?e.m.copy(this.materials[0]):(e.m.copy(this.materials[0]),e.m.lerp(this.materials[1],s))},re.prototype.HomotheticClippingSpecial=function(t){var e=-t.z,i=-t.y,s=-t.x,r=i*i-e*s;if(r>=0){var o=i+Math.sqrt(r);if(o<0||this.length*o<s)return!1;var n=s/o;this.clipped_l1=n<0?0:n;var h=e*n;return this.clipped_l2=2*i<h+e*this.length?s/h:this.length,!0}return!1},re.prototype.heuristicStepWithin=function(){return this.weight_min/3},re.prototype.evalConvol=function(t,e){if(!this.valid_aabb)throw"Error : prepareForEval should have been called";e.g&&e.g.set(0,0,0),e.v=0;var i=this.tmpVec1;i.subVectors(t,this.p_min);var s=this.increase_unit_dir.dot(i),r=i.lengthSq(),o=this.tmpVec2;if(o.set(this.weight_min*this.weight_min-Yt.KIS2*r,-this.unit_delta_weight*this.weight_min-Yt.KIS2*s,this.unit_delta_weight*this.unit_delta_weight-Yt.KIS2),this.HomotheticClippingSpecial(o)){var n=1/(this.weight_min+this.clipped_l1*this.unit_delta_weight);o.x=1-Yt.KIS2*(this.clipped_l1*(this.clipped_l1-2*s)+r)*n*n,o.y=-this.unit_delta_weight-Yt.KIS2*(s-this.clipped_l1)*n,e.g?(this.unit_delta_weight>=.06?this.HomotheticCompactPolynomial_segment_FGradF_i6((this.clipped_l2-this.clipped_l1)*n,this.unit_delta_weight,o):this.HomotheticCompactPolynomial_approx_segment_FGradF_i6((this.clipped_l2-this.clipped_l1)*n,this.unit_delta_weight,this.inv_weight_min,o),e.v=Yt.Poly6NF1D*this.f0f1f2.x,this.f0f1f2.y*=n,e.g.copy(this.increase_unit_dir).multiplyScalar(this.f0f1f2.z+this.clipped_l1*this.f0f1f2.y).sub(i.multiplyScalar(this.f0f1f2.y)).multiplyScalar(6*Yt.Poly6NF1D*Yt.KIS2*n)):this.unit_delta_weight>=.06?e.v=Yt.Poly6NF1D*this.HomotheticCompactPolynomial_segment_F_i6((this.clipped_l2-this.clipped_l1)*n,this.unit_delta_weight,o):e.v=Yt.Poly6NF1D*this.HomotheticCompactPolynomial_approx_segment_F_i6((this.clipped_l2-this.clipped_l1)*n,this.unit_delta_weight,n,o),e.m&&this.evalMat(t,e)}},re.prototype.clamp=function(t,e,i){return Math.max(e,Math.min(i,t))},re.prototype.distanceTo=(ie=new Ut.Vector3,se=new Ut.Vector3,function(t){var e=ie.subVectors(t,this.v[0].getPos()).dot(this.dir)/this.lengthSq;return e=this.clamp(e,0,1),se.copy(this.dir).multiplyScalar(e).add(this.v[0].getPos()),t.distanceTo(se)}),re.prototype.HomotheticCompactPolynomial_segment_F_i6=function(t,e,i){var s=e*t+1,r=1/s,o=s*s,n=1/(o*o),h=i.y,a=h*h,c=12*a,p=1/e,l=h*p,u=s*o,v=t*t,m=v*v,g=t*v,_=t*m,y=i.x,d=i.z,f=y*y,b=d*d,w=1/(u*u),x=r*n,V=1/u,S=1/o;return-b*(((((-(r-1)*p-t*S)*p-v*V)*p-g*n)*p-m*x)*p-_*w)*l+(-y*(w-1)*p/6-(-(x-1)*p/5-t*w)*l)*f+((y*c+3*d*f)*(.4*(-(n-1)*p/4-t*x)*p-v*w)+(3*b*y+d*c)*(.8*(3/4*(2/3*(-(S-1)*p/2-t*V)*p-v*n)*p-g*x)*p-m*w)+d*b*(1.2*(5/4*(4/3*(1.5*(2*(Math.log(s)*p-t*r)*p-v*S)*p-g*V)*p-m*n)*p-_*x)*p-g*g*w)+(-12*d*y-8*a)*(.6*((-(V-1)*p/3-t*n)*p/2-v*x)*p-g*w)*h)*p/6},re.prototype.HomotheticCompactPolynomial_approx_segment_F_i6=function(t,e,i,s){var r=i*e,o=r+1,n=1/o,h=o*o,a=n/(h*h)/h,c=s.z,p=s.y,l=s.x,u=t*t,v=c*u-2*p*t+l,m=c*l-p*p,g=c*t-p,_=l*l,y=p*_,d=v*v,f=g*d,b=1/c,w=m*b,x=6/35*(4/3*(2*m*t+g*v+p*l)*w+f+y)*w+v*f/7+l*y/7,V=b*x,S=n*a,A=d*d,M=p*V+A/8-_*_/8,T=-t*A+(-10*p*M+l*x)*b;return V-7*e*M*b+(-.1111111111*(3*a-3+7*(2+S)*r)*T-.1*(2-2*a-7*(1+S)*r)/i*(-1*u*A+(1.333333333*p*T+2*l*M)*b))*b/(i*i)},re.prototype.HomotheticCompactPolynomial_segment_FGradF_i6=function(t,e,i){var s=e*t+1,r=1/s,o=s*s,n=1/(o*o),h=i.y,a=h*h,c=2*a,p=i.z,l=i.x,u=p*l/3+2/3*a,v=p*p,m=v/6,g=-2/3*p,_=s*o,y=1/_,d=r*n,f=1/(_*_),b=t*t,w=1/e,x=t*b,V=.6*((-(y-1)*w/3-t*n)*w/2-b*d)*w-x*f,S=V*h,A=-(d-1)*w/5-t*f,M=l*l,T=M*A,P=.4*(-(n-1)*w/4-t*d)*w-b*f,B=l*P,N=-M*(f-1)/6,F=b*b,k=t*F,D=1/o,z=.8*(3/4*(2/3*(-(D-1)*w/2-t*y)*w-b*n)*w-x*d)*w-F*f,O=((((-(r-1)*w-t*D)*w-b*y)*w-x*n)*w-F*d)*w-k*f,E=x*x,R=Math.log(s);this.f0f1f2.x=(l*N-h*T+B*c-4/3*a*S+(M*P/2+z*c-2*l*S)*p+(l*z/2-h*O+(-E*f/6+(-k*d/5+(-F*n/4+(-x*y/3+(-b*D/2+(R*w-t*r)*w)*w)*w)*w)*w)*p)*v)*w,this.f0f1f2.y=(N+P*u+z*m+(-2/3*l*A+V*g)*h)*w,this.f0f1f2.z=(T/6+V*u+O*m+(-2/3*B+z*g)*h)*w},re.prototype.HomotheticCompactPolynomial_approx_segment_FGradF_i6=function(t,e,i,s){var r=i*e,o=r+1,n=1/o,h=1/(i*i),a=o*o,c=n/(a*a)/a,p=s.x,l=2*p,u=s.z,v=1/u,m=e*v,g=s.y,_=t*t,y=u*_-2*g*t+p,d=y*y,f=y*d,b=p*p,w=p*b,x=u*p-g*g,V=u*t-g,S=x*v,A=4/3*(2*x*t+V*y+g*p)*S+V*d+g*b,M=A/5,T=g*v*M+f/6-w/6,P=-t*f+(-8*g*T+p*M)*v,B=_*f,N=(10/7*g*P+T*l)*v-B,F=-N/8,k=6/35*A*S+V*f/7+g*w/7,D=n*c,z=(3*c-3+7*(2+D)*r)*h,O=(2-2*c-7*(1+D)*r)/i*h,E=v*z,R=v*O,j=v*k,q=d*d,C=g*j+q/8-b*b/8,I=-t*q+(-10*g*C+p*k)*v;this.f0f1f2.x=j-7*C*m-I*E/9-(-_*q+(4/3*g*I+C*l)*v)*R/10,this.f0f1f2.y=(M-7*e*T-P*z/7+O*F)*v,this.f0f1f2.z=T*v+P*m+E*F-(-t*B+(1.5*g*N-3/7*p*P)*v)*R/9};var oe=re;const ne=o.default;var he=1e-6,ae={},ce=function(t,e){var i=t;if(0===e)throw"Lenght of the array should not be null";return 1===e?0:(t<0&&(i=(e+t)%e),t>=e&&(i=t%e),i)};ae.computeVectorsDirs=function(t){var e=t.v[0].getPos(),i=t.v[1].getPos(),s=t.v[2].getPos();t.p0p1.subVectors(i,e),t.p1p2.subVectors(s,i),t.p2p0.subVectors(e,s),t.unit_normal.crossVectors(t.p0p1,t.p2p0),t.unit_normal.normalize(),t.length_p0p1=t.p0p1.length(),t.unit_p0p1.copy(t.p0p1),t.unit_p0p1.divideScalar(t.length_p0p1),t.diffThick_p0p1=t.v[0].getThickness()-t.v[1].getThickness(),t.length_p1p2=t.p1p2.length(),t.unit_p1p2.copy(t.p1p2),t.unit_p1p2.divideScalar(t.length_p1p2),t.diffThick_p1p2=t.v[1].getThickness()-t.v[2].getThickness(),t.length_p2p0=t.p2p0.length(),t.unit_p2p0.copy(t.p2p0),t.unit_p2p0.divideScalar(t.length_p2p0),t.diffThick_p2p0=t.v[2].getThickness()-t.v[0].getThickness();var r=[];r.push({vert:t.v[0].getPos(),thick:t.v[0].getThickness(),idx:0}),r.push({vert:t.v[1].getPos(),thick:t.v[1].getThickness(),idx:1}),r.push({vert:t.v[2].getPos(),thick:t.v[2].getThickness(),idx:2}),r.sort((function(t,e){return t.thick-e.thick})),t.point_min=r[0].vert,t.weight_min=r[0].thick;var o=ce(r[0].idx+1,3),n=t.v[o].getPos(),h=t.v[o].getThickness();o=ce(r[0].idx+2,3);var a=t.v[o].getPos(),c=t.v[o].getThickness(),p=new ne.Vector3;p=p.subVectors(n,t.point_min);var l=new ne.Vector3;l=l.subVectors(a,t.point_min);var u=h-t.weight_min,v=c-t.weight_min;if(u<he||v<he){if(u<v){t.ortho_dir=p.clone(),t.ortho_dir.normalize(),t.main_dir.crossVectors(t.ortho_dir,t.unit_normal),t.main_dir.normalize(),t.main_dir.dot(l)<0&&t.main_dir.multiplyScalar(-1);var m=-t.weight_min/v;t.point_iso_zero=new ne.Vector3(t.point_min.x+m*l.x,t.point_min.y+m*l.y,t.point_min.z+m*l.z)}else{t.ortho_dir=l.clone(),t.ortho_dir.normalize(),t.main_dir.crossVectors(t.ortho_dir,t.unit_normal),t.main_dir.normalize(),t.main_dir.dot(p)<0&&t.main_dir.multiplyScalar(-1);m=-t.weight_min/u;t.point_iso_zero=new ne.Vector3(t.point_min.x+m*p.x,t.point_min.y+m*p.y,t.point_min.z+m*p.z)}Math.abs(u-v)<he&&(t.proj_dir=t.unit_normal.clone().multiplyScalar(-1),t.equal_weights=!0)}else{var g=-t.weight_min/u,_=new ne.Vector3(t.point_min.x+g*p.x,t.point_min.y+g*p.y,t.point_min.z+g*p.z);t.point_iso_zero=_;var y=-t.weight_min/v,d=new ne.Vector3(t.point_min.x+y*l.x,t.point_min.y+y*l.y,t.point_min.z+y*l.z);t.ortho_dir.subVectors(d,_),t.ortho_dir.normalize(),t.main_dir.crossVectors(t.ortho_dir,t.unit_normal),t.main_dir.normalize(),(t.main_dir.dot(p)<0||t.main_dir.dot(l)<0)&&t.main_dir.multiplyScalar(-1)}var f=p.dot(t.main_dir),b=l.dot(t.main_dir),w=null;(f=f<0?0:f)>(b=b<0?0:b)?(w=p,t.half_dir_1=l,t.point_half=a,t.half_dir_2=n.clone().subVectors(n,a),t.coord_max=f,t.coord_middle=b/f*t.coord_max,t.unit_delta_weight=u/t.coord_max):(w=l,t.half_dir_1=p,t.point_half=n,t.half_dir_2=a.clone().subVectors(a,n),t.coord_max=b,t.coord_middle=f/b*t.coord_max,t.unit_delta_weight=v/t.coord_max),t.longest_dir_special=w.divideScalar(t.coord_max);var x=new ne.Vector3;x.subVectors(t.half_dir_1,t.longest_dir_special.clone().multiplyScalar(t.coord_middle)),t.max_seg_length=x.length(),t.unsigned_ortho_dir=t.ortho_dir.clone(),t.ortho_dir.dot(x)<0&&t.ortho_dir.multiplyScalar(-1)},ae.getParametrisedVertexAttr=function(t,e,i){var s=ae.getMeanThick(t,e,i),r=new ne.Vector3,o=r.subVectors(t.v[1].getPos(),t.v[0].getPos()).multiplyScalar(e),n=r.clone().subVectors(t.v[2].getPos(),t.v[0].getPos()).multiplyScalar(i);return r.addVectors(t.v[0].getPos(),o),r.addVectors(r,n),{pos:r,thick:s}},ae.getMeanThick=function(t,e,i){return t.v[0].getThickness()*(1-e-i)+t.v[1].getThickness()*e+t.v[2].getThickness()*i},ae.getMeanMat=function(t,e,i){var s=new Material,r=null===t.materials?[t.v[0].getMaterial(),t.v[0].getMaterial(),t.v[0].getMaterial()]:[t.materials[0],t.materials[1],t.materials[2]];return s.weightedMean(r,[1-e-i,e,i]),s},ae.getTriBaryCoord=function(t,e,i,s){var r=t,o=e.clone().multiplyScalar(-1),n=(new ne.Vector3).subVectors(s,i),h=r.lengthSq(),a=r.dot(o),c=n.dot(r),p=o.lengthSq(),l=(h*n.dot(o)-a*c)/(h*p-a*a);return{u:(c-l*a)/h,v:l}},ae.getUVCoord=function(t,e,i,s){var r=new ne.Vector3;r.crossVectors(t,e);var o=new ne.Matrix4;o.set(t.x,e.x,r.x,0,t.y,e.y,r.y,0,t.z,e.z,r.z,0,0,0,0,1);var n=new ne.Matrix4;n.copy(o).invert();var h=(new ne.Vector3).subVectors(s,i);return h.applyMatrix4(n),{u:h.x,v:h.y}};var pe=ae;const le=o.default,ue=ut,ve=Vt,me=pe,ge=At,_e=Lt;var ye=function(t,e,i,s,r,o){ve.call(this),this.tmpVect=new le.Vector3,this.min_thick=r,this.max_thick=o,this.v=t,this.p0p1=this.tmpVect.clone().subVectors(this.v[1].getPos(),this.v[0].getPos()),this.p2p0=this.tmpVect.clone().subVectors(this.v[0].getPos(),this.v[2].getPos()),this.unit_normal=e,this.main_dir=i;var n=Math.abs(this.v[0].getThickness()-this.v[1].getThickness()),h=Math.abs(this.v[1].getThickness()-this.v[2].getThickness());this.equal_weights=n/Math.abs(this.v[0].getThickness()+this.v[1].getThickness())<.001&&h/Math.abs(this.v[1].getThickness()+this.v[2].getThickness())<.001,this.segParams=s,this.segAttr={p0_to_p:0,p0_to_p_sqrnorm:0,x_p_2D:0,y_p_2D:0,y_p_2DSq:0,p_proj_x:0};var a=this.tmpVect.clone().crossVectors(this.segParams[0].dir,this.unit_normal).normalize(),c=this.tmpVect.clone().crossVectors(this.segParams[1].dir,this.unit_normal).normalize(),p=this.tmpVect.clone().crossVectors(this.segParams[2].dir,this.unit_normal).normalize();this.tmpVect.copy(this.unit_normal);var l=[];l.push(this.tmpVect.clone().addVectors(this.v[0].getPos(),this.tmpVect.multiplyScalar(this.v[0].getThickness()*ue.KS))),this.tmpVect.copy(this.unit_normal),l.push(this.tmpVect.clone().addVectors(this.v[1].getPos(),this.tmpVect.multiplyScalar(this.v[1].getThickness()*ue.KS))),this.tmpVect.copy(this.unit_normal),l.push(this.tmpVect.clone().addVectors(this.v[2].getPos(),this.tmpVect.multiplyScalar(this.v[2].getThickness()*ue.KS))),this.tmpVect.copy(this.unit_normal),l.push(this.tmpVect.clone().addVectors(this.v[0].getPos(),this.tmpVect.multiplyScalar(-this.v[0].getThickness()*ue.KS))),this.tmpVect.copy(this.unit_normal),l.push(this.tmpVect.clone().addVectors(this.v[1].getPos(),this.tmpVect.multiplyScalar(-this.v[1].getThickness()*ue.KS))),this.tmpVect.copy(this.unit_normal),l.push(this.tmpVect.clone().addVectors(this.v[2].getPos(),this.tmpVect.multiplyScalar(-this.v[2].getThickness()*ue.KS)));var u=new le.Vector3;this.tmpVect.subVectors(l[1],l[0]),u.subVectors(l[2],l[0]);var v=this.tmpVect.clone().crossVectors(this.tmpVect,u).normalize();this.tmpVect.subVectors(l[5],l[3]),u.subVectors(l[4],l[3]);var m=this.tmpVect.clone().crossVectors(this.tmpVect,u).normalize();this.planeParams=[],this.planeParams.push({orig:this.v[0].getPos(),n:a}),this.planeParams.push({orig:this.v[1].getPos(),n:c}),this.planeParams.push({orig:this.v[2].getPos(),n:p}),this.planeParams.push({orig:l[0],n:v}),this.planeParams.push({orig:l[3],n:m}),this.segAreas=[];for(var g=0;g<3;++g)this.segAreas.push(new _e(this.segParams[g].v[0].getPos(),this.segParams[g].v[1].getPos(),this.segParams[g].v[0].getThickness(),this.segParams[g].v[1].getThickness(),this.segParams[g].norm,this.segParams[g].dir))};(ye.prototype=Object.create(ve.prototype)).constructor=ye,ye.prototype.proj_computation=function(t,e){this.segAttr.p0_to_p=this.tmpVect,this.segAttr.p0_to_p.subVectors(t,e.v[0].getPos()),this.segAttr.p0_to_p_sqrnorm=this.segAttr.p0_to_p.lengthSq(),this.segAttr.x_p_2D=this.segAttr.p0_to_p.dot(e.dir),this.segAttr.y_p_2DSq=this.segAttr.p0_to_p_sqrnorm-this.segAttr.x_p_2D*this.segAttr.x_p_2D,this.segAttr.y_p_2D=this.segAttr.y_p_2DSq>0?Math.sqrt(this.segAttr.y_p_2DSq):0;var i=-this.segAttr.y_p_2D/e.ortho_vec_y;this.segAttr.p_proj_x=this.segAttr.x_p_2D+i*e.ortho_vec_x},ye.prototype.sphereIntersect=function(t){for(var e=0;e<3;e++){if(this.sphereIntersectSegment(t,this.segParams[e],ue.KS))return!0}e=0;for(var i=!0;e<5;e++){this.tmpVect.subVectors(t.center,this.planeParams[e].orig);var s=this.tmpVect.dot(this.planeParams[e].n);i=i&&s+t.r>0}return i},ye.prototype.sphereIntersectSegment=function(t,e,i){this.proj_computation(t.center,e);var s=e.v[0].getThickness(),r=e.v[1].getThickness();if(this.segAttr.p_proj_x<0)return Math.sqrt(this.segAttr.p0_to_p_sqrnorm)-t.r<s*i;if(this.segAttr.p_proj_x>e.norm)return this.segAttr.p0_to_p.subVectors(t.center,e.v[1].getPos()),this.segAttr.p0_to_p.length()-t.r<r*i;var o=this.segAttr.x_p_2D-this.segAttr.p_proj_x,n=o*o+this.segAttr.y_p_2DSq,h=this.segAttr.p_proj_x/e.norm,a=s*(1-h)+h*r,c=t.r+a*i;return n<c*c},ye.prototype.contains=function(t){var e={r:0,c:t};return this.sphereIntersect(e)},ye.prototype.getAccSegment=function(t,e){var i={intersect:!1,currAcc:ge.nice*this.min_thick};if(this.sphereIntersectSegment(t,e,1)){var s=Math.abs(e.diffThick)/e.norm,r=t.r*Math.sqrt(1+s*s)*.5,o=e.v[0].getThickness(),n=e.v[1].getThickness(),h=this.segAttr.p_proj_x;if((h+=o>n?r:-r)<=0)i.currAcc=o;else if(h>=e.norm)i.currAcc=n;else{var a=h/e.norm;i.currAcc=o*(1-a)+a*n}i.intersect=!0}return i},ye.prototype.getAccTri=function(t){if(this.equal_weights)return this.min_thick;var e=this.v[0].getPos(),i=this.tmpVect.addVectors(t.center,this.main_dir.clone().multiplyScalar(t.r));this.tmpVect.subVectors(i,e);var s=this.tmpVect.lengthSq(),r=this.tmpVect.dot(this.unit_normal),o=Math.sqrt(s-r*r),n=this.tmpVect.clone().addVectors(t.center,this.unit_normal.clone().multiplyScalar(-r)),h=me.getTriBaryCoord(this.p0p1,this.p2p0,this.v[0].getPos(),n),a=me.getMeanThick(this,h.u,h.v);a=r>=0?a:-a;var c=o+-r/o*(this.v[0].getThickness()-a),p=this.tmpVect.subVectors(e,n).normalize(),l=this.tmpVect.addVectors(n,p.multiplyScalar(o-c));return(h=me.getTriBaryCoord(this.p0p1,this.p2p0,this.v[0].getPos(),l)).u<=1&&h.v<=1&&h.u+h.v<=1&&h.u>=0&&h.v>=0?me.getMeanThick(this,h.u,h.v):1e4*this.max_thick},ye.prototype.getAcc=function(t,e){for(var i=0,s=1e5*this.max_thick;i<3;i++){var r=this.getAccSegment(t,this.segParams[i]);r.intersect&&(s=s>r.currAcc?r.currAcc:s)}var o=1e5*this.max_thick;s!==this.min_thick&&(o=this.getAccTri(t));var n=Math.min(s,o);return n!==1e5*this.max_thick?n*e:this.max_thick*e},ye.prototype.getNiceAcc=function(t){return this.getAcc(t,ge.nice)},ye.prototype.getCurrAcc=function(t){return this.getAcc(t,ge.curr)},ye.prototype.getRawAcc=function(t){return this.getAcc(t,ge.raw)},ye.prototype.getMinAcc=function(){return ge.curr*this.min_thick},ye.prototype.getMinRawAcc=function(){return ge.raw*this.min_thick},ye.prototype.getAxisProjectionMinStep=function(t,e){for(var i=Number.MAX_VALUE,s=0;s<3;++s)i=Math.min(i,this.segAreas[s].getAxisProjectionMinStep(t,e));return i};var de=ye;const fe=o.default,be=l,we=P,xe=_t,Ve=wt,Se=ut,Ae=de,Me=pe;var Te,Pe,Be,Ne,Fe,ke,De=function(t,e,i,s){if(xe.call(this),1!==i)throw"Error in ScalisTriangle : cannot use a density different from 1.0, not implemented.";this.volType=e,this.materials=null!==s?s:[we.defaultMaterial.clone(),we.defaultMaterial.clone(),we.defaultMaterial.clone()],this.v=t,this.v[0].setPrimitive(this),this.v[1].setPrimitive(this),this.v[2].setPrimitive(this),this.min_thick=Math.min(this.v[0].getThickness(),this.v[1].getThickness(),this.v[2].getThickness()),this.max_thick=Math.max(this.v[0].getThickness(),this.v[1].getThickness(),this.v[2].getThickness()),this.res_gseg={},this.tmp_res_gseg={},this.p0p1=new fe.Vector3,this.p1p2=new fe.Vector3,this.p2p0=new fe.Vector3,this.unit_normal=new fe.Vector3,this.unit_p0p1=new fe.Vector3,this.unit_p1p2=new fe.Vector3,this.unit_p2p0=new fe.Vector3,this.length_p0p1=0,this.length_p1p2=0,this.length_p2p0=0,this.diffThick_p0p1=0,this.diffThick_p0p1=0,this.diffThick_p0p1=0,this.main_dir=new fe.Vector3,this.point_iso_zero=new fe.Vector3,this.ortho_dir=new fe.Vector3,this.unsigned_ortho_dir=new fe.Vector3,this.proj_dir=new fe.Vector3,this.equal_weights=!1,this.coord_max=0,this.coord_middle=0,this.unit_delta_weight=0,this.longest_dir_special=0,this.max_seg_length=0,this.half_dir_1=new fe.Vector3,this.point_half=new fe.Vector3,this.half_dir_2=new fe.Vector3,this.point_min=new fe.Vector3,this.weight_min=0,this.valid_aabb=!1};(De.prototype=Object.create(xe.prototype)).constructor=De,De.type="ScalisTriangle",be.register(De.type,De),De.prototype.getType=function(){return De.type},De.prototype.toJSON=function(){return xe.prototype.toJSON.call(this)},De.fromJSON=function(t){var e=[Ve.fromJSON(t.v[0]),Ve.fromJSON(t.v[1]),Ve.fromJSON(t.v[2])],i=[we.fromJSON(t.materials[0]),we.fromJSON(t.materials[1]),we.fromJSON(t.materials[2])];return new De(e,t.volType,1,i)},De.prototype.prepareForEval=function(){this.valid_aabb||(this.computeHelpVariables(),this.valid_aabb=!0)},De.prototype.getAreas=function(){if(this.valid_aabb){var t=[];return t.push({norm:this.length_p0p1,diffThick:this.diffThick_p0p1,dir:this.unit_p0p1,v:[this.v[0],this.v[1]],ortho_vec_x:this.v[0].getThickness()-this.v[1].getThickness(),ortho_vec_y:this.length_p0p1}),t.push({norm:this.length_p1p2,diffThick:this.diffThick_p1p2,dir:this.unit_p1p2,v:[this.v[1],this.v[2]],ortho_vec_x:this.v[1].getThickness()-this.v[2].getThickness(),ortho_vec_y:this.length_p1p2}),t.push({norm:this.length_p2p0,diffThick:this.diffThick_p2p0,dir:this.unit_p2p0,v:[this.v[2],this.v[0]],ortho_vec_x:this.v[2].getThickness()-this.v[0].getThickness(),ortho_vec_y:this.length_p2p0}),[{aabb:this.aabb,bv:new Ae(this.v,this.unit_normal,this.main_dir,t,this.min_thick,this.max_thick),obj:this}]}return console.log("ERROR : Cannot get area of invalid primitive"),[]},De.prototype.computeHelpVariables=function(){Me.computeVectorsDirs(this),this.computeAABB()},De.prototype.mutableVolType=function(){return!0},De.prototype.setVolType=function(t){if(t!=xe.CONVOL&&t!=xe.DIST)throw"ERROR : volType must be set to ScalisPrimitive.CONVOL or ScalisPrimitive.DIST";this.volType!=t&&(this.volType=t,this.invalidAABB())},De.prototype.getVolType=function(){return this.volType},De.prototype.clamp=function(t,e,i){return Math.max(e,Math.min(i,t))},De.prototype.distanceTo=function(){var t=new fe.Vector3,e=new fe.Vector3,i=new fe.Vector3,s=new fe.Vector3;return function(r){if(t.subVectors(r,this.v[0].getPos()),e.subVectors(r,this.v[1].getPos()),i.subVectors(r,this.v[2].getPos()),s.crossVectors(this.p0p1,t).dot(this.unit_normal)>0&&s.crossVectors(this.p1p2,e).dot(this.unit_normal)>0&&s.crossVectors(this.p2p0,i).dot(this.unit_normal)>0)return Math.abs(t.dot(this.unit_normal));var o=t.dot(this.p0p1)/this.length_p0p1;o=this.clamp(o,0,1),s.copy(this.p0p1).multiplyScalar(o).add(this.v[0].getPos()),o=r.distanceToSquared(s);var n=e.dot(this.p1p2)/this.length_p1p2;n=this.clamp(n,0,1),s.copy(this.p1p2).multiplyScalar(n).add(this.v[1].getPos()),n=r.distanceToSquared(s);var h=i.dot(this.p2p0)/this.length_p2p0;return h=this.clamp(h,0,1),s.copy(this.p2p0).multiplyScalar(h).add(this.v[2].getPos()),h=r.distanceToSquared(s),Math.sqrt(Math.min(Math.min(o,n),h))}}(),De.prototype.heuristicStepWithin=function(){return this.weight_min/3},De.prototype.value=function(t,e){switch(this.volType){case xe.DIST:return this.evalDist(t,e);case xe.CONVOL:return this.evalConvol(t,e);default:throw"Unknown volType, use Orga"}},De.prototype.evalDist=function(){var t={v:0},e=new fe.Vector3;return function(i,s){var r=new fe.Vector3;r.subVectors(i,this.v[0].getPos());var o=this.unit_normal.clone().multiplyScalar(-1);if(!this.equal_weights){var n=o,h=this.unsigned_ortho_dir,a=this.main_dir.clone().multiplyScalar(-1),c=-this.v[0].getPos().dot(n),p=-i.dot(h),l=-this.point_iso_zero.dot(a),u=new fe.Vector3;u.crossVectors(h,a),u.multiplyScalar(-c);var v=new fe.Vector3;v.crossVectors(a,n),v.multiplyScalar(-p);var m=new fe.Vector3;m.crossVectors(n,h),m.multiplyScalar(-l);var g=new fe.Vector3;g.crossVectors(h,a);var _=new fe.Vector3(u.x+v.x+m.x,u.y+v.y+m.y,u.z+v.z+m.z);_.divideScalar(n.dot(g));var y=new fe.Vector3(_.x-i.x,_.y-i.y,_.z-i.z);this.proj_dir=new fe.Vector3,this.proj_dir.crossVectors(y,this.unsigned_ortho_dir),this.proj_dir.normalize()}var d=new fe.Vector3;d.copy(this.proj_dir),d.multiplyScalar(-r.dot(o)/this.proj_dir.dot(o)),d.add(i);var f=new fe.Vector3,b=new fe.Vector3,w=new fe.Vector3,x=new fe.Vector3;if(b.subVectors(d,this.v[0].getPos()),w.subVectors(d,this.v[1].getPos()),x.subVectors(d,this.v[2].getPos()),f.crossVectors(this.unit_p0p1,b).dot(o)>0&&f.crossVectors(this.unit_p1p2,w).dot(o)>0&&f.crossVectors(this.unit_p2p0,x).dot(o)>0){f.subVectors(i,d),s.v=f.lengthSq();var V=this.v[0].getPos(),S=this.v[1].getPos(),A=this.v[2].getPos(),M=new fe.Vector3;f.subVectors(S,V),M.subVectors(A,V);var T=new fe.Vector3;T.crossVectors(f,M),f.subVectors(A,S),(n=new fe.Vector3).crossVectors(f,w),f.subVectors(V,A),(h=new fe.Vector3).crossVectors(f,x),f.subVectors(S,V),(a=new fe.Vector3).crossVectors(f,b);var P=T.lengthSq(),B=T.dot(n),N=T.dot(h),F=T.dot(a),k=(B*this.v[0].getThickness()+N*this.v[1].getThickness()+F*this.v[2].getThickness())/P;s.v=Se.Poly6Eval(Math.sqrt(s.v)/k)*Se.Poly6NF0D,s.m&&s.m.triMean(this.materials[0],this.materials[1],this.materials[2],B,N,F,P)}else{var D=0;if(this.GenericSegmentComputation(i,this.v[0].getPos(),this.p0p1,this.length_p0p1,this.length_p0p1*this.length_p0p1,this.v[0].getThickness(),this.v[1].getThickness()-this.v[0].getThickness(),this.res_gseg),this.res_gseg.sqrdist=this.res_gseg.proj_to_p.lengthSq(),this.res_gseg.ratio=this.res_gseg.sqrdist/(this.res_gseg.weight_proj*this.res_gseg.weight_proj),this.GenericSegmentComputation(i,this.v[1].getPos(),this.p1p2,this.length_p1p2,this.length_p1p2*this.length_p1p2,this.v[1].getThickness(),this.v[2].getThickness()-this.v[1].getThickness(),this.tmp_res_gseg),this.tmp_res_gseg.sqrdist=this.tmp_res_gseg.proj_to_p.lengthSq(),this.tmp_res_gseg.ratio=this.tmp_res_gseg.sqrdist/(this.tmp_res_gseg.weight_proj*this.tmp_res_gseg.weight_proj),this.res_gseg.ratio>this.tmp_res_gseg.ratio&&(this.res_gseg.sqrdist=this.tmp_res_gseg.sqrdist,this.res_gseg.proj_to_p=this.tmp_res_gseg.proj_to_p,this.res_gseg.weight_proj=this.tmp_res_gseg.weight_proj,this.res_gseg.ratio=this.tmp_res_gseg.ratio,this.res_gseg.t=this.tmp_res_gseg.t,D=1),this.GenericSegmentComputation(i,this.v[2].getPos(),this.p2p0,this.length_p2p0,this.length_p2p0*this.length_p2p0,this.v[2].getThickness(),this.v[0].getThickness()-this.v[2].getThickness(),this.tmp_res_gseg),this.tmp_res_gseg.sqrdist=this.tmp_res_gseg.proj_to_p.lengthSq(),this.tmp_res_gseg.ratio=this.tmp_res_gseg.sqrdist/(this.tmp_res_gseg.weight_proj*this.tmp_res_gseg.weight_proj),this.res_gseg.ratio>this.tmp_res_gseg.ratio&&(this.res_gseg.sqrdist=this.tmp_res_gseg.sqrdist,this.res_gseg.proj_to_p=this.tmp_res_gseg.proj_to_p,this.res_gseg.weight_proj=this.tmp_res_gseg.weight_proj,this.res_gseg.ratio=this.tmp_res_gseg.ratio,this.res_gseg.t=this.tmp_res_gseg.t,D=2),s.v=Se.Poly6Eval(Math.sqrt(this.res_gseg.sqrdist)/this.res_gseg.weight_proj)*Se.Poly6NF0D,s.m)switch(D){case 0:s.m.copy(this.materials[0]),s.m.lerp(this.materials[1],this.res_gseg.t);break;case 1:s.m.copy(this.materials[1]),s.m.lerp(this.materials[2],this.res_gseg.t);break;case 2:s.m.copy(this.materials[2]),s.m.lerp(this.materials[0],this.res_gseg.t);break;default:throw"Error : seg_case unknown"}}if(s.g){var z=1e-5;e.copy(i),e.x+=z,this.evalDist(e,t),s.g.x=(t.v-s.v)/z,e.x-=z,e.y+=z,this.evalDist(e,t),s.g.y=(t.v-s.v)/z,e.y-=z,e.z+=z,this.evalDist(e,t),s.g.z=(t.v-s.v)/z}}}(),De.prototype.GenericSegmentComputation=function(t,e,i,s,r,o,n,h){var a=new fe.Vector3;a.subVectors(t,e);var c=a.dot(i),p=a.lengthSq(),l=r*o+c*n,u=n<0?0:1;return l>0&&(u=(u=(c*o+p*n)/l)<0?0:u>1?1:u),h.proj_to_p=new fe.Vector3(u*i.x-a.x,u*i.y-a.y,u*i.z-a.z),h.weight_proj=o+u*n,h.t=u,h},De.prototype.evalConvol=(Te=new fe.Vector3,Pe=new we,Be={v:0,g:null,m:null},Ne=new fe.Vector3,Fe=new we,ke={v:0,g:null,m:null},function(t,e){Be.g=e.g?Te:null,Be.m=e.m?Pe:null;var i={l1:0,l2:0};if(this.ComputeTParam(t,i)){var s=i.l1,r=i.l2,o=this.weight_min+s*this.unit_delta_weight,n=this.warpAbscissa((r-s)/o),h=2*(5*n+1),a=n/h,c=a;a*=2;for(var p=0,l=new fe.Vector3,u=1;u<h;u+=2)this.computeLineIntegral(this.unwarpAbscissa(c)*o+s,t,Be),p+=Be.v,e.g&&l.addVectors(l,Be.g),c+=a;var v=0,m=new fe.Vector3;for(c=0,u=2;u<h;u+=2)c+=a,this.computeLineIntegral(this.unwarpAbscissa(c)*o+s,t,Be),e.g&&m.addVectors(m,Be.g),v+=Be.v;ke.g=e.g?Ne:null,ke.m=e.m?Fe:null;var g=this.computeLineIntegral(s,t,Be),_=this.computeLineIntegral(r,t,ke);e.v=g.v+4*p+2*v+g.v;var y=n/(3*h)*Se.Poly6NF2D;if(e.v*=y,e.g){var d=new fe.Vector3;d.addVectors(d,g.g),d.addVectors(d,l.multiplyScalar(4)),d.addVectors(d,m.multiplyScalar(2)),d.addVectors(d,_.g),e.g=d.multiplyScalar(y)}}else e.v=0,e.g=new fe.Vector3;e.m&&(Be.g=null,this.evalDist(t,Be),e.m.copy(Be.m))}),De.prototype.warpAbscissa=function(t){var e=t*this.unit_delta_weight,i=1/(e+2),s=e*i;return 2*t*i*(1+(s*=s)*(1/3+s*(.2+s*(1/7+s*(1/9+s*(1/11+s*(1/13)))))))},De.prototype.unwarpAbscissa=function(t){var e=t*this.unit_delta_weight;return t*(1+e*(.5+e*(1/6+e*(1/24+e*(1/120+1*e/720)))))},De.prototype.computeLineIntegral=function(t,e,i){var s=this.weight_min+t*this.unit_delta_weight,r=new fe.Vector3;r.addVectors(this.point_min,this.longest_dir_special.clone().multiplyScalar(t));var o=t<this.coord_middle?t/this.coord_middle*this.max_seg_length:(this.coord_max-t)/(this.coord_max-this.coord_middle)*this.max_seg_length;return i.g?this.consWeightEvalGradForSeg(r,s,this.ortho_dir,o,e,i):this.consWeightEvalForSeg(r,s,this.ortho_dir,o,e,i),i},De.prototype.homotheticClippingSpecial=function(t,e,i){var s=-t.z,r=-t.y,o=-t.x,n=r*r-s*o;if(n>=0){var h=r+Math.sqrt(n);if(h<0||e*h<o)return!1;var a=o/h;i.l1=a<0?0:a;var c=s*a;return i.l2=2*r<c+s*e?o/c:e,!0}return!1},De.prototype.consWeightEvalForSeg=function(t,e,i,s,r,o){var n=new fe.Vector3;n.subVectors(r,t);var h=i.dot(n),a=n.lengthSq(),c=new fe.Vector3;c.set(e*e-Se.KIS2*a,-Se.KIS2*h,-Se.KIS2);var p={l1:0,l2:0};if(this.homotheticClippingSpecial(c,s,p)){var l=1/e;c.x=1-Se.KIS2*(p.l1*(p.l1-2*h)+a)*l*l,c.y=-Se.KIS2*(h-p.l1)*l,o.v=this.homotheticCompactPolynomial_segment_F_i6_cste((p.l2-p.l1)*l,c)}else o=0;return o},De.prototype.consWeightEvalGradForSeg=function(t,e,i,s,r,o){var n=new fe.Vector3;n.subVectors(r,t);var h=i.dot(n),a=n.lengthSq(),c=new fe.Vector3;c.set(e*e-Se.KIS2*a,-Se.KIS2*h,-Se.KIS2);var p={l1:0,l2:0};if(this.homotheticClippingSpecial(c,s,p)){var l=1/e;c.x=1-Se.KIS2*(p.l1*(p.l1-2*h)+a)*l*l,c.y=-Se.KIS2*(h-p.l1)*l;var u=new fe.Vector3;this.homotheticCompactPolynomial_segment_FGradF_i6_cste((p.l2-p.l1)*l,c,u),o.v=u.x,u.y*=l;var v=i.clone();v.multiplyScalar(u.z+p.l1*u.y),n.multiplyScalar(-u.y),n.addVectors(n,v),o.g=n.multiplyScalar(6*Se.KIS2*l)}else o.v=0,o.g.set(0,0,0);return o},De.prototype.ComputeTParam=function(t,e){var i=new fe.Vector3;i.subVectors(t,this.point_min);var s=i.dot(this.main_dir),r=i.dot(this.unit_normal),o=s*s+r*r,n=new fe.Vector3;return n.set(this.weight_min*this.weight_min-Se.KIS2*o,-this.unit_delta_weight*this.weight_min-Se.KIS2*s,this.unit_delta_weight*this.unit_delta_weight-Se.KIS2),this.homotheticClippingSpecial(n,this.coord_max,e)},De.prototype.homotheticCompactPolynomial_segment_F_i6_cste=function(t,e){var i=e.z,s=i*t,r=e.y,o=e.x,n=i*o-r*r,h=1/i,a=n*h,c=o+(-2*r+s)*t,p=s-r,l=p*(c*c),u=r*(o*o);return(1.2*(4/3*(2*n*t+p*c+r*o)*a+l+u)*a+c*l+o*u)*h/7},De.prototype.homotheticCompactPolynomial_segment_FGradF_i6_cste=function(t,e,i){var s=e.z,r=s*t,o=e.y,n=e.x,h=s*n-o*o,a=1/s,c=h*a,p=n+(-2*o+r)*t,l=r-o,u=p*p,v=n*n,m=4/3*(2*h*t+l*p+o*n)*c+l*u+o*v,g=m*a/5,_=n*v,y=p*u;i.x=(1.2*m*c+l*y+o*_)*a/7,i.y=g,i.z=(o*g+y/6-_/6)*a};var ze=De;const Oe=l;var Ee=function(){};Ee.prototype.constructor=Ee,Ee.type="DistanceFunctor",Oe.register(Ee.type,Ee),Ee.prototype.getType=function(){return Ee.type},Ee.prototype.toJSON=function(){return{type:this.getType()}},Ee.prototype.fromJSON=function(t){return Oe.fromJSON(t)},Ee.prototype.value=function(t){throw"Error : not implemented. Must be reimplemented in children classes."},Ee.prototype.value=function(t){throw"Error : not implemented. Must be reimplemented in children classes."},Ee.prototype.numericalGradient=function(t,e){var i=e||1e-5;return(this.value(t+i)-this.value(t-i))/(2*i)},Ee.prototype.gradient=function(t){return this.numericalGradient(t,1e-5)},Ee.prototype.getSupport=function(t){return 1/0};var Re=Ee;const je=l,qe=Re;var Ce=function(t){this.scale=t||1};(Ce.prototype=Object.create(qe.prototype)).constructor=Ce,Ce.type="Poly6DistanceFunctor",je.register(Ce.type,Ce),Ce.prototype.getType=function(){return Ce.type},Ce.prototype.toJSON=function(){var t=Blobtree.DistanceFunctor.prototype.toJSON.call(this,c);return t.scale=this.scale,t},Ce.evalStandard=function(t){if(t<0)return 1;var e=1-t*t;return e>0?e*e*e:0},Ce.prototype.value=function(t){var e=t/(2*this.scale);return Ce.evalStandard(e+=.5)/Ce.evalStandard(.5)},Ce.prototype.gradient=function(t){var e=t/(2*this.scale)+.5,i=1-e*e;return i=-6/(2*this.scale)*e*i*i/Ce.evalStandard(.5)},Ce.prototype.getSupport=function(t){return this.scale};var Ie=Ce;const Je=x,Ke=l;var Ge=function(){Je.call(this),this.aabb.set(new THREE.Vector3(-1/0,-1/0,-1/0),new THREE.Vector3(1/0,1/0,1/0))};(Ge.prototype=Object.create(Je.prototype)).constructor=Ge,Ge.type="SDFNode",Ke.register(Ge.type,Ge),Ge.prototype.getType=function(){return Ge.type},Ge.prototype.computeAABB=function(){},Ge.prototype.computeDistanceAABB=function(t){throw"computeDistanceAABB is an abstract function of SDFNode. Please reimplement it in children classes."},Ge.prototype.getAreas=function(){throw"No Areas for SDFNode, except for the SDFRootNode."},Ge.prototype.distanceTo=function(t){throw"distanceTo should be reimplemented in every children classes of SDFNode."},Ge.prototype.heuristicStepWithin=function(){throw"heuristicStepWithin may not make sens for all SDFNode, except for the SDFRootNode."};var He=Ge;const Le=o.default,Ue=l,We=He,Ze=P;var $e=function(t,e,i){We.call(this),this.f=t,this.material=e?e.clone():new Ze,this.addChild(i),this.tmp_res={v:0,g:null},this.tmp_g=new Le.Vector3(0,0,0)};($e.prototype=Object.create(We.prototype)).constructor=$e,$e.type="SDFRootNode",Ue.register($e.type,$e),$e.prototype.getType=function(){return $e.type},$e.prototype.addChild=function(t){if(0!==this.children.length)throw"Error : SDFRootNode can have only one child.";We.prototype.addChild.call(this,t)},$e.prototype.toJSON=function(){var t=We.prototype.toJSON.call(this);return t.f=this.f.toJSON(),t},$e.fromJSON=function(t){var e=new $e(Ue.fromJSON(e.f),Ue.fromJSON(t.children[0]));return e},$e.prototype.prepareForEval=function(){if(!this.valid_aabb){this.aabb=new Le.Box3;for(var t=0;t<this.children.length;++t){var e=this.children[t];e.prepareForEval(),this.aabb.union(e.computeDistanceAABB(this.f.getSupport()))}this.valid_aabb=!0}},$e.prototype.getAreas=function(){if(this.valid_aabb)return this.children[0].getAreas(this.f.getSupport());throw"ERROR : Cannot get area of invalid node"},$e.prototype.value=function(t,e){var i=this.tmp_res;i.g=e.g?this.tmp_g:null,e.v=0,e.m&&e.m.copy(Ze.defaultMaterial),e.g||void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)?(this.children[0].value(t,i),e.v=this.f.value(i.v),e.g&&e.g.copy(i.g).multiplyScalar(this.f.gradient(e.v)),e.m&&e.m.copy(this.material)):void 0!==e.step&&(e.step=this.aabb.distanceToPoint(t)+.3)};var Xe=$e;const Ye=d,Qe=l;var ti,ei=function(){Ye.call(this),this.aabb.set(new THREE.Vector3(-1/0,-1/0,-1/0),new THREE.Vector3(1/0,1/0,1/0))};(ei.prototype=Object.create(Ye.prototype)).constructor=ei,ei.type="SDFPrimitive",Qe.register(ei.type,ei),ei.prototype.SDFPrimitive=function(){return ei.type},ei.prototype.computeAABB=function(){},ei.prototype.computeDistanceAABB=function(t){throw"computeDistanceAABB is an abstract function of SDFPrimitive. Please reimplement it in children classes."},ei.prototype.getAreas=function(){throw"No Areas for SDFPrimitive."},ei.prototype.distanceTo=(ti={v:0},function(t){return this.value(t,ti),ti.v}),ei.prototype.heuristicStepWithin=function(){throw"Not implemented"};var ii=ei;const si=o.default,ri=l,oi=ii,ni=Ft;var hi=function(t,e){oi.call(this),this.p=t.clone(),this.acc=e||1};(hi.prototype=Object.create(oi.prototype)).constructor=hi,hi.type="SDFPoint",ri.register(hi.type,hi),hi.prototype.getType=function(){return hi.type},hi.prototype.toJSON=function(){var t=oi.prototype.toJSON.call(this);return t.p={x:this.p.x,y:this.p.y,z:this.p.z},t.acc=this.acc,t},hi.fromJSON=function(t){return new hi(new si.Vector3(t.p.x,t.p.y,t.p.z),t.acc)},hi.prototype.setAccuracy=function(t){this.acc=t,this.invalidAABB()},hi.prototype.getAccuracy=function(){return this.acc},hi.prototype.setPosition=function(t){this.p.copy(t),this.invalidAABB()},hi.prototype.getPosition=function(){return this.p},hi.prototype.computeDistanceAABB=function(t){return new si.Box3(this.p.clone().add(new si.Vector3(-t,-t,-t)),this.p.clone().add(new si.Vector3(t,t,t)))},hi.prototype.prepareForEval=function(){this.valid_aabb||(this.valid_aabb=!0)},hi.prototype.getAreas=function(t){if(this.valid_aabb)return[{aabb:this.computeDistanceAABB(t),bv:new ni(this.p,t,this.acc),obj:this}];throw"ERROR : Cannot get area of invalid primitive"},hi.prototype.value=function(){var t=new si.Vector3;return function(e,i){if(!this.valid_aabb)throw"Error : PrepareForEval should have been called";t.subVectors(e,this.p);var s=t.length();i.v=s,i.g&&i.g.copy(t).multiplyScalar(1/s)}}();var ai=hi;const ci=o.default,pi=Vt,li=At;var ui=function(t,e,i,s,r,o){pi.call(this),this.p1=t.clone(),this.p2=e.clone(),this.r1=i,this.r2=s,this.accFactor1=r||1,this.accFactor2=o||1,this.unit_dir=(new ci.Vector3).subVectors(e,t),this.length=this.unit_dir.length(),this.unit_dir.normalize(),this.vector=new ci.Vector3,this.p1_to_p=this.vector,this.p1_to_p_sqrnorm=0,this.x_p_2D=0,this.y_p_2D=0,this.y_p_2DSq=0,this.ortho_vec_x=this.r1-this.r2,this.ortho_vec_y=this.length,this.p_proj_x=0,this.p_proj_y=0,this.abs_diff_thick=Math.abs(this.ortho_vec_x)};(ui.prototype=Object.create(pi.prototype)).constructor=ui,ui.prototype.proj_computation=function(t){this.p1_to_p=this.vector,this.p1_to_p.subVectors(t,this.p1),this.p1_to_p_sqrnorm=this.p1_to_p.lengthSq(),this.x_p_2D=this.p1_to_p.dot(this.unit_dir),this.y_p_2DSq=this.p1_to_p_sqrnorm-this.x_p_2D*this.x_p_2D,this.y_p_2D=this.y_p_2DSq>0?Math.sqrt(this.y_p_2DSq):0;var e=-this.y_p_2D/this.ortho_vec_y;this.p_proj_x=this.x_p_2D+e*this.ortho_vec_x,this.p_proj_y=0},ui.prototype.sphereIntersect=function(t){if(this.proj_computation(t.center),this.p_proj_x<0)return Math.sqrt(this.p1_to_p_sqrnorm)-t.radius<this.r1;if(this.p_proj_x>this.length)return this.vector.subVectors(t.center,this.p2),Math.sqrt(this.vector.lengthSq())-t.radius<this.r2;var e=this.x_p_2D-this.p_proj_x,i=e*e+this.y_p_2DSq,s=this.p_proj_x/this.length,r=this.r1*(1-s)+s*this.r2,o=t.radius+r;return i<o*o},ui.prototype.contains=function(t){if(this.proj_computation(t),this.p_proj_x<0)return this.p1_to_p_sqrnorm<this.r1*this.r1;if(this.p_proj_x>this.length)return this.vector.subVectors(t,this.p2),this.vector.lengthSq()<this.r2*this.r2;var e=this.x_p_2D-this.p_proj_x,i=this.y_p_2D-this.p_proj_y,s=e*e+i*i,r=this.p_proj_x/this.length,o=this.r1*(1-r)+r*this.r2;return s<o*o},ui.prototype.getAcc=function(t,e){this.proj_computation(t.center);var i=this.abs_diff_thick/this.length,s=t.radius*Math.sqrt(1+i*i)*.5,r=this.p_proj_x;if((r+=this.r1>this.r2?s:-s)<0)return this.r1*this.accFactor1*e;if(r>this.length)return this.r2*this.accFactor2*e;var o=r/this.length;return(this.r1*this.accFactor1*(1-o)+o*this.r2*this.accFactor2)*e},ui.prototype.getNiceAcc=function(t){return this.getAcc(t,li.nice)},ui.prototype.getCurrAcc=function(t){return this.getAcc(t,li.curr)},ui.prototype.getRawAcc=function(t){return this.getAcc(t,li.raw)},ui.prototype.getMinAcc=function(){return li.curr*Math.min(this.r1*this.accFactor1,this.r2*this.accFactor2)},ui.prototype.getMinRawAcc=function(){return li.raw*Math.min(this.r1*this.accFactor1,this.r2*this.accFactor2)},ui.prototype.getAxisProjectionMinStep=function(t,e){var i,s,r,o=Number.MAX_VALUE,n=this.p1[t]<this.p2[t]?this.p1:this.p2;n===this.p1?(i=this.p2,s=this.r1*this.accFactor1,r=this.r2*this.accFactor2):(i=this.p1,s=this.r2,r=this.r1*this.accFactor1);var h=e-n[t];h<-2*s?o=Math.min(o,Math.max(Math.abs(h+2*s),li.curr*s)):h<2*s&&(o=Math.min(o,li.curr*s)),(h=e-i[t])<-2*r?o=Math.min(o,Math.max(Math.abs(h+2*r),li.curr*r)):h<2*r&&(o=Math.min(o,li.curr*r));var a=e-n[t],c=i[t]-n[t];return a>0&&a<c&&0!==c&&(o=Math.min(o,li.curr*(s+a/c*(r-s)))),o};var vi=ui;const mi=o.default,gi=l,_i=ii,yi=vi;var di=function(t,e,i){_i.call(this),this.p1=t.clone(),this.p2=e.clone(),this.acc=i||1,this.l=new mi.Line3(this.p1,this.p2)};(di.prototype=Object.create(_i.prototype)).constructor=di,di.type="SDFSegment",gi.register(di.type,di),di.prototype.getType=function(){return di.type},di.prototype.toJSON=function(){var t=_i.prototype.toJSON.call(this);return t.p1={x:this.p1.x,y:this.p1.y,z:this.p1.z},t.p2={x:this.p2.x,y:this.p2.y,z:this.p2.z},t.acc=this.acc,t},di.fromJSON=function(t){return ScalisVertex.fromJSON(t.v[0]),new di(new mi.Vector3(t.p1.x,t.p1.y,t.p1.z),new mi.Vector3(t.p2.x,t.p2.y,t.p2.z),t.acc)},di.prototype.setAccuracy=function(t){this.acc=t,this.invalidAABB()},di.prototype.getAccuracy=function(){return this.acc},di.prototype.setPosition1=function(t){this.p1.copy(t),this.invalidAABB()},di.prototype.setPosition2=function(t){this.p2.copy(t),this.invalidAABB()},di.prototype.getPosition1=function(){return this.p1},di.prototype.getPosition2=function(){return this.p2},di.prototype.computeDistanceAABB=function(t){var e=new mi.Box3(this.p1.clone().add(new mi.Vector3(-t,-t,-t)),this.p1.clone().add(new mi.Vector3(t,t,t))),i=new mi.Box3(this.p2.clone().add(new mi.Vector3(-t,-t,-t)),this.p2.clone().add(new mi.Vector3(t,t,t)));return e.union(i)},di.prototype.prepareForEval=function(){this.valid_aabb||(this.l.set(this.p1,this.p2),this.valid_aabb=!0)},di.prototype.getAreas=function(t){if(this.valid_aabb)return[{aabb:this.computeDistanceAABB(t),bv:new yi(this.p1,this.p2,t,t,this.acc,this.acc),obj:this}];throw"ERROR : Cannot get area of invalid primitive"},di.prototype.value=function(){var t=new mi.Vector3,e=new mi.Vector3;return function(i,s){this.l.closestPointToPoint(i,!0,t),s.v=e.subVectors(i,t).length(),s.g&&s.g.copy(e).divideScalar(s.v)}}();var fi=di;const bi=o.default,wi=l,xi=ii,Vi=Ft;var Si=function(t,e){xi.call(this),this.p=t.clone(),this.r=e};(Si.prototype=Object.create(xi.prototype)).constructor=Si,Si.type="SDFSphere",wi.register(Si.type,Si),Si.prototype.getType=function(){return Si.type},Si.prototype.toJSON=function(){var t=xi.prototype.toJSON.call(this);return t.p={x:this.p.x,y:this.p.y,z:this.p.z},t.r=this.r,t},Si.fromJSON=function(t){return new Si(new bi.Vector3(t.p.x,t.p.y,t.p.z),t.r)},Si.prototype.setRadius=function(t){this.r=t,this.invalidAABB()},Si.prototype.getRadius=function(){return this.r},Si.prototype.setPosition=function(t){this.p.copy(t),this.invalidAABB()},Si.prototype.getPosition=function(){return this.p},Si.prototype.computeDistanceAABB=function(t){return new bi.Box3(this.p.clone().add(new bi.Vector3(-this.r-t,-this.r-t,-this.r-t)),this.p.clone().add(new bi.Vector3(this.r+t,this.r+t,this.r+t)))},Si.prototype.prepareForEval=function(){this.valid_aabb||(this.valid_aabb=!0)},Si.prototype.getAreas=function(t){if(this.valid_aabb)return[{aabb:this.computeDistanceAABB(t),bv:new Vi(this.p,this.r+t,this.r/(this.r+t)),obj:this}];throw"ERROR : Cannot get area of invalid primitive"},Si.prototype.value=function(){var t=new bi.Vector3;return function(e,i){if(!this.valid_aabb)throw"Error : PrepareForEval should have been called";t.subVectors(e,this.p);var s=t.length();i.v=s-this.r,i.g&&i.g.copy(t).multiplyScalar(1/s)}}();var Ai=Si;const Mi=o.default,Ti=l,Pi=ii,Bi=vi;var Ni=function(t,e,i,s){Pi.call(this),this.p1=t.clone(),this.p2=e.clone(),this.r1=i,this.r2=s,this.r1=this.r1,this.rdiff=this.r2-this.r1,this.unit_dir=(new Mi.Vector3).subVectors(this.p2,this.p1),this.lengthSq=this.unit_dir.lengthSq(),this.length=this.unit_dir.length(),this.unit_dir.normalize()};(Ni.prototype=Object.create(Pi.prototype)).constructor=Ni,Ni.type="SDFCapsule",Ti.register(Ni.type,Ni),Ni.prototype.getType=function(){return Ni.type},Ni.prototype.toJSON=function(){var t=Pi.prototype.toJSON.call(this);return t.p1={x:this.p1.x,y:this.p1.y,z:this.p1.z},t.r1=this.r1,t.p2={x:this.p2.x,y:this.p2.y,z:this.p2.z},t.r2=this.r2,t},Ni.fromJSON=function(t){return ScalisVertex.fromJSON(t.v[0]),new Ni(new Mi.Vector3(t.p1.x,t.p1.y,t.p1.z),new Mi.Vector3(t.p2.x,t.p2.y,t.p2.z),t.r1,t.r2)},Ni.prototype.setRadius1=function(t){this.r1=t,this.invalidAABB()},Ni.prototype.setRadius2=function(t){this.r1=t,this.invalidAABB()},Ni.prototype.getRadius1=function(){return this.r1},Ni.prototype.getRadius2=function(){return this.r2},Ni.prototype.setPosition1=function(t){this.p1.copy(t),this.invalidAABB()},Ni.prototype.setPosition2=function(t){this.p2.copy(t),this.invalidAABB()},Ni.prototype.getPosition1=function(){return this.p1},Ni.prototype.getPosition2=function(){return this.p2},Ni.prototype.computeDistanceAABB=function(t){var e=new Mi.Box3(this.p1.clone().add(new Mi.Vector3(-this.r1-t,-this.r1-t,-this.r1-t)),this.p1.clone().add(new Mi.Vector3(this.r1+t,this.r1+t,this.r1+t))),i=new Mi.Box3(this.p2.clone().add(new Mi.Vector3(-this.r2-t,-this.r2-t,-this.r2-t)),this.p2.clone().add(new Mi.Vector3(this.r2+t,this.r2+t,this.r2+t)));return e.union(i)},Ni.prototype.prepareForEval=function(){this.valid_aabb||(this.valid_aabb=!0)},Ni.prototype.getAreas=function(t){if(this.valid_aabb)return[{aabb:this.computeDistanceAABB(t),bv:new Bi(this.p1,this.p2,this.r1+t,this.r2+t,this.r1/(this.r1+t),this.r2/(this.r2+t)),obj:this}];throw"ERROR : Cannot get area of invalid primitive"},Ni.prototype.value=function(){var t=new Mi.Vector3,e=new Mi.Vector3;return function(i,s){t.subVectors(i,this.p1);var r=t.lengthSq(),o=t.dot(this.unit_dir),n=o+-Math.sqrt(Math.max(0,r-o*o))/this.length*(this.r1-this.r2),h=Mi.Math.clamp(n/this.length,0,1);e.copy(this.p1).lerp(this.p2,h);var a=t.subVectors(i,e).length();s.v=a-(h*this.r2+(1-h)*this.r1),s.g&&s.g.copy(t).divideScalar(a)}}();var Fi=Ni,ki={EdgeVMap:[[0,4],[1,5],[2,6],[3,7],[0,2],[1,3],[4,6],[5,7],[0,1],[2,3],[4,5],[6,7]],VertexTopo:[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]]},Di=ki;const{Box2:zi}=o.default,Oi=o.default,Ei=P,Ri=A,ji=Di;class qi extends zi{constructor(t,e,i,s){if(super(t,e),null==i){var r=Math.max(this.max.x-this.min.x,this.max.y-this.min.y);this.nice_acc=r<=0?1e7:r}else this.nice_acc=i;this.raw_acc=null==s?this.nice_acc:s}union(t){super.union(t),this.raw_acc=Math.min(t.raw_acc,this.raw_acc),this.nice_acc=Math.min(t.nice_acc,this.nice_acc)}getRawAcc(){return this.raw_acc}getNiceAcc(){return this.nice_acc}setRawAcc(t){this.raw_acc=Math.max(0,t)}setNiceAcc(t){this.nice_acc=Math.max(0,t)}toString(){return"("+this.min.x.toFixed(2)+", "+this.min.y.toFixed(2)+") -> ("+this.max.x.toFixed(2)+", "+this.max.y.toFixed(2)+") "}set(t,e,i,s,r,o){this.min.set(t,e),this.max.set(i,s),void 0!==r&&(this.nice_acc=r),void 0!==o&&(this.raw_acc=o)}getMinCorner(){return this.min}}var Ci,Ii,Ji=function(t,e){e=e||{};this.blobtree=t,this.uniformZ="uniform"===e.zResolution,this.detail_ratio=e.detailRatio?Math.max(.01,e.detailRatio):1,e.convergence?(this.convergence=e.convergence,this.convergence.ratio=this.convergence.ratio||.01,this.convergence.step=this.convergence.step||10):this.convergence=null,this.progress=e.progress?e.progress:function(t){},this.reso=new Int32Array(3),this.steps={x:null,y:null,z:null},this.curr_steps={x:0,y:0,z:0},this.curr_step_vol=0,this.values_xy=[null,null],this.vertices_xy=[null,null],this.areas=[],this.min_acc=1,this.values=new Array(8),this.x=0,this.y=0,this.z=0,this.mask=0,this.edge_cross=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.vertex=new Oi.Vector3(0,0,0),this.vertex_n=new Oi.Vector3(0,0,0),this.vertex_m=new Ei,this.extended=!1,this.dis_o_aabb=new Oi.Box3,this.ext_p=new Oi.Vector3,this.geometry=null};Ji.prototype.initGeometry=function(){this.geometry={position:[],normal:[],color:[],metalness:[],roughness:[],nVertices:0,faces:[],nFaces:0,addVertex:function(t){this.position.push(t.p.x,t.p.y,t.p.z),this.normal.push(t.n.x,t.n.y,t.n.z),this.color.push(t.c.r,t.c.g,t.c.b),this.roughness.push(t.r),this.metalness.push(t.m),this.nVertices++},addFace:function(t,e,i){this.faces.push(t,e,i),this.nFaces++}}},Ji.prototype.buildResultingBufferGeometry=function(){var t=new Oi.BufferGeometry;return t.setAttribute("position",new Oi.BufferAttribute(new Float32Array(this.geometry.position),3)),t.setAttribute("normal",new Oi.BufferAttribute(new Float32Array(this.geometry.normal),3)),t.setAttribute("color",new Oi.BufferAttribute(new Float32Array(this.geometry.color),3)),t.setAttribute("roughness",new Oi.BufferAttribute(new Float32Array(this.geometry.roughness),1)),t.setAttribute("metalness",new Oi.BufferAttribute(new Float32Array(this.geometry.metalness),1)),t.setIndex(new Oi.BufferAttribute(this.geometry.nVertices>65535?new Uint32Array(this.geometry.faces):new Uint16Array(this.geometry.faces),1)),t},Ji.prototype.setFrontToZero=function(){for(var t=0;t<this.values_xy[1].length;++t)this.values_xy[1][t]=0},Ji.prototype.setFrontToMinus=function(){for(var t=0;t<this.values_xy[1].length;++t)this.values_xy[1][t]=-1},Ji.prototype.setFrontToZeroIfMinus=function(){for(var t=0;t<this.values_xy[1].length;++t)-1===this.values_xy[1][t]&&(this.values_xy[1][t]=0)},Ji.prototype.interpolateInBox=function(t,e,i,s,r,o,n){var h=this.values_xy[1],a=r-s,c=n-o;if(a>1)for(var p=h[(v=o*this.reso[0])+s],l=(h[v+r]-p)/a,u=1;u<a;++u)-1===h[v+s+u]&&(h[v+s+u]=p+u*l);if(c>1){var v;for(p=h[(v=n*this.reso[0])+s],l=(h[v+r]-p)/a,u=1;u<a;++u)-1===h[v+s+u]&&(h[v+s+u]=p+u*l);for(u=0;u<=a;++u){p=h[o*this.reso[0]+s+u],l=(h[n*this.reso[0]+s+u]-p)/c;for(var m=1;m<c;++m)-1===h[(o+m)*this.reso[0]+s+u]&&(h[(o+m)*this.reso[0]+s+u]=p+m*l)}}},Ji.prototype.computeFrontValAt=function(t,e,i,s,r){this.computeFrontValAtClosure(t,e,i,s,r)},Ji.prototype.computeFrontValAtClosure=(Ci={v:0},Ii=new Oi.Vector3,function(t,e,i,s,r){var o=r*this.reso[0]+s;Ci.v=this.blobtree.getNeutralValue(),-1===this.values_xy[1][o]&&(Ii.set(t+s*this.min_acc,e+r*this.min_acc,i),this.blobtree.value(Ii,Ci),this.values_xy[1][o]=Ci.v)}),Ji.prototype.computeFrontValAtBoxCorners=function(t,e,i,s,r){this.computeFrontValAt(t,e,i,s.x,s.y),this.computeFrontValAt(t,e,i,s.x,r.y),this.computeFrontValAt(t,e,i,r.x,s.y),this.computeFrontValAt(t,e,i,r.x,r.y)},Ji.prototype.computeFrontValInBox=function(t,e,i,s,r){for(var o=s.x;o<=r.x;++o)for(var n=s.y;n<=r.y;++n)this.computeFrontValAt(t,e,i,o,n)},Ji.prototype.setFrontValZeroInBox=function(t,e){for(var i=t.x;i<=e.x;++i)for(var s=t.y;s<=e.y;++s)this.values_xy[1][s*this.reso[0]+i]=0},Ji.prototype.computeBoxMask=function(t,e){var i=0;return i|=this.values_xy[1][t.y*this.reso[0]+t.x]>this.blobtree.getIsoValue()?1:0,i|=this.values_xy[1][t.y*this.reso[0]+e.x]>this.blobtree.getIsoValue()?2:0,i|=this.values_xy[1][e.y*this.reso[0]+e.x]>this.blobtree.getIsoValue()?4:0,i|=this.values_xy[1][e.y*this.reso[0]+t.x]>this.blobtree.getIsoValue()?8:0},Ji.prototype.checkZeroBox=function(t,e){return this.values_xy[1][t.y*this.reso[0]+t.x]+this.values_xy[1][t.y*this.reso[0]+e.x]+this.values_xy[1][e.y*this.reso[0]+e.x]+this.values_xy[1][e.y*this.reso[0]+t.x]},Ji.prototype.recursiveBoxComputation=function(t,e,i,s,r){var o=null,n=new Oi.Vector2(Math.round(s.max.x-s.min.x),Math.round(s.max.y-s.min.y));if(n.x>1&&n.x>=n.y){var h=s.min.x+Math.floor(n.x/2);o=[new qi(s.min,new Oi.Vector2(h,s.max.y),1e4,1e4),new qi(new Oi.Vector2(h,s.min.y),s.max,1e4,1e4)],this.computeFrontValAt(t,e,i,h,s.min.y),this.computeFrontValAt(t,e,i,h,s.max.y)}else{if(!(n.y>1))return;var a=s.min.y+Math.floor(n.y/2);o=[new qi(s.min,new Oi.Vector2(s.max.x,a),1e4,1e4),new qi(new Oi.Vector2(s.min.x,a),s.max,1e4,1e4)],this.computeFrontValAt(t,e,i,s.min.x,a),this.computeFrontValAt(t,e,i,s.max.x,a)}for(var c=[[],[]],p=0;p<r.length;++p)for(var l=0;l<o.length;++l)o[l].intersectsBox(r[p])&&(o[l].setRawAcc(Math.min(o[l].getRawAcc(),r[p].getRawAcc())),o[l].setNiceAcc(Math.min(o[l].getNiceAcc(),r[p].getNiceAcc())),c[l].push(r[p]));for(l=0;l<o.length;++l){var u=o[l],v=u.getSize(new Oi.Vector3);if(0===c[l].length)this.setFrontValZeroInBox(u.min,u.max);else if(v.x<=u.getRawAcc()&&v.y<=u.getRawAcc()){var m=this.computeBoxMask(u.min,u.max);15===m||0===m||v.x<=u.getNiceAcc()&&v.y<=u.getNiceAcc()?this.interpolateInBox(t,e,i,u.min.x,u.max.x,u.min.y,u.max.y):this.recursiveBoxComputation(t,e,i,u,c[l])}else this.recursiveBoxComputation(t,e,i,u,c[l])}},Ji.prototype.computeFrontValues=function(t,e,i){this.setFrontToMinus();var s=this.blobtree.getAreas(),r=new qi;r.makeEmpty();for(var o=[],n=0;n<s.length;++n){var h=Math.round(s[n].bv.getMinRawAcc()*this.detail_ratio/this.min_acc),a=Math.round(s[n].bv.getMinAcc()*this.detail_ratio/this.min_acc),c=Math.max(0,Math.floor((s[n].aabb.min.x-t)/this.min_acc)),p=Math.max(0,Math.floor((s[n].aabb.min.y-e)/this.min_acc)),l=Math.min(this.reso[0]-1,Math.ceil((s[n].aabb.max.x-t)/this.min_acc)),u=Math.min(this.reso[1]-1,Math.ceil((s[n].aabb.max.y-e)/this.min_acc));o.push(new qi(new Oi.Vector2(c,p),new Oi.Vector2(l,u),a,h)),r.union(o[o.length-1])}r.intersect(new qi(new Oi.Vector2(0,0),new Oi.Vector2(this.reso[0],this.reso[1]),r.getNiceAcc(),r.getRawAcc())),this.computeFrontValAtBoxCorners(t,e,i,r.min,r.max),this.recursiveBoxComputation(t,e,i,r,o),this.setFrontToZeroIfMinus()},Ji.prototype.getMinAcc=function(t){for(var e=this.blobtree.getAreas(),i=Number.MAX_VALUE,s=0;s<e.length;s++){var r=e[s];if(r.aabb.intersectsBox(t)&&r.bv){var o=r.bv.getMinAcc();o<i&&(i=o)}}return i*this.detail_ratio},Ji.prototype.getMaxAcc=function(t){for(var e=this.blobtree.getAreas(),i=0,s=0;s<e.length;s++){var r=e[s];if(r.aabb.intersectsBox(t)&&r.bv){var o=r.bv.getMinAcc();o>i&&(i=o)}}return i*this.detail_ratio},Ji.prototype.compute=function(t,e){this.initGeometry();var i=new Date;this.blobtree.prepareForEval();var s=null;if(s=t?t.clone():this.blobtree.getAABB(),this.extended=void 0!==e&&e,this.extended){for(var r=s.getSize(new Oi.Vector3),o=Math.min(Math.min(this.getMinAcc(s),r[0]),Math.min(r[1],r[2])),n=s.clone(),h=s.clone(),a=["x","y","z"],c=0;c<a.length;++c){n.max[a[c]]=s.min[a[c]]+o;var p=this.getMaxAcc(n);0!==p&&(h.min[a[c]]=h.min[a[c]]-p),n.max[a[c]]=s.max[a[c]]-o,0!==(p=this.getMaxAcc(n))&&(h.max[a[c]]=h.max[a[c]]+p)}s.copy(h)}var l=[],u=[];if(t&&(this.blobtree.externalTrim(s,l,u),this.blobtree.prepareForEval()),this.areas=this.blobtree.getAreas(),0===this.areas.length)return this.progress(100),new Oi.BufferGeometry;this.min_acc=0!==this.areas.length?this.areas[0].bv.getMinAcc():1;for(var v=0;v<this.areas.length;++v)this.areas[v].bv.getMinAcc()<this.min_acc&&(this.min_acc=this.areas[v].bv.getMinAcc());this.min_acc=this.min_acc*this.detail_ratio;var m=s.min,g=s.getSize(new Oi.Vector3);this.steps.z=new Float32Array(Math.ceil(g.z/this.min_acc)+2),m.z,this.steps.z[0]=m.z;for(var _=1,y=this.blobtree.getAreas();this.steps.z[_-1]<m.z+g.z;){var d=g.z;if(this.uniformZ)d=this.min_acc;else for(v=0;v<y.length;++v)d=Math.min(d,y[v].bv.getAxisProjectionMinStep("z",this.steps.z[_-1])*this.detail_ratio);this.steps.z[_]=this.steps.z[_-1]+d,_++}if(this.reso[2]=_,this.reso[0]=Math.ceil(g.x/this.min_acc)+2,this.reso[1]=Math.ceil(g.y/this.min_acc)+2,this.extended){v=0;for(this.dis_o_aabb.set(new Oi.Vector3(-1,-1,-1),new Oi.Vector3(-1,-1,-1));v<this.reso[2]&&-1===this.dis_o_aabb.min.z;)this.steps.z[v]>=t.min.z&&(this.dis_o_aabb.min.z=v),v++;for(v>this.reso[2]-1&&(this.dis_o_aabb.min.z=this.reso[2]-1),v=this.reso[2]-1;v>=0&&-1===this.dis_o_aabb.max.z;)this.steps.z[v]<t.max.z&&(this.dis_o_aabb.max.z=v),v--;v<0&&(this.dis_o_aabb.max.z=0),this.dis_o_aabb.min.x=Math.round((t.min.x-s.min.x)/this.min_acc),this.dis_o_aabb.min.y=Math.round((t.min.y-s.min.y)/this.min_acc),this.dis_o_aabb.max.x=this.reso[0]-2-Math.round((s.max.x-t.max.x)/this.min_acc),this.dis_o_aabb.max.y=this.reso[1]-2-Math.round((s.max.y-t.max.y)/this.min_acc)}this.values_xy[0]=new Float32Array(this.reso[0]*this.reso[1]),this.values_xy[1]=new Float32Array(this.reso[0]*this.reso[1]),this.vertices_xy[0]=new Int32Array(this.reso[0]*this.reso[1]),this.vertices_xy[1]=new Int32Array(this.reso[0]*this.reso[1]);var f=new Oi.Box3;this.computeFrontValues(m.x,m.y,m.z);for(var b=0,w=0;w<this.reso[2]-1;++w){var x=this.values_xy[0];this.values_xy[0]=this.values_xy[1],this.values_xy[1]=x,x=this.vertices_xy[0],this.vertices_xy[0]=this.vertices_xy[1],this.vertices_xy[1]=x;var V=this.steps.z[w+1];f.set(new Oi.Vector3(m.x,m.y,V-this.min_acc/64),new Oi.Vector3(m.x+this.reso[0]*this.min_acc,m.y+this.reso[1]*this.min_acc,V+this.min_acc/64)),this.blobtree.internalTrim(f),this.blobtree.prepareForEval(),this.computeFrontValues(m.x,m.y,V),this.blobtree.internalUntrim(f),this.blobtree.prepareForEval(),this.z=this.steps.z[w],this.curr_steps.z=this.steps.z[w+1]-this.steps.z[w],this.curr_steps.x=this.min_acc,this.curr_steps.y=this.min_acc,this.curr_step_vol=this.curr_steps.x*this.curr_steps.y*this.curr_steps.z;for(var S=0;S<this.reso[1]-1;++S)for(var A=0;A<this.reso[0]-1;++A)this.y=m.y+S*this.min_acc,this.fetchAndTriangulate(A,S,w,m);Math.round(100*w/this.reso[2])>b&&(b=Math.round(100*w/this.reso[2]),this.progress(b))}t&&(this.blobtree.untrim(l,u),this.blobtree.prepareForEval());var M=new Date;return console.log("Sliding Marching Cubes computed in "+(M-i)+"ms"),this.values_xy[0]=null,this.values_xy[1]=null,this.vertices_xy[0]=null,this.vertices_xy[1]=null,this.progress(100),this.buildResultingBufferGeometry()},Ji.prototype.fetchAndTriangulate=function(t,e,i,s){var r=e*this.reso[0]+t,o=(e+1)*this.reso[0]+t;this.values[0]=this.values_xy[0][r],this.values[1]=this.values_xy[1][r],this.values[2]=this.values_xy[0][o],this.values[3]=this.values_xy[1][o],this.values[4]=this.values_xy[0][r+1],this.values[5]=this.values_xy[1][r+1],this.values[6]=this.values_xy[0][o+1],this.values[7]=this.values_xy[1][o+1],this.computeMask(),0!==this.mask&&255!==this.mask&&(this.x=s.x+t*this.min_acc,this.computeVertex(),this.geometry.addVertex({p:this.vertex,n:this.vertex_n,c:this.vertex_m.getColor(),r:this.vertex_m.getRoughness(),m:this.vertex_m.getMetalness()}),this.vertices_xy[1][r]=this.geometry.nVertices-1,this.triangulate(t,e,i))},Ji.prototype.pushDirectFaces=function(t,e,i,s){this.geometry.addFace(t,e,i),this.geometry.addFace(i,s,t)},Ji.prototype.pushUndirectFaces=function(t,e,i,s){this.geometry.addFace(i,e,t),this.geometry.addFace(t,s,i)},Ji.prototype.triangulate=function(t,e,i){var s=e*this.reso[0]+t;if(this.edge_cross[0]&&0!==e&&0!==i){var r=this.vertices_xy[1][s],o=this.vertices_xy[1][(e-1)*this.reso[0]+t],n=this.vertices_xy[0][(e-1)*this.reso[0]+t],h=this.vertices_xy[0][s];1&this.mask?this.pushDirectFaces(r,o,n,h):this.pushUndirectFaces(r,o,n,h)}if(this.edge_cross[4]&&0!==t&&0!==i){r=this.vertices_xy[1][s],o=this.vertices_xy[0][s],n=this.vertices_xy[0][s-1],h=this.vertices_xy[1][s-1];1&this.mask?this.pushDirectFaces(r,o,n,h):this.pushUndirectFaces(r,o,n,h)}if(this.edge_cross[8]&&0!==t&&0!==e){r=this.vertices_xy[1][s],o=this.vertices_xy[1][s-1],n=this.vertices_xy[1][(e-1)*this.reso[0]+t-1],h=this.vertices_xy[1][(e-1)*this.reso[0]+t];1&this.mask?this.pushDirectFaces(r,o,n,h):this.pushUndirectFaces(r,o,n,h)}},Ji.prototype.computeVertex=function(){var t={v:null,g:new Oi.Vector3(0,0,0),m:new Ei},e=new Oi.Vector3;return function(){t.v=this.blobtree.getNeutralValue();var i=0;this.vertex.set(0,0,0);for(var s=0;s<12;++s){var r=ji.EdgeVMap[s][0],o=ji.EdgeVMap[s][1],n=ji.VertexTopo[r],h=ji.VertexTopo[o],a=this.values[r],c=this.values[o];if(this.edge_cross[s]=a>this.blobtree.getIsoValue()!=c>this.blobtree.getIsoValue(),this.edge_cross[s]){++i;var p=c-a,l=0;Math.abs(p)>1e-6&&(l=(this.blobtree.getIsoValue()-a)/p,this.vertex.x+=(1-l)*n[0]+l*h[0],this.vertex.y+=(1-l)*n[1]+l*h[1],this.vertex.z+=(1-l)*n[2]+l*h[2])}}this.vertex.x=this.x+this.curr_steps.x*this.vertex.x/i,this.vertex.y=this.y+this.curr_steps.y*this.vertex.y/i,this.vertex.z=this.z+this.curr_steps.z*this.vertex.z/i,this.convergence&&(Ri.safeNewton3D(this.blobtree,this.vertex,this.blobtree.getIsoValue(),this.min_acc*this.convergence.ratio,this.convergence.step,this.min_acc,e),this.vertex.copy(e)),this.blobtree.value(this.vertex,t),t.g.normalize(),this.vertex_n.copy(t.g).multiplyScalar(-1),this.vertex_m.copy(t.m)}}(),Ji.prototype.computeMask=function(){this.mask=0;for(var t=0;t<8;++t){var e=this.values[t];this.mask|=e>this.blobtree.getIsoValue()?1<<t:0}};var Ki=Ji;const Gi=o.default,Hi=l,Li=x,Ui=P;var Wi=function(t){if(Li.call(this),t){var e=this;t.forEach((function(t){e.addChild(t)}))}this.tmp_res={v:0,g:null,m:null},this.tmp_g=new Gi.Vector3,this.tmp_m=new Ui};(Wi.prototype=Object.create(Li.prototype)).constructor=Wi,Wi.type="MaxNode",Hi.register(Wi.type,Wi),Wi.prototype.getType=function(){return Wi.type},Wi.fromJSON=function(t){for(var e=new Wi,i=0;i<t.children.length;++i)e.addChild(Hi.fromJSON(t.children[i]));return e},Wi.prototype.prepareForEval=function(){if(!this.valid_aabb){this.aabb=new Gi.Box3;for(var t=0;t<this.children.length;++t){var e=this.children[t];e.prepareForEval(),this.aabb.union(e.getAABB())}this.valid_aabb=!0}},Wi.prototype.value=function(t,e){var i=this.children.length,s=this.tmp_res;if(s.g=e.g?this.tmp_g:null,s.m=e.m?this.tmp_m:null,e.v=0,e.m&&e.m.copy(Ui.defaultMaterial),e.g?e.g.set(0,0,0):void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)&&0!==i){e.v=Number.MAX_VALUE;for(var r=0;r<i;++r){if(this.children[r].value(t,s),s.v>e.v&&(e.v=s.v,e.g&&e.g.copy(s.g),e.m&&e.m.copy(s.m),e.step||e.stepOrtho))throw"Not implemented";e.v=Math.max(e.v,s.v)}}else if(e.steo||e.stepOrtho)throw"Not implemented"};var Zi=Wi;const $i=n.default.mergeBufferGeometries,Xi=W,Yi=z,Qi=Zi,ts=Ct,es=oe,is=ze,ss=Ki;var rs=function(t,e){e=e||{};this.blobtree=t,this.uniformRes=e.uniformRes||!1,this.min_acc=null,this.minAccs=[],this.subPolygonizer=e.subPolygonizer?e.subPolygonizer:{class:ss,detailRatio:1},this.ricciThreshold=e.ricciThreshold||64,this.progress=e.progress?e.progress:function(t){},this.subtrees=[],this.progCoeff=[],this.totalCoeff=0,this.setBlobtree(t)};rs.prototype.constructor=rs,rs.prototype.setBlobtree=function(t){this.blobtree=t,this.blobtree.prepareForEval();var e=function(t){for(var e=t.getAreas(),i=0!==e.length?e[0].bv.getMinAcc():null,s=0;s<e.length;++s)e[s].bv.getMinAcc()<i&&(i=e[s].bv.getMinAcc());return i};this.min_acc=e(this.blobtree),this.subtrees=[],this.progCoeff=[],this.totalCoeff=0;var i=this,s=function(t){var s=null;t instanceof Xi?s=t.clone():(s=new Xi).addChild(t.clone()),i.subtrees.push(s),s.prepareForEval(),i.minAccs.push(e(s)),i.progCoeff.push(s.count(ts)+s.count(es)+s.count(is)),i.totalCoeff+=i.progCoeff[i.progCoeff.length-1]},r=function(t){if(t instanceof Yi)if(t.getRicciN()<i.ricciThreshold)0!==t.children.length&&s(t);else for(var e=0;e<t.children.length;++e)r(t.children[e]);else if(t instanceof Qi)for(e=0;e<t.children.length;++e)r(t.children[e]);else s(t)};r(this.blobtree)},rs.prototype.compute=function(){this.blobtree.isValidAABB()||this.setBlobtree(this.blobtree);var t=this;this.progress(0);for(var e=0,i=[],s=0;s<this.subtrees.length;++s){var r=this.subPolygonizer.detailRatio||1;this.uniformRes&&this.min_acc&&(this.subPolygonizer.detailRatio=r*this.min_acc/this.minAccs[s]),this.subPolygonizer.progress=function(i){t.progress(100*(e+i/100*t.progCoeff[s])/t.totalCoeff)};var o=new this.subPolygonizer.class(this.subtrees[s],this.subPolygonizer);i.push(o.compute()),this.subPolygonizer.detailRatio=r,e+=this.progCoeff[s]}var n=$i(i);return this.progress(100),n};var os=rs;const ns=o.default,hs=P,as=Di,cs=A,ps=Ki;var ls=function(t,e){if(ps.call(this,t,e),!e.metaBlobtree)throw"Error : SplitSMC needs a meta blobtree in params (from which normals will be computed).";this.metaBlobtree=e.metaBlobtree,this.metaBlobtree.prepareForEval()};(ls.prototype=Object.create(ps.prototype)).constructor=ls,ls.prototype.computeVertex=function(){var t={v:null,g:new ns.Vector3(0,0,0),m:new hs},e=new ns.Vector3;return function(){t.v=this.blobtree.getNeutralValue();var i=0;this.vertex.set(0,0,0);for(var s=0;s<12;++s){var r=as.EdgeVMap[s][0],o=as.EdgeVMap[s][1],n=as.VertexTopo[r],h=as.VertexTopo[o],a=this.values[r],c=this.values[o];if(this.edge_cross[s]=a>this.blobtree.getIsoValue()!=c>this.blobtree.getIsoValue(),this.edge_cross[s]){++i;var p=c-a,l=0;Math.abs(p)>1e-6&&(l=(this.blobtree.getIsoValue()-a)/p,this.vertex.x+=(1-l)*n[0]+l*h[0],this.vertex.y+=(1-l)*n[1]+l*h[1],this.vertex.z+=(1-l)*n[2]+l*h[2])}}this.vertex.x=this.x+this.curr_steps.x*this.vertex.x/i,this.vertex.y=this.y+this.curr_steps.y*this.vertex.y/i,this.vertex.z=this.z+this.curr_steps.z*this.vertex.z/i,this.convergence&&(cs.safeNewton3D(this.blobtree,this.vertex,this.blobtree.getIsoValue(),this.min_acc*this.convergence.ratio,this.convergence.step,this.min_acc,e),this.vertex.copy(e)),this.metaBlobtree.value(this.vertex,t),t.g.normalize(),this.vertex_n.copy(t.g).multiplyScalar(-1),this.vertex_m.copy(t.m)}}();var us=ls;const vs="1.0.0";var ms=Object.freeze({__proto__:null,version:vs,Types:l,Element:d,Node:x,RootNode:W,RicciNode:z,DifferenceNode:tt,MinNode:nt,MaxNode:nt,Primitive:pt,ScalisMath:ut,ScalisPrimitive:_t,ScalisPoint:Ct,ScalisSegment:oe,ScalisTriangle:ze,ScalisVertex:wt,DistanceFunctor:Re,Poly6DistanceFunctor:Ie,SDFRootNode:Xe,SDFPrimitive:ii,SDFPoint:ai,SDFSegment:fi,SDFSphere:Ai,SDFCapsule:Fi,Material:P,Accuracies:At,Area:Vt,AreaScalisSeg:Lt,AreaScalisTri:de,AreaSphere:Ft,AreaCapsule:vi,SlidingMarchingCubes:Ki,SplitMaxPolygonizer:os,SplitSMC:us});const gs="three-js-blobtree";var _s,ys;return _s=gs,ys=130,THREE.REVISION!=ys&&console.warn(`${_s} is currently made for THREE revision ${ys}. Using any other revision may lead to unexpected behavior (current: ${THREE.REVISION}).`),a(gs,"BufferGeometryUtils",h),a(gs,"Blobtree",ms),t.Accuracies=At,t.Area=Vt,t.AreaCapsule=vi,t.AreaScalisSeg=Lt,t.AreaScalisTri=de,t.AreaSphere=Ft,t.DifferenceNode=tt,t.DistanceFunctor=Re,t.Element=d,t.Material=P,t.MaxNode=nt,t.MinNode=nt,t.Node=x,t.Poly6DistanceFunctor=Ie,t.Primitive=pt,t.RicciNode=z,t.RootNode=W,t.SDFCapsule=Fi,t.SDFPoint=ai,t.SDFPrimitive=ii,t.SDFRootNode=Xe,t.SDFSegment=fi,t.SDFSphere=Ai,t.ScalisMath=ut,t.ScalisPoint=Ct,t.ScalisPrimitive=_t,t.ScalisSegment=oe,t.ScalisTriangle=ze,t.ScalisVertex=wt,t.SlidingMarchingCubes=Ki,t.SplitMaxPolygonizer=os,t.SplitSMC=us,t.Types=l,t.version=vs,Object.defineProperty(t,"__esModule",{value:!0}),t}({},THREE,THREE);
