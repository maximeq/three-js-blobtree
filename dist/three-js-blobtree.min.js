var Blobtree=function(t,e,i){"use strict";function s(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var r=s(e),o=s(i);function h(t,e,i){try{if(void 0===THREE[e])return void(THREE[e]=i);if(THREE[e]!==i)throw new Error(`${t}: ${e} is duplicated. Your bundle includes ${e} twice. Please repair your bundle.`)}catch(e){if(e.message.match(/is duplicated/))throw e;console.warn(`${t}: Duplication check unavailable. ${e}`)}}var a={types:{},register(t,e){if(this.types[t])throw"Error : cannot register type "+t+", this name is already registered.";this.types[t]=e},fromJSON(t){var e=this.types[t.type];if(!e)throw"Error : type found in JSON ("+t.type+" is not registered in the Blobtree library.";return e.fromJSON(t)}};const n=r.default,c=a;let l=0;class p{static type="Element";static fromJSON(t){throw new Error("Element.fromJSON should never be called as Element is abstract.")}constructor(){this.id=l++,this.aabb=new n.Box3,this.valid_aabb=!1,this.parentNode=null}toJSON(){return{type:this.getType()}}clone(){return c.fromJSON(this.toJSON())}getParentNode(){return this.parentNode}getType(){return p.type}computeHelpVariables(){this.computeAABB()}computeAABB(){throw"Error : computeAABB is abstract, should have been overwritten"}getAABB(){return this.aabb}isValidAABB(){return this.valid_aabb}invalidAABB(){this.valid_aabb=!1,null!==this.parentNode&&this.parentNode.isValidAABB()&&this.parentNode.invalidAABB()}invalidAll(){this.invalidAABB()}prepareForEval(){console.error("Blobtree.Element: prepareForEval is a virtual function, should be re-implemented in all element(error occured in Element.js")}value(t,e){throw new Error("ERROR : value is an abstract function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)")}numericalGradient=function(){let t={v:0},e=["x","y","z"];return function(i,s,r){let o=this,h=r||1e-5;for(let r=0;r<3;++r)i[e[r]]=i[e[r]]+h,o.value(i,t),s[e[r]]=t.v,i[e[r]]=i[e[r]]-2*h,o.value(i,t),s[e[r]]=(s[e[r]]-t.v)/(2*h),i[e[r]]=i[e[r]]+h}}();getAreas(){return[]}distanceTo(t){throw new Error("ERROR : distanceTo is a virtual function, should be reimplemented in all classes extending Element. Concerned type: "+this.getType()+".")}heuristicStepWithin(){throw new Error("ERROR : heuristicStepWithin is a virtual function, should be reimplemented in all classes extending Element. Concerned type: "+this.getType()+".")}trim(t,e,i){}count(t){return 0}destroy(){console.error("Blobtree.Element: destroy is a virtual function, should be reimplemented in all classes extending Element.")}}c.register(p.type,p);var u=p;const m=u,v=a;class _ extends m{static type="Node";static fromJSON(t){throw new Error("Node.fromJSON should never be called as Node is abstract.")}constructor(){super(),this.children=[]}getType(){return _.type}toJSON(){for(var t={...super.toJSON(),children:[]},e=0;e<this.children.length;++e)t.children.push(this.children[e].toJSON());return t}clone(){return v.fromJSON(this.toJSON())}prepareForEval(){return console.error("Blobtree.Node: prepareForEval is a pure abstract function, should be reimplemented in every node class."),super.prepareForEval()}invalidAll(){if(this.invalidAABB(),this.children)for(var t=0;t<this.children.length;t++)this.children[t].invalidAll()}destroy(){for(var t=this.children.slice(0,this.children.length),e=0;e<t.length;e++)t[e].destroy();if(0!==this.children.length)throw"Error : children length should be 0";if(null!==this.parentNode&&this.parentNode.removeChild(this),null!==this.parentNode)throw"Error : parent node should be null at this point";this.children.length=0}addChild(t){return null!==t.parentNode&&t.parentNode.removeChild(t),this.children.push(t),t.parentNode=this,this.invalidAABB(),this}removeChild(t){for(var e=0,i=this.children;i[e]!==t&&e<i.length;)++e;if(e==i.length)throw"c does not belong to the children of this node";i[e]=i[i.length-1],i.pop(),this.invalidAABB(),t.parentNode=null}computeAABB(){this.aabb.makeEmpty();for(var t=0;t<this.children.length;t++)this.children[t].computeAABB(),this.aabb.union(this.children[t].getAABB())}getAreas(){if(!this.valid_aabb)throw"Error : cannot call getAreas on a not prepared for eval nod, please call PrepareForEval first. Node concerned is a "+this.getType();for(var t=[],e=0;e<this.children.length;e++)t.push.apply(t,this.children[e].getAreas());return t}distanceTo(t){for(var e=1e7,i=0;i<this.children.length;i++)e=Math.min(e,this.children[i].distanceTo(t));return e}heuristicStepWithin(){for(var t=1e7,e=0;e<this.children.length;e++)t=Math.min(t,this.children[e].heuristicStepWithin());return t}trim(t,e,i){let s=e.length;for(let s=0;s<this.children.length;s++)this.children[s].getAABB().intersectsBox(t)||(e.push(this.children[s]),i.push(this));for(let t=s;t<e.length;++t)this.removeChild(e[t]);for(let s=0;s<this.children.length;s++)this.children[s].trim(t,e,i)}count(t){var e=0;this instanceof t&&e++;for(var i=0;i<this.children.length;i++)e+=this.children[i].count(t);return e}}v.register(_.type,_);var g=_;const d=r.default;class y{static defaultMaterial=new y;static areEqualsArrays(t){console.warn("Material.areEqualsArrays is deprecated, please use your own comparison function using Material.equals.");let e=!0;for(let i=1;i<arguments.length;i++)e=e&&(null===t&&null===arguments[i]||null!==t&&null!==arguments[i]);if(!e)return e;if(null===t)return!0;for(let i=1;i<arguments.length;i++){let s=!0;if(arguments[i].length!==t.length)return!1;for(let e=0;e<t.length;++e)s=s&&t[e].equals(arguments[i][e]);e=e&&s}return e}static fromJSON(t){return new y({color:new d.Color(t.color),roughness:t.roughness,metalness:t.metalness,emissive:t.emissive})}constructor(t){if(t=t||{},void 0!==arguments[1])throw"Error : Blobtree Material now takes only 1 argument.";this.color=new d.Color(void 0!==t.color?t.color:11184810),this.roughness=void 0!==t.roughness?t.roughness:0,this.metalness=void 0!==t.metalness?t.metalness:0,this.emissive=new d.Color(void 0!==t.emissive?t.emissive:0)}toJSON(){return{color:"#"+this.color.getHexString(),roughness:this.roughness,metalness:this.metalness,emissive:`#${this.emissive.getHexString()}`}}clone(){return new y({color:this.color,roughness:this.roughness,metalness:this.metalness,emissive:this.emissive})}copy(t){this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.emissive.copy(t.emissive)}set(t,e,i){this.color.copy(t),this.roughness=e,this.metalness=i}setParams(t){this.color.copy(t.color?t.color:this.color),this.roughness=void 0!==t.roughness?t.roughness:this.roughness,this.metalness=void 0!==t.metalness?t.metalness:this.metalness,this.emissive.copy(void 0!==t.emissive?t.emissive:this.emissive)}getColor(){return this.color}getRoughness(){return this.roughness}getMetalness=function(){return this.metalness};getEmissive(){return this.emissive}equals(t){return this.color.equals(t.color)&&this.metalness===t.metalness&&this.roughness===t.roughness&&this.emissive.equals(t.emissive)}lerp(t,e){this.color.lerp(t.color,e),this.roughness=(1-e)*this.roughness+e*t.roughness,this.metalness=(1-e)*this.metalness+e*t.metalness,this.emissive.lerp(t.emissive,e)}triMean(t,e,i,s,r,o,h){return this.color.r=(s*t.color.r+r*e.color.r+o*i.color.r)/h,this.color.g=(s*t.color.g+r*e.color.g+o*i.color.g)/h,this.color.b=(s*t.color.b+r*e.color.b+o*i.color.b)/h,this.roughness=(s*t.roughness+r*e.roughness+o*i.roughness)/h,this.metalness=(s*t.metalness+r*e.metalness+o*i.metalness)/h,this.emissive.r=(s*t.emissive.r+r*e.emissive.r+o*i.emissive.r)/h,this.emissive.g=(s*t.emissive.g+r*e.emissive.g+o*i.emissive.g)/h,this.emissive.b=(s*t.emissive.b+r*e.emissive.b+o*i.emissive.b)/h,this}weightedMean(t,e,i){this.color.setRGB(0,0,0),this.roughness=0,this.metalness=0,this.emissive.setScalar(0);const s=void 0===i?t.length:i;let r=0;for(let i=0;i<s;++i)this.color.r+=e[i]*t[i].color.r,this.color.g+=e[i]*t[i].color.g,this.color.b+=e[i]*t[i].color.b,this.roughness+=e[i]*t[i].roughness,this.metalness+=e[i]*t[i].metalness,this.emissive.r+=e[i]*t[i].emissive.r,this.emissive.g+=e[i]*t[i].emissive.g,this.emissive.b+=e[i]*t[i].emissive.b,r+=e[i];return 0!==r?(this.color.r/=r,this.color.g/=r,this.color.b/=r,this.roughness/=r,this.metalness/=r,this.emissive.r/=r,this.emissive.g/=r,this.emissive.b/=r):(this.color.setScalar(0),this.roughness=0,this.metalness=0,this.emissive.setScalar(0)),this}}var b=y;const f=r.default,w=a,x=g,V=b;class S extends x{static type="RicciNode";constructor(t,e){if(super(),this.ricci_n=t,e){let t=this;e.forEach((function(e){t.addChild(e)}))}this.tmp_v_arr=new Float32Array(0),this.tmp_m_arr=[],this.tmp_res={v:0,g:null,m:null},this.tmp_g=new f.Vector3,this.tmp_m=new V}getType(){return S.type}toJSON(){return{...super.toJSON(),ricci_n:this.ricci_n}}static fromJSON(t){let e=new S(t.ricci_n);for(let i=0;i<t.children.length;++i)e.addChild(w.fromJSON(t.children[i]));return e}prepareForEval(){if(!this.valid_aabb){this.aabb=new f.Box3;for(let t=0;t<this.children.length;++t){let e=this.children[t];e.prepareForEval(),this.aabb.union(e.getAABB())}if(this.valid_aabb=!0,this.tmp_v_arr.length<this.children.length){this.tmp_v_arr=new Float32Array(2*this.children.length),this.tmp_m_arr.length=2*this.children.length;for(let t=0;t<this.tmp_m_arr.length;++t)this.tmp_m_arr[t]=new V({roughness:0,metalness:0})}}}value(t,e){let i=this.children.length,s=this.tmp_res;if(s.g=e.g?this.tmp_g:null,s.m=e.m?this.tmp_m:null,e.v=0,e.m&&e.m.copy(V.defaultMaterial),e.g?e.g.set(0,0,0):void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)&&0!==i){let r=this.tmp_v_arr,o=this.tmp_m_arr,h=0,a=0;for(let n=0;n<i;++n)if(this.children[n].aabb.containsPoint(t))if(this.children[n].value(t,s),s.v>0){let t=Math.pow(s.v,this.ricci_n-1);a+=s.v*t,e.g&&(s.g.multiplyScalar(t),e.g.add(s.g)),e.m&&(r[h]=s.v*t,o[h].copy(s.m),h++),(e.step||e.stepOrtho)&&(e.step=Math.min(e.step,this.children[n].heuristicStepWithin()))}else void 0!==e.step&&(e.step=Math.min(e.step,this.children[n].distanceTo(t)));else(e.step||e.stepOrtho)&&(e.step=Math.min(e.step,this.children[n].distanceTo(t)));e.v=Math.pow(a,1/this.ricci_n),0!==e.v&&(e.g&&e.g.multiplyScalar(e.v/a),e.m&&e.m.weightedMean(o,r,h))}else if(void 0!==e.step&&0!==this.children.length){let i=this.children[0].heuristicStepWithin();for(let t=1;t<this.children.length;++t)i=Math.min(i,this.children[t].heuristicStepWithin());e.step=this.aabb.distanceToPoint(t)+i}void 0!==e.stepOrtho&&(e.stepOrtho=e.step)}setRicciN(t){this.ricci_n!=t&&(this.ricci_n=t,this.invalidAABB())}getRicciN=function(){return this.ricci_n}}w.register(S.type,S);var A=S;const M=r.default,T={};T.last_mov_pt=new M.Vector3,T.grad=new M.Vector3,T.eval_res_g=new M.Vector3(0,0,0),T.eval_res={v:0,m:null,g:null},T.vec=new M.Vector3,T.safeNewton3D=function(t,e,i,s,r,o,h){h.copy(e);for(var a=1,n=0,c=!1;2!=n&&a<=r&&!c;){if(this.last_mov_pt.copy(h),this.eval_res.g=this.eval_res_g,t.value(h,this.eval_res),this.grad.copy(this.eval_res.g),0!==this.grad.x||0!==this.grad.y||0!==this.grad.z){var l=this.grad.length(),p=(i-this.eval_res.v)/l;if(p<s&&p>-s?(p=p>0?s/l:-s/l,n++):n=0,this.grad.normalize().multiplyScalar(p),h.add(this.grad),this.vec.subVectors(h,e).lengthSq()>o*o)return void h.copy(e)}else c=!0;++a}c&&h.copy(e)},T.safeNewton1D=function(t,e,i,s,r,o,h,a,n,c){if(this.eval_res.g=this.eval_res_g,0===i.x&&0===i.y&&0===i.z)throw"Error : search direction is null";if(a<=0)throw"Error: epsilon <= 0, convergence will nuke your face or loop";if(o<s||o>r)throw"Error : starting absc is not in boundaries";for(var l=o,p=new M.Vector3,u=0,m=0;r-s>a&&m<n;)t.value(p.copy(i).multiplyScalar(l).add(e),this.eval_res),this.eval_res.v>h?s=l:r=l,0!==(u=this.eval_res.g.dot(i))?((l+=(h-this.eval_res.v)/u)>=r||l<=s)&&(l=.5*(r+s)):l=.5*(r+s),++m;c.p_absc=.5*(r+s),c.p.copy(i).multiplyScalar(l).add(e),void 0!==c.g&&(0===m&&t.value(c.p,this.eval_res),c.g.copy(this.eval_res.g))},T.dichotomy1D=function(t,e,i,s,r,o,h,a){this.eval_res.g=null;var n=(new M.Vector3).copy(e),c=new M.Vector3,l=-(s/=2),p=l;e.sub(c.copy(i).multiplyScalar(s));for(var u=0;s>o&&u<h;)u++,n.copy(e),p=l,s/=2,t.value(e,this.eval_res),this.eval_res.v<r?(e.add(c.copy(i).multiplyScalar(s)),l+=s):(e.sub(c.copy(i).multiplyScalar(s)),l-=s);a.p.copy(e.add(n).divideScalar(2)),a.p_absc=(p+l)/2,a.p.copy(e),a.p_absc=l,a.g&&(this.eval_res.g=this.eval_res_g,t.value(a.p,this.eval_res),a.g.copy(this.eval_res.g))};var B=T;const N=r.default,P=a,F=A,z=B;class k extends F{static type="RootNode";static fromJSON(t){for(var e=new k,i=0;i<t.children.length;++i)e.addChild(P.fromJSON(t.children[i]));return e}constructor(){super(64),this.valid_aabb=!0,this.iso_value=1,this.trimmed=[],this.trim_parents=[]}getType(){return k.type}toJSON(){return{...super.toJSON(),iso:this.iso_value}}getIsoValue(){return this.iso_value}setIsoValue(t){this.iso_value=t}getNeutralValue(){return 0}invalidAABB(){this.valid_aabb=!1}internalTrim(t){if(0!==this.trimmed.length||0!==this.trim_parents.length)throw"Error : you should not call internal trim if you have not untrimmed before. Call untrim or use externalTrim";this.trim(t,this.trimmed,this.trim_parents)}externalTrim(t,e,i){this.trim(t,e,i)}internalUntrim(){this.untrim(this.trimmed,this.trim_parents),this.trimmed.length=0,this.trim_parents.length=0}untrim(t,e){if(t.length!==e.length)throw"Error : trimmed and parents arrays should have the same length";for(var i=0;i<t.length;++i)e[i].addChild(t[i])}isEmpty=function(){return 0==this.children.length};intersectRayBlob=function(){var t=new N.Vector3,e=new N.Vector3,i=new N.Vector3,s={v:0,g:new N.Vector3,step:0},r={p:new N.Vector3,g:new N.Vector3,p_absc:0},o=0,h=0,a=0;return function(n,c,l,p){for(t.copy(n.origin),e.copy(n.direction),e.normalize(),a=0,s.g=null,this.value(t,s);s.v<this.iso_value&&a<l;)t.add(i.copy(e).multiplyScalar(s.step)),a+=s.step,o=s.step,h=s.v,this.value(t,s);return s.v>=this.iso_value&&(z.safeNewton1D(this,t,e.multiplyScalar(-1),0,o,o*(this.iso_value-s.v)/(h-s.v),this.iso_value,o/512,10,r),c.distance=a-r.p_absc,c.point=r.p.clone(),c.g&&c.g.copy(r.g),!0)}}();intersectOrthoRayBlob=function(){var t=new N.Vector3,e=new N.Vector3,i={v:0,step:0},s=new N.Vector3,r={v:0},o=0,h=0,a=1e-7,n=-1;return function(c,l,p,u){for(u.axis.x?t.set(this.aabb.min.x+c,this.aabb.min.y+l,this.aabb.min.z+a):u.axis.y?t.set(this.aabb.min.x+c,this.aabb.min.y+a,this.aabb.min.z+l):u.axis.z&&t.set(this.aabb.min.x+a,this.aabb.min.y+c,this.aabb.min.z+l),i.step=u.get(this.aabb.max)-u.get(this.aabb.min),this.value(t,i),o=a,n=-1;u.get(t)<u.get(this.aabb.max);){for(;(i.v-1)*n>=0&&u.get(t)<u.get(this.aabb.max);)u.add(t,i.step),o=i.step,i.step=u.get(this.aabb.max)-u.get(t),this.value(t,i);if(u.get(t)<u.get(this.aabb.max)){for(n*=-1,e.copy(t),h=u.get(t),o/=2,u.add(t,-o),r.g=null;o>.1;)h=u.get(t),o/=2,this.value(t,r),(r.v-1)*n<0?u.add(t,o):u.add(t,-o);u.add(t,h),u.divide(t,2),r.g=s,this.value(t,r),p.push({point:t.clone(),g:r.g.clone()}),t.copy(e)}}}}()}P.register(k.type,k);var D=k;const E=r.default,O=a,R=g,C=b;class q extends R{static type="DifferenceNode";static fromJSON(t){return new q(O.fromJSON(t.children[0]),O.fromJSON(t.children[1]),t.alpha)}constructor(t,e,i){super(),this.addChild(t),this.addChild(e),this.alpha=i||1,this.clamped=0,this.tmp_res0={v:0,g:new E.Vector3(0,0,0),m:new C},this.tmp_res1={v:0,g:new E.Vector3(0,0,0),m:new C},this.g0=new E.Vector3,this.m0=new C,this.g1=new E.Vector3,this.m1=new C,this.tmp_v_arr=new Float32Array(2),this.tmp_m_arr=[null,null]}getAlpha(){return this.alpha}setAlpha(t){this.alpha!=t&&(this.alpha=t,this.invalidAABB())}toJSON(){return{...super.toJSON(),alpha:this.alpha}}prepareForEval(){this.valid_aabb||(this.children[0].prepareForEval(),this.children[1].prepareForEval(),this.aabb.copy(this.children[0].getAABB()),this.valid_aabb=!0)}value(t,e){var i=this.tmp_v_arr,s=this.tmp_m_arr,r=this.tmp_res0,o=this.tmp_res1;if(r.g=e.g?this.g0:null,r.m=e.m?this.m0:null,o.g=e.g?this.g1:null,o.m=e.m?this.m1:null,e.v=0,o.v=0,r.v=0,e.m&&(e.m.copy(C.defaultMaterial),o.m.copy(C.defaultMaterial),r.m.copy(C.defaultMaterial)),e.g?(e.g.set(0,0,0),o.g.set(0,0,0),r.g.set(0,0,0)):void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)){if(this.children[0].aabb.containsPoint(t))if(this.children[0].value(t,r),this.children[1].aabb.containsPoint(t)&&this.children[1].value(t,o),0===o.v)e.v=r.v,e.g&&e.g.copy(r.g),e.m&&e.m.copy(r.m);else{var h=Math.pow(o.v,this.alpha);e.v=Math.max(this.clamped,r.v-o.v*Math.pow(o.v,this.alpha-1)),e.g&&(e.v===this.clamped?e.g.set(0,0,0):(o.g.multiplyScalar(h),e.g.subVectors(r.g,o.g))),e.m&&(i[0]=r.v,i[1]=o.v,s[0]=r.m,s[1]=o.m,e.m.weightedMean(s,i,2))}}else void 0!==e.step&&(e.step=this.aabb.distanceToPoint(t)+.3)}trim(t,e,i){for(var s=0;s<this.children.length;s++)this.children[s].trim(t,e,i)}}O.register(q.type,q);var J=q;const j=r.default,I=a,K=g,G=b;class H extends K{static type="MinNode";static fromJSON(t){for(var e=new H,i=0;i<t.children.length;++i)e.addChild(I.fromJSON(t.children[i]));return e}constructor(t){if(super(),t){var e=this;t.forEach((function(t){e.addChild(t)}))}this.tmp_res={v:0,g:null,m:null},this.tmp_g=new j.Vector3,this.tmp_m=new G}getType(){return H.type}prepareForEval(){if(!this.valid_aabb){this.aabb=new j.Box3;for(var t=0;t<this.children.length;++t){var e=this.children[t];e.prepareForEval(),this.aabb.union(e.getAABB())}this.valid_aabb=!0}}value(t,e){var i=this.children.length,s=this.tmp_res;if(s.g=e.g?this.tmp_g:null,s.m=e.m?this.tmp_m:null,e.v=0,e.m&&e.m.copy(G.defaultMaterial),e.g?e.g.set(0,0,0):void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)&&0!==i){e.v=Number.MAX_VALUE;for(var r=0;r<i;++r){if(this.children[r].value(t,s),s.v<e.v&&(e.v=s.v,e.g&&e.g.copy(s.g),e.m&&e.m.copy(s.m),e.step||e.stepOrtho))throw"Not implemented";e.v=Math.min(e.v,s.v)}}else if(e.step||e.stepOrtho)throw"Not implemented"}trim(t,e,i){for(var s=0;s<this.children.length;s++)this.children[s].trim(t,e,i)}}I.register(H.type,H);var U=H;const L=r.default,W=a,$=g,X=b;class Z extends ${static type="TwistNode";constructor(t){if(super(),t){var e=this;t.forEach((function(t){e.addChild(t)}))}this.tmp_res={v:0,g:null,m:null},this.tmp_g=new L.Vector3,this.tmp_m=new X,this._twist_amout=1,this._twist_axis=new L.Vector3(0,1,0),this._twist_axis_mat=new L.Matrix4,this._twist_axis_mat_inv=new L.Matrix4}toJSON(){return{...super.toJSON(),twist_amout:this._twist_amout,axis_x:this._twist_axis.x,axis_y:this._twist_axis.y,axis_z:this._twist_axis.z}}static fromJSON(t){var e=new Z;e.setTwistAmount(t.twist_amout),e.setTwistAxis(new L.Vector3(t.axis_x,t.axis_y,t.axis_z));for(var i=0;i<t.children.length;++i)e.addChild(W.fromJSON(t.children[i]));return e}setTwistAmount(t){this._twist_amout=t}setTwistAxis(t){this._twist_axis=t,this._computeTransforms()}_computeTransforms(){let t=Math.acos(this._twist_axis.dot(new L.Vector3(0,1,0)));if(Math.abs(t)>1e-4){let e=this._twist_axis.clone().cross(new L.Vector3(0,1,0));e.normalize(),this._twist_axis_mat.makeRotationAxis(e,t)}else this._twist_axis_mat.identity();this._twist_axis_mat_inv=this._twist_axis_mat.clone(),this._twist_axis_mat_inv.invert()}getType(){return Z.type}prepareForEval(){if(!this.valid_aabb){this.aabb=new L.Box3;for(var t=0;t<this.children.length;++t){var e=this.children[t];e.prepareForEval(),this.aabb.union(e.getAABB())}this.valid_aabb=!0}}value(t,e){var i=this.children.length,s=this.tmp_res;if(s.g=e.g?this.tmp_g:null,s.m=e.m?this.tmp_m:null,e.v=0,e.m&&e.m.copy(X.defaultMaterial),e.g?e.g.set(0,0,0):void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)&&0!==i){let o=new L.Vector3;this.aabb.getCenter(o);let h=new L.Vector3(t.x-o.x,t.y-o.y,t.z-o.z);h.applyMatrix4(this._twist_axis_mat);let a=Math.cos(this._twist_amout*h.y),n=Math.sin(this._twist_amout*h.y),c=new L.Vector3(a*h.x-n*h.z,h.y,n*h.x+a*h.z);c.applyMatrix4(this._twist_axis_mat_inv);let l=new L.Vector3(c.x+o.x,c.y+o.y,c.z+o.z);e.v=Number.MAX_VALUE;for(var r=0;r<i;++r)if(this.children[r].value(l,s),e.v=s.v,e.g&&e.g.copy(s.g),e.m&&e.m.copy(s.m),e.step||e.stepOrtho)throw"Not implemented"}else if(e.step||e.stepOrtho)throw"Not implemented"}trim(t,e,i){for(var s=0;s<this.children.length;s++)this.children[s].trim(t,e,i)}}W.register(Z.type,Z);var Y=Z;const Q=r.default,tt=a,et=g,it=b;class st extends et{static type="ScaleNode";constructor(t){if(super(),t){var e=this;t.forEach((function(t){e.addChild(t)}))}this.tmp_res={v:0,g:null,m:null},this.tmp_g=new Q.Vector3,this.tmp_m=new it,this._scale=new Q.Vector3(1,1,1)}toJSON(){return{...super.toJSON(),scale_x:this._scale.x,scale_y:this._scale.y,scale_z:this._scale.z}}static fromJSON(t){var e=new st;e.setScale(new Q.Vector3(t.scale_x,t.scale_y,t.scale_z));for(var i=0;i<t.children.length;++i)e.addChild(tt.fromJSON(t.children[i]));return e}setScale(t){this._scale=t,this.invalidAABB()}getType(){return st.type}prepareForEval(){if(!this.valid_aabb){this.aabb=new Q.Box3;for(var t=0;t<this.children.length;++t){var e=this.children[t];e.prepareForEval(),this.aabb.union(e.getAABB())}let i=new Q.Vector3;this.aabb.clone().getSize(i);let s=i.x*(this._scale.x-1),r=i.y*(this._scale.y-1),o=i.z*(this._scale.z-1);this.aabb.expandByVector(new Q.Vector3(s,r,o)),this.valid_aabb=!0}}computeAABB(){this.aabb.makeEmpty();for(var t=0;t<this.children.length;t++)this.children[t].computeAABB(),this.aabb.union(this.children[t].getAABB());let e=new Q.Vector3;this.aabb.clone().getSize(e);let i=e.x*(this._scale.x-1),s=e.y*(this._scale.y-1),r=e.z*(this._scale.z-1);this.aabb.expandByVector(new Q.Vector3(i,s,r))}value(t,e){var i=this.children.length,s=this.tmp_res;if(s.g=e.g?this.tmp_g:null,s.m=e.m?this.tmp_m:null,e.v=0,e.m&&e.m.copy(it.defaultMaterial),e.g?e.g.set(0,0,0):void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)&&0!==i){let o=new Q.Vector3;this.aabb.getCenter(o);let h=new Q.Vector3((t.x-o.x)/this._scale.x+o.x,(t.y-o.y)/this._scale.y+o.y,(t.z-o.z)/this._scale.z+o.z);e.v=Number.MAX_VALUE;for(var r=0;r<i;++r)if(this.children[r].value(h,s),e.v=s.v,e.g&&e.g.copy(s.g),e.m&&e.m.copy(s.m),e.step||e.stepOrtho)throw"Not implemented"}else if(e.step||e.stepOrtho)throw"Not implemented"}trim(t,e,i){for(var s=0;s<this.children.length;s++)this.children[s].trim(t,e,i)}}tt.register(st.type,st);var rt=st;const ot=u,ht=a;class at extends ot{static type="Primitive";static fromJSON(t){throw new Error("Primitibe.fromJSON should never be called as Primitibe is abstract.")}constructor(){super(),this.materials=[]}toJSON(){var t={...super.toJSON(),materials:[]};t.materials=[];for(var e=0;e<this.materials.length;++e)t.materials.push(this.materials[e].toJSON());return t}setMaterials(t){if(t.length!==this.materials.length)throw"Error : trying to set "+t.length+" materials on a primitive with only "+this.materials.length;for(var e=0;e<t.length;++e)t[e].equals(this.materials[e])||(this.materials[e].copy(t[e]),this.invalidAABB())}getMaterials=function(){return this.materials};computeAABB(){throw"Primitive.computeAABB  Must be reimplemented in all inherited class."}destroy(){null!==this.parentNode&&this.parentNode.removeChild(this)}getAreas(){return console.error("ERROR : getAreas is an abstract function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"),[]}computeHelpVariables(){throw"ERROR : computeHelpVariables is a virtual function, should be re-implemented in all primitives(error occured in "+this.getType()+" primitive)"}count(t){return this instanceof t?1:0}}ht.register(at.type,at);var nt=at;let ct=1/4,lt=function(t,e,i){if(t%2!=0)throw"degree should be even";if(i<e){var s=1-i*i/(e*e);return Math.pow(s,t/2)}return 0},pt=function(t,e,i){if(t%2!=0)throw"degree should be even";if(i<e){for(var s=1-i*i/(e*e),r=2*e*Math.sqrt(s),o=0;o!=t;)r*=(o+=2)/(1+o)*s;return r}return 0},ut=function(t,e,i){if(i<e){var s=t+2,r=1-i*i/(e*e);return 2*Math.PI/s*e*e*Math.pow(r,.5*s)}return 0};var mt={KS:2,KIS:.5,KS2:4,KIS2:ct,Poly6Eval:function(t){var e=1-ct*t*t;return e>0?e*e*e:0},Poly6EvalSq:function(t){var e=1-ct*t;return e>0?e*e*e:0},GetIsoValueAtDistanceGeom0D:lt,Poly4NF0D:1/lt(4,2,1),Poly6NF0D:1/lt(6,2,1),GetIsoValueAtDistanceGeom1D:pt,Poly4NF1D:1/pt(4,2,1),Poly6NF1D:1/pt(6,2,1),GetIsoValueAtDistanceGeom2D:ut,Poly4NF2D:1/ut(4,2,1),Poly6NF2D:1/ut(6,2,1)};const vt=a,_t=nt;class gt extends _t{static type="ScalisPrimitive";static DIST="dist";static CONVOL="convol";constructor(){super(),this.volType=gt.DIST,this.v=[]}getType(){return gt.type}toJSON(){var t={...super.toJSON(),v:[],volType:this.volType};t.v=[],t.volType=this.volType;for(var e=0;e<this.v.length;++e)t.v.push(this.v[e].toJSON());return t}mutableVolType(){return!1}setVolType(t){t!==this.volType&&(this.volType=t,this.invalidAABB())}getVolType(){return this.volType}computeAABB(){this.aabb.makeEmpty();for(var t=0;t<this.v.length;t++)this.aabb.union(this.v[t].getAABB())}}vt.register(gt.type,gt);var dt=gt;const yt=r.default,bt=mt;var ft=0;class wt{static fromJSON(t){return new wt(new yt.Vector3(t.position.x,t.position.y,t.position.z),t.thickness)}constructor(t,e){this.pos=t.clone(),this.thickness=e,this.id=ft++,this.prim=null,this.aabb=new yt.Box3,this.valid_aabb=!1}setPrimitive(t){null===this.prim&&(this.prim=t)}toJSON(){return{position:{x:this.pos.x,y:this.pos.y,z:this.pos.z},thickness:this.thickness}}setPos(t){this.valid_aabb=!1,this.pos.copy(t),this.prim.invalidAABB()}setThickness(t){this.valid_aabb=!1,this.thickness=t,this.prim.invalidAABB()}setAll(t,e){this.valid_aabb=!1,this.pos=t,this.thickness=e,this.prim.invalidAABB()}getPos(){return this.pos}getThickness(){return this.thickness}getAABB(){return this.valid_aabb||(this.computeAABB(),this.valid_aabb=!0),this.aabb}computeAABB(){var t=this.getPos(),e=this.getThickness()*bt.KS;this.aabb.set(new yt.Vector3(t.x-e,t.y-e,t.z-e),new yt.Vector3(t.x+e,t.y+e,t.z+e))}equals(t){return this.pos.equals(t.pos)&&this.thickness===t.thickness}}var xt=wt;var Vt=class{sphereIntersect(t){throw"Error : sphereIntersect is abstract, should have been overwritten"}contains(t){throw"Error : contains is abstract, should have been overwritten"}getAcc(t,e){throw"Error : getAcc is abstract, should have been overwritten"}getNiceAcc(t){throw"Error : getNiceAcc is abstract, should have been overwritten"}getCurrAcc(t){throw"Error : getCurrAcc is abstract, should have been overwritten"}getRawAcc(t){throw"Error : getRawAcc is abstract, should have been overwritten"}getMinAcc(){throw"Error : getRawAcc is abstract, should have been overwritten"}getMinRawAcc(){throw"Error : getRawAcc is abstract, should have been overwritten"}getAxisProjectionMinStep(t,e){return console.error("Area.getAxisProjectionMinStep is a pure virtual function, please reimplement"),1}},St={nice:.3,raw:1,curr:.3};const At=r.default,Mt=Vt,Tt=St;var Bt=class extends Mt{constructor(t,e,i){super(),this.p=new At.Vector3(t.x,t.y,t.z),this.r=e,this.accFactor=i||1}sphereIntersect=function(){var t=new At.Vector3;return e=>{t.subVectors(e.center,this.p);var i=e.radius+this.r;return t.lengthSq()<i*i}}();contains=function(){var t=new At.Vector3;return e=>{let i=this;return t.subVectors(e,i.p),t.lengthSq()<i.r*i.r}}();getAcc(t,e){return this.r*e}getNiceAcc(t){return this.getAcc(t,Tt.nice*this.accFactor)}getCurrAcc(t){return this.getAcc(t,Tt.curr*this.accFactor)}getRawAcc(t){return this.getAcc(t,Tt.raw*this.accFactor)}getMinAcc(){return Tt.curr*this.r*this.accFactor}getMinRawAcc(){return Tt.raw*this.r*this.accFactor}getAxisProjectionMinStep(t,e){var i=1e8,s=e-this.p[t];return s<-2*this.r?i=Math.min(i,Math.max(Math.abs(s+this.r),Tt.curr*this.r*this.accFactor)):s<2*this.r&&(i=Math.min(i,Tt.curr*this.r*this.accFactor)),i}};const Nt=r.default,Pt=a,Ft=b,zt=dt,kt=xt,Dt=mt,Et=Bt;class Ot extends zt{static type="ScalisPoint";static fromJSON(t){var e=kt.fromJSON(t.v[0]),i=Ft.fromJSON(t.materials[0]);return new Ot(e,t.volType,t.density,i)}constructor(t,e,i,s){super(),this.v.push(t),this.v[0].setPrimitive(this),this.volType=e,this.density=i,this.materials.push(s),this.v_to_p=new Nt.Vector3}getType(){return Ot.type}toJSON(){return{...super.toJSON(),density:this.density}}setDensity(t){this.density=t,this.invalidAABB()}getDensity(){return this.density}setMaterial(t){this.materials[0].copy(t),this.invalidAABB()}computeHelpVariables(){this.computeAABB()}prepareForEval(){this.valid_aabb||(this.computeHelpVariables(),this.valid_aabb=!0)}getAreas(){return this.valid_aabb?[{aabb:this.aabb,bv:new Et(this.v[0].getPos(),Dt.KS*this.v[0].getThickness(),Dt.KIS),obj:this}]:(console.error("ERROR : Cannot get area of invalid primitive"),[])}heuristicStepWithin(){return this.v[0].getThickness()/3}value(t,e){if(!this.valid_aabb)throw"Error : PrepareForEval should have been called";var i=this.v[0].getThickness();this.v_to_p.subVectors(t,this.v[0].getPos());var s=this.v_to_p.lengthSq()/(i*i),r=1-Dt.KIS2*s;if(r>0){if(e.v=this.density*r*r*r*Dt.Poly6NF0D,e.g){var o=-this.density*Dt.KIS2*6*this.v_to_p.length()*r*r*Dt.Poly6NF0D/(i*i);e.g.copy(this.v_to_p).normalize().multiplyScalar(o)}e.m&&e.m.copy(this.materials[0])}else e.v=0,e.g&&e.g.set(0,0,0),e.m&&e.m.copy(Ft.defaultMaterial)}distanceTo(t){return t.distanceTo(this.v[0].getPos())}}Pt.register(Ot.type,Ot);var Rt=Ot;const Ct=r.default,qt=mt,Jt=Vt,jt=St;var It=class extends Jt{constructor(t,e,i,s){super(),this.p0=new Ct.Vector3(t.x,t.y,t.z),this.p1=new Ct.Vector3(e.x,e.y,e.z),this.thick0=i,this.thick1=s,this.unit_dir=(new Ct.Vector3).subVectors(e,t),this.length=this.unit_dir.length(),this.unit_dir.normalize(),this.vector=new Ct.Vector3,this.p0_to_p=this.vector,this.p0_to_p_sqrnorm=0,this.x_p_2D=0,this.y_p_2D=0,this.y_p_2DSq=0,this.ortho_vec_x=this.thick0-this.thick1,this.ortho_vec_y=this.length,this.p_proj_x=0,this.p_proj_y=0,this.abs_diff_thick=Math.abs(this.ortho_vec_x)}proj_computation(t){this.p0_to_p=this.vector,this.p0_to_p.subVectors(t,this.p0),this.p0_to_p_sqrnorm=this.p0_to_p.lengthSq(),this.x_p_2D=this.p0_to_p.dot(this.unit_dir),this.y_p_2DSq=this.p0_to_p_sqrnorm-this.x_p_2D*this.x_p_2D,this.y_p_2D=this.y_p_2DSq>0?Math.sqrt(this.y_p_2DSq):0;var e=-this.y_p_2D/this.ortho_vec_y;this.p_proj_x=this.x_p_2D+e*this.ortho_vec_x,this.p_proj_y=0}sphereIntersect(t){if(this.proj_computation(t.center),this.p_proj_x<0)return Math.sqrt(this.p0_to_p_sqrnorm)-t.radius<this.thick0*qt.KS;if(this.p_proj_x>this.length)return this.vector.subVectors(t.center,this.p1),Math.sqrt(this.vector.lengthSq())-t.radius<this.thick1*qt.KS;var e=this.x_p_2D-this.p_proj_x,i=e*e+this.y_p_2DSq,s=this.p_proj_x/this.length,r=this.thick0*(1-s)+s*this.thick1,o=t.radius+r*qt.KS;return i<o*o}contains(t){if(this.proj_computation(t),this.p_proj_x<0)return this.p0_to_p_sqrnorm<this.thick0*this.thick0*qt.KS2;if(this.p_proj_x>this.length)return this.vector.subVectors(t,this.p1),this.vector.lengthSq()<this.thick1*this.thick1*qt.KS2;var e=this.x_p_2D-this.p_proj_x,i=this.y_p_2D-this.p_proj_y,s=e*e+i*i,r=this.p_proj_x/this.length,o=this.thick0*(1-r)+r*this.thick1;return s<o*o*qt.KS2}getAcc(t,e){this.proj_computation(t.center);var i=this.abs_diff_thick/this.length,s=t.radius*Math.sqrt(1+i*i)*.5,r=this.p_proj_x;if((r+=this.thick0>this.thick1?s:-s)<0)return this.thick0*e;if(r>this.length)return this.thick1*e;var o=r/this.length;return(this.thick0*(1-o)+o*this.thick1)*e}getNiceAcc(t){return this.getAcc(t,jt.nice)}getCurrAcc=function(t){return this.getAcc(t,jt.curr)};getRawAcc(t){return this.getAcc(t,jt.raw)}getMinAcc(){return jt.curr*Math.min(this.thick0,this.thick1)}getMinRawAcc(){return jt.raw*Math.min(this.thick0,this.thick1)}getAxisProjectionMinStep(t,e){var i,s,r,o=Number.MAX_VALUE,h=this.p0[t]<this.p1[t]?this.p0:this.p1;h===this.p0?(i=this.p1,s=this.thick0,r=this.thick1):(i=this.p0,s=this.thick1,r=this.thick0);var a=e-h[t];a<-2*s?o=Math.min(o,Math.max(Math.abs(a+2*s),jt.curr*s)):a<2*s&&(o=Math.min(o,jt.curr*s)),(a=e-i[t])<-2*r?o=Math.min(o,Math.max(Math.abs(a+2*r),jt.curr*r)):a<2*r&&(o=Math.min(o,jt.curr*r));var n=e-h[t],c=i[t]-h[t];return n>0&&n<c&&0!==c&&(o=Math.min(o,jt.curr*(s+n/c*(r-s)))),o}};const Kt=r.default,Gt=a,Ht=b,Ut=dt,Lt=xt,Wt=mt,$t=It;class Xt extends Ut{static type="ScalisSegment";static fromJSON(t){var e=Lt.fromJSON(t.v[0]),i=Lt.fromJSON(t.v[1]),s=[Ht.fromJSON(t.materials[0]),Ht.fromJSON(t.materials[1])];return new Xt(e,i,t.volType,t.density,s)}constructor(t,e,i,s,r){super(),this.v.length=2,this.v[0]=t,this.v[1]=e,t.setPrimitive(this),e.setPrimitive(this),this.volType=i,this.density=s,this.materials=r,this.clipped_l1=1,this.clipped_l2=0,this.vector=new Kt.Vector3,this.cycle=new Kt.Vector3,this.proj=new Kt.Vector3,this.v0_p=this.v[0].getPos(),this.v1_p=this.v[1].getPos(),this.dir=new Kt.Vector3,this.lengthSq=0,this.length=0,this.unit_dir=new Kt.Vector3,this.weight_p1=0,this.c0=0,this.c1=0,this.increase_unit_dir=new Kt.Vector3,this.p_min=new Kt.Vector3,this.weight_min=0,this.inv_weight_min=0,this.unit_delta_weight=0,this.maxbound=0,this.maxboundSq=0,this.cyl_bd0=0,this.cyl_bd1=0,this.f0f1f2=new Kt.Vector3,this.tmpVec1=new Kt.Vector3,this.tmpVec2=new Kt.Vector3,this.computeHelpVariables()}getType(){return Xt.type}toJSON(){return{...super.toJSON(),density:this.density}}mutableVolType(){return!0}setDensity(t){this.density=t,this.invalidAABB()}getDensity(){return this.density}setVolType(t){if(t!=Ut.CONVOL&&t!=Ut.DIST)throw"ERROR : volType must be set to ScalisPrimitive.CONVOL or ScalisPrimitive.DIST";this.volType!=t&&(this.volType=t,this.invalidAABB())}getVolType(){return this.volType}prepareForEval(){this.valid_aabb||(this.computeHelpVariables(),this.valid_aabb=!0)}getAreas(){return this.valid_aabb?[{aabb:this.aabb,bv:new $t(this.v[0].getPos(),this.v[1].getPos(),this.v[0].getThickness(),this.v[1].getThickness()),obj:this}]:(console.error("ERROR : Cannot get area of invalid primitive"),[])}computeHelpVariables(){this.v0_p=this.v[0].getPos(),this.v1_p=this.v[1].getPos(),this.dir.subVectors(this.v1_p,this.v0_p),this.lengthSq=this.dir.lengthSq(),this.length=Math.sqrt(this.lengthSq),this.unit_dir.copy(this.dir).normalize(),this.weight_p1=this.v[1].getThickness(),this.c0=this.v[0].getThickness(),this.c1=this.v[1].getThickness()-this.v[0].getThickness();var t=this.v[0].getThickness()*Wt.KS,e=this.v[1].getThickness()*Wt.KS;this.maxbound=Math.max(t,e),this.maxboundSq=this.maxbound*this.maxbound,this.cyl_bd0=Math.min(-t,this.length-e),this.cyl_bd1=Math.max(this.length+e,t),this.increase_unit_dir.copy(this.unit_dir),this.c1<0?(this.p_min.copy(this.v1_p),this.weight_min=this.weight_p1,this.inv_weight_min=1/this.weight_p1,this.increase_unit_dir.negate(),this.unit_delta_weight=-this.c1/this.length):(this.p_min.copy(this.v0_p),this.weight_min=this.c0,this.inv_weight_min=1/this.c0,this.unit_delta_weight=this.c1/this.length),this.computeAABB()}value(t,e){switch(this.volType){case Ut.DIST:this.evalDist(t,e);break;case Ut.CONVOL:this.evalConvol(t,e);break;default:throw"Unknown volType, cannot evaluate."}}evalDist=function(){var t={v:0},e=new Kt.Vector3;return function(i,s){var r=this.vector;r.subVectors(i,this.v[0].getPos());var o=r.dot(this.dir),h=r.lengthSq(),a=this.lengthSq*this.c0+o*this.c1,n=this.c1<0?0:1;a>0&&(n=(n=o*this.c0+h*this.c1)<0?0:n>a?1:n/a);var c=Math.sqrt(n*(n*this.lengthSq-2*o)+h),l=this.c0+n*this.c1;if(s.v=this.density*Wt.Poly6Eval(c/l)*Wt.Poly6NF0D,s.m&&this.evalMat(i,s),s.g){var p=1e-5,u=this.density/p;e.copy(i),e.x+=p,this.evalDist(e,t),s.g.x=u*(t.v-s.v),e.x-=p,e.y+=p,this.evalDist(e,t),s.g.y=u*(t.v-s.v),e.y-=p,e.z+=p,this.evalDist(e,t),s.g.z=u*(t.v-s.v)}}}();evalMat(t,e){var i=this.vector;i.subVectors(t,this.v[0].getPos());var s=this.unit_dir.dot(i)/this.length;s>1?e.m.copy(this.materials[1]):s<=0?e.m.copy(this.materials[0]):(e.m.copy(this.materials[0]),e.m.lerp(this.materials[1],s))}HomotheticClippingSpecial(t){var e=-t.z,i=-t.y,s=-t.x,r=i*i-e*s;if(r>=0){var o=i+Math.sqrt(r);if(o<0||this.length*o<s)return!1;var h=s/o;this.clipped_l1=h<0?0:h;var a=e*h;return this.clipped_l2=2*i<a+e*this.length?s/a:this.length,!0}return!1}heuristicStepWithin(){return this.weight_min/3}evalConvol(t,e){if(!this.valid_aabb)throw"Error : prepareForEval should have been called";e.g&&e.g.set(0,0,0),e.v=0;var i=this.tmpVec1;i.subVectors(t,this.p_min);var s=this.increase_unit_dir.dot(i),r=i.lengthSq(),o=this.tmpVec2;if(o.set(this.weight_min*this.weight_min-Wt.KIS2*r,-this.unit_delta_weight*this.weight_min-Wt.KIS2*s,this.unit_delta_weight*this.unit_delta_weight-Wt.KIS2),this.HomotheticClippingSpecial(o)){var h=1/(this.weight_min+this.clipped_l1*this.unit_delta_weight);o.x=1-Wt.KIS2*(this.clipped_l1*(this.clipped_l1-2*s)+r)*h*h,o.y=-this.unit_delta_weight-Wt.KIS2*(s-this.clipped_l1)*h,e.g?(this.unit_delta_weight>=.06?this.HomotheticCompactPolynomial_segment_FGradF_i6((this.clipped_l2-this.clipped_l1)*h,this.unit_delta_weight,o):this.HomotheticCompactPolynomial_approx_segment_FGradF_i6((this.clipped_l2-this.clipped_l1)*h,this.unit_delta_weight,this.inv_weight_min,o),e.v=Wt.Poly6NF1D*this.f0f1f2.x,this.f0f1f2.y*=h,e.g.copy(this.increase_unit_dir).multiplyScalar(this.f0f1f2.z+this.clipped_l1*this.f0f1f2.y).sub(i.multiplyScalar(this.f0f1f2.y)).multiplyScalar(6*Wt.Poly6NF1D*Wt.KIS2*h)):this.unit_delta_weight>=.06?e.v=Wt.Poly6NF1D*this.HomotheticCompactPolynomial_segment_F_i6((this.clipped_l2-this.clipped_l1)*h,this.unit_delta_weight,o):e.v=Wt.Poly6NF1D*this.HomotheticCompactPolynomial_approx_segment_F_i6((this.clipped_l2-this.clipped_l1)*h,this.unit_delta_weight,h,o),e.m&&this.evalMat(t,e)}}clamp(t,e,i){return Math.max(e,Math.min(i,t))}distanceTo=function(){var t=new Kt.Vector3,e=new Kt.Vector3;return function(i){let s=this;var r=t.subVectors(i,s.v[0].getPos()).dot(s.dir)/s.lengthSq;return r=s.clamp(r,0,1),e.copy(s.dir).multiplyScalar(r).add(s.v[0].getPos()),i.distanceTo(e)}}();HomotheticCompactPolynomial_segment_F_i6(t,e,i){var s=e*t+1,r=1/s,o=s*s,h=1/(o*o),a=i.y,n=a*a,c=12*n,l=1/e,p=a*l,u=s*o,m=t*t,v=m*m,_=t*m,g=t*v,d=i.x,y=i.z,b=d*d,f=y*y,w=1/(u*u),x=r*h,V=1/u,S=1/o;return-f*(((((-(r-1)*l-t*S)*l-m*V)*l-_*h)*l-v*x)*l-g*w)*p+(-d*(w-1)*l/6-(-(x-1)*l/5-t*w)*p)*b+((d*c+3*y*b)*(.4*(-(h-1)*l/4-t*x)*l-m*w)+(3*f*d+y*c)*(.8*(3/4*(2/3*(-(S-1)*l/2-t*V)*l-m*h)*l-_*x)*l-v*w)+y*f*(1.2*(5/4*(4/3*(1.5*(2*(Math.log(s)*l-t*r)*l-m*S)*l-_*V)*l-v*h)*l-g*x)*l-_*_*w)+(-12*y*d-8*n)*(.6*((-(V-1)*l/3-t*h)*l/2-m*x)*l-_*w)*a)*l/6}HomotheticCompactPolynomial_approx_segment_F_i6(t,e,i,s){var r=i*e,o=r+1,h=1/o,a=o*o,n=h/(a*a)/a,c=s.z,l=s.y,p=s.x,u=t*t,m=c*u-2*l*t+p,v=c*p-l*l,_=c*t-l,g=p*p,d=l*g,y=m*m,b=_*y,f=1/c,w=v*f,x=6/35*(4/3*(2*v*t+_*m+l*p)*w+b+d)*w+m*b/7+p*d/7,V=f*x,S=h*n,A=y*y,M=l*V+A/8-g*g/8,T=-t*A+(-10*l*M+p*x)*f;return V-7*e*M*f+(-.1111111111*(3*n-3+7*(2+S)*r)*T-.1*(2-2*n-7*(1+S)*r)/i*(-1*u*A+(1.333333333*l*T+2*p*M)*f))*f/(i*i)}HomotheticCompactPolynomial_segment_FGradF_i6(t,e,i){var s=e*t+1,r=1/s,o=s*s,h=1/(o*o),a=i.y,n=a*a,c=2*n,l=i.z,p=i.x,u=l*p/3+2/3*n,m=l*l,v=m/6,_=-2/3*l,g=s*o,d=1/g,y=r*h,b=1/(g*g),f=t*t,w=1/e,x=t*f,V=.6*((-(d-1)*w/3-t*h)*w/2-f*y)*w-x*b,S=V*a,A=-(y-1)*w/5-t*b,M=p*p,T=M*A,B=.4*(-(h-1)*w/4-t*y)*w-f*b,N=p*B,P=-M*(b-1)/6,F=f*f,z=t*F,k=1/o,D=.8*(3/4*(2/3*(-(k-1)*w/2-t*d)*w-f*h)*w-x*y)*w-F*b,E=((((-(r-1)*w-t*k)*w-f*d)*w-x*h)*w-F*y)*w-z*b,O=x*x,R=Math.log(s);this.f0f1f2.x=(p*P-a*T+N*c-4/3*n*S+(M*B/2+D*c-2*p*S)*l+(p*D/2-a*E+(-O*b/6+(-z*y/5+(-F*h/4+(-x*d/3+(-f*k/2+(R*w-t*r)*w)*w)*w)*w)*w)*l)*m)*w,this.f0f1f2.y=(P+B*u+D*v+(-2/3*p*A+V*_)*a)*w,this.f0f1f2.z=(T/6+V*u+E*v+(-2/3*N+D*_)*a)*w}HomotheticCompactPolynomial_approx_segment_FGradF_i6(t,e,i,s){var r=i*e,o=r+1,h=1/o,a=1/(i*i),n=o*o,c=h/(n*n)/n,l=s.x,p=2*l,u=s.z,m=1/u,v=e*m,_=s.y,g=t*t,d=u*g-2*_*t+l,y=d*d,b=d*y,f=l*l,w=l*f,x=u*l-_*_,V=u*t-_,S=x*m,A=4/3*(2*x*t+V*d+_*l)*S+V*y+_*f,M=A/5,T=_*m*M+b/6-w/6,B=-t*b+(-8*_*T+l*M)*m,N=g*b,P=(10/7*_*B+T*p)*m-N,F=-P/8,z=6/35*A*S+V*b/7+_*w/7,k=h*c,D=(3*c-3+7*(2+k)*r)*a,E=(2-2*c-7*(1+k)*r)/i*a,O=m*D,R=m*E,C=m*z,q=y*y,J=_*C+q/8-f*f/8,j=-t*q+(-10*_*J+l*z)*m;this.f0f1f2.x=C-7*J*v-j*O/9-(-g*q+(4/3*_*j+J*p)*m)*R/10,this.f0f1f2.y=(M-7*e*T-B*D/7+E*F)*m,this.f0f1f2.z=T*m+B*v+O*F-(-t*N+(1.5*_*P-3/7*l*B)*m)*R/9}}Gt.register(Xt.type,Xt);var Zt=Xt;const Yt=r.default,Qt=b,te=1e-6,ee={};let ie=function(t,e){let i=t;if(0===e)throw new Error("Lenght of the array should not be 0");return 1===e?0:(t<0&&(i=(e+t)%e),t>=e&&(i=t%e),i)};ee.computeVectorsDirs=function(t){let e=t.v[0].getPos(),i=t.v[1].getPos(),s=t.v[2].getPos();t.p0p1.subVectors(i,e),t.p1p2.subVectors(s,i),t.p2p0.subVectors(e,s),t.unit_normal.crossVectors(t.p0p1,t.p2p0),t.unit_normal.normalize(),t.length_p0p1=t.p0p1.length(),t.unit_p0p1.copy(t.p0p1),t.unit_p0p1.divideScalar(t.length_p0p1),t.diffThick_p0p1=t.v[0].getThickness()-t.v[1].getThickness(),t.length_p1p2=t.p1p2.length(),t.unit_p1p2.copy(t.p1p2),t.unit_p1p2.divideScalar(t.length_p1p2),t.diffThick_p1p2=t.v[1].getThickness()-t.v[2].getThickness(),t.length_p2p0=t.p2p0.length(),t.unit_p2p0.copy(t.p2p0),t.unit_p2p0.divideScalar(t.length_p2p0),t.diffThick_p2p0=t.v[2].getThickness()-t.v[0].getThickness();let r=[];r.push({vert:t.v[0].getPos(),thick:t.v[0].getThickness(),idx:0}),r.push({vert:t.v[1].getPos(),thick:t.v[1].getThickness(),idx:1}),r.push({vert:t.v[2].getPos(),thick:t.v[2].getThickness(),idx:2}),r.sort((function(t,e){return t.thick-e.thick})),t.point_min=r[0].vert,t.weight_min=r[0].thick;let o=ie(r[0].idx+1,3),h=t.v[o].getPos(),a=t.v[o].getThickness();o=ie(r[0].idx+2,3);let n=t.v[o].getPos(),c=t.v[o].getThickness(),l=new Yt.Vector3;l=l.subVectors(h,t.point_min);let p=new Yt.Vector3;p=p.subVectors(n,t.point_min);let u=a-t.weight_min,m=c-t.weight_min;if(u<te||m<te){if(u<m){t.ortho_dir=l.clone(),t.ortho_dir.normalize(),t.main_dir.crossVectors(t.ortho_dir,t.unit_normal),t.main_dir.normalize(),t.main_dir.dot(p)<0&&t.main_dir.multiplyScalar(-1);let e=-t.weight_min/m;t.point_iso_zero=new Yt.Vector3(t.point_min.x+e*p.x,t.point_min.y+e*p.y,t.point_min.z+e*p.z)}else{t.ortho_dir=p.clone(),t.ortho_dir.normalize(),t.main_dir.crossVectors(t.ortho_dir,t.unit_normal),t.main_dir.normalize(),t.main_dir.dot(l)<0&&t.main_dir.multiplyScalar(-1);let e=-t.weight_min/u;t.point_iso_zero=new Yt.Vector3(t.point_min.x+e*l.x,t.point_min.y+e*l.y,t.point_min.z+e*l.z)}Math.abs(u-m)<te&&(t.proj_dir=t.unit_normal.clone().multiplyScalar(-1),t.equal_weights=!0)}else{let e=-t.weight_min/u,i=new Yt.Vector3(t.point_min.x+e*l.x,t.point_min.y+e*l.y,t.point_min.z+e*l.z);t.point_iso_zero=i;let s=-t.weight_min/m,r=new Yt.Vector3(t.point_min.x+s*p.x,t.point_min.y+s*p.y,t.point_min.z+s*p.z);t.ortho_dir.subVectors(r,i),t.ortho_dir.normalize(),t.main_dir.crossVectors(t.ortho_dir,t.unit_normal),t.main_dir.normalize(),(t.main_dir.dot(l)<0||t.main_dir.dot(p)<0)&&t.main_dir.multiplyScalar(-1)}let v=l.dot(t.main_dir),_=p.dot(t.main_dir);v=v<0?0:v,_=_<0?0:_;let g=null;v>_?(g=l,t.half_dir_1=p,t.point_half=n,t.half_dir_2=h.clone().subVectors(h,n),t.coord_max=v,t.coord_middle=_/v*t.coord_max,t.unit_delta_weight=u/t.coord_max):(g=p,t.half_dir_1=l,t.point_half=h,t.half_dir_2=n.clone().subVectors(n,h),t.coord_max=_,t.coord_middle=v/_*t.coord_max,t.unit_delta_weight=m/t.coord_max),t.longest_dir_special=g.divideScalar(t.coord_max);let d=new Yt.Vector3;d.subVectors(t.half_dir_1,t.longest_dir_special.clone().multiplyScalar(t.coord_middle)),t.max_seg_length=d.length(),t.unsigned_ortho_dir=t.ortho_dir.clone(),t.ortho_dir.dot(d)<0&&t.ortho_dir.multiplyScalar(-1)},ee.getParametrisedVertexAttr=function(t,e,i){let s=ee.getMeanThick(t,e,i),r=new Yt.Vector3,o=r.subVectors(t.v[1].getPos(),t.v[0].getPos()).multiplyScalar(e),h=r.clone().subVectors(t.v[2].getPos(),t.v[0].getPos()).multiplyScalar(i);return r.addVectors(t.v[0].getPos(),o),r.addVectors(r,h),{pos:r,thick:s}},ee.getMeanThick=function(t,e,i){return t.v[0].getThickness()*(1-e-i)+t.v[1].getThickness()*e+t.v[2].getThickness()*i},ee.getMeanMat=function(t,e,i){let s=new Qt,r=null===t.materials?[t.v[0].getMaterial(),t.v[0].getMaterial(),t.v[0].getMaterial()]:[t.materials[0],t.materials[1],t.materials[2]];return s.weightedMean(r,[1-e-i,e,i]),s},ee.getTriBaryCoord=function(t,e,i,s){let r=t,o=e.clone().multiplyScalar(-1),h=(new Yt.Vector3).subVectors(s,i),a=r.lengthSq(),n=r.dot(o),c=h.dot(r),l=o.lengthSq(),p=(a*h.dot(o)-n*c)/(a*l-n*n);return{u:(c-p*n)/a,v:p}},ee.getUVCoord=function(t,e,i,s){let r=new Yt.Vector3;r.crossVectors(t,e);let o=new Yt.Matrix4;o.set(t.x,e.x,r.x,0,t.y,e.y,r.y,0,t.z,e.z,r.z,0,0,0,0,1);let h=new Yt.Matrix4;h.copy(o).invert();let a=(new Yt.Vector3).subVectors(s,i);return a.applyMatrix4(h),{u:a.x,v:a.y}};var se=ee;const re=r.default,oe=mt,he=Vt,ae=se,ne=St,ce=It;var le=class extends he{constructor(t,e,i,s,r,o){super(),this.tmpVect=new re.Vector3,this.min_thick=r,this.max_thick=o,this.v=t,this.p0p1=this.tmpVect.clone().subVectors(this.v[1].getPos(),this.v[0].getPos()),this.p2p0=this.tmpVect.clone().subVectors(this.v[0].getPos(),this.v[2].getPos()),this.unit_normal=e,this.main_dir=i;var h=Math.abs(this.v[0].getThickness()-this.v[1].getThickness()),a=Math.abs(this.v[1].getThickness()-this.v[2].getThickness());this.equal_weights=h/Math.abs(this.v[0].getThickness()+this.v[1].getThickness())<.001&&a/Math.abs(this.v[1].getThickness()+this.v[2].getThickness())<.001,this.segParams=s,this.segAttr={p0_to_p:new re.Vector3,p0_to_p_sqrnorm:0,x_p_2D:0,y_p_2D:0,y_p_2DSq:0,p_proj_x:0};var n=this.tmpVect.clone().crossVectors(this.segParams[0].dir,this.unit_normal).normalize(),c=this.tmpVect.clone().crossVectors(this.segParams[1].dir,this.unit_normal).normalize(),l=this.tmpVect.clone().crossVectors(this.segParams[2].dir,this.unit_normal).normalize();this.tmpVect.copy(this.unit_normal);var p=[];p.push(this.tmpVect.clone().addVectors(this.v[0].getPos(),this.tmpVect.multiplyScalar(this.v[0].getThickness()*oe.KS))),this.tmpVect.copy(this.unit_normal),p.push(this.tmpVect.clone().addVectors(this.v[1].getPos(),this.tmpVect.multiplyScalar(this.v[1].getThickness()*oe.KS))),this.tmpVect.copy(this.unit_normal),p.push(this.tmpVect.clone().addVectors(this.v[2].getPos(),this.tmpVect.multiplyScalar(this.v[2].getThickness()*oe.KS))),this.tmpVect.copy(this.unit_normal),p.push(this.tmpVect.clone().addVectors(this.v[0].getPos(),this.tmpVect.multiplyScalar(-this.v[0].getThickness()*oe.KS))),this.tmpVect.copy(this.unit_normal),p.push(this.tmpVect.clone().addVectors(this.v[1].getPos(),this.tmpVect.multiplyScalar(-this.v[1].getThickness()*oe.KS))),this.tmpVect.copy(this.unit_normal),p.push(this.tmpVect.clone().addVectors(this.v[2].getPos(),this.tmpVect.multiplyScalar(-this.v[2].getThickness()*oe.KS)));var u=new re.Vector3;this.tmpVect.subVectors(p[1],p[0]),u.subVectors(p[2],p[0]);var m=this.tmpVect.clone().crossVectors(this.tmpVect,u).normalize();this.tmpVect.subVectors(p[5],p[3]),u.subVectors(p[4],p[3]);var v=this.tmpVect.clone().crossVectors(this.tmpVect,u).normalize();this.planeParams=[],this.planeParams.push({orig:this.v[0].getPos(),n:n}),this.planeParams.push({orig:this.v[1].getPos(),n:c}),this.planeParams.push({orig:this.v[2].getPos(),n:l}),this.planeParams.push({orig:p[0],n:m}),this.planeParams.push({orig:p[3],n:v}),this.segAreas=[];for(var _=0;_<3;++_)this.segAreas.push(new ce(this.segParams[_].v[0].getPos(),this.segParams[_].v[1].getPos(),this.segParams[_].v[0].getThickness(),this.segParams[_].v[1].getThickness()))}proj_computation(t,e){this.segAttr.p0_to_p.subVectors(t,e.v[0].getPos()),this.segAttr.p0_to_p_sqrnorm=this.segAttr.p0_to_p.lengthSq(),this.segAttr.x_p_2D=this.segAttr.p0_to_p.dot(e.dir),this.segAttr.y_p_2DSq=this.segAttr.p0_to_p_sqrnorm-this.segAttr.x_p_2D*this.segAttr.x_p_2D,this.segAttr.y_p_2D=this.segAttr.y_p_2DSq>0?Math.sqrt(this.segAttr.y_p_2DSq):0;var i=-this.segAttr.y_p_2D/e.ortho_vec_y;this.segAttr.p_proj_x=this.segAttr.x_p_2D+i*e.ortho_vec_x}sphereIntersect(t){for(let e=0;e<3;e++){if(this.sphereIntersectSegment(t,this.segParams[e],oe.KS))return!0}for(let e=0,i=!0;e<5;e++){this.tmpVect.subVectors(t.center,this.planeParams[e].orig);let s=this.tmpVect.dot(this.planeParams[e].n);i=i&&s+t.radius>0}return!0}sphereIntersectSegment(t,e,i){this.proj_computation(t.center,e);var s=e.v[0].getThickness(),r=e.v[1].getThickness();if(this.segAttr.p_proj_x<0)return Math.sqrt(this.segAttr.p0_to_p_sqrnorm)-t.radius<s*i;if(this.segAttr.p_proj_x>e.norm)return this.segAttr.p0_to_p.subVectors(t.center,e.v[1].getPos()),this.segAttr.p0_to_p.length()-t.radius<r*i;var o=this.segAttr.x_p_2D-this.segAttr.p_proj_x,h=o*o+this.segAttr.y_p_2DSq,a=this.segAttr.p_proj_x/e.norm,n=s*(1-a)+a*r,c=t.radius+n*i;return h<c*c}contains=function(){let t={radius:0,center:new re.Vector3};return e=>(t.center.copy(e),this.sphereIntersect(t))}();getAccSegment(t,e){var i={intersect:!1,currAcc:ne.nice*this.min_thick};if(this.sphereIntersectSegment(t,e,1)){var s=Math.abs(e.diffThick)/e.norm,r=t.radius*Math.sqrt(1+s*s)*.5,o=e.v[0].getThickness(),h=e.v[1].getThickness(),a=this.segAttr.p_proj_x;if((a+=o>h?r:-r)<=0)i.currAcc=o;else if(a>=e.norm)i.currAcc=h;else{var n=a/e.norm;i.currAcc=o*(1-n)+n*h}i.intersect=!0}return i}getAccTri(t){if(this.equal_weights)return this.min_thick;var e=this.v[0].getPos(),i=this.tmpVect.addVectors(t.center,this.main_dir.clone().multiplyScalar(t.radius));this.tmpVect.subVectors(i,e);var s=this.tmpVect.lengthSq(),r=this.tmpVect.dot(this.unit_normal),o=Math.sqrt(s-r*r),h=this.tmpVect.clone().addVectors(t.center,this.unit_normal.clone().multiplyScalar(-r)),a=ae.getTriBaryCoord(this.p0p1,this.p2p0,this.v[0].getPos(),h),n=ae.getMeanThick(this,a.u,a.v);n=r>=0?n:-n;var c=o+-r/o*(this.v[0].getThickness()-n),l=this.tmpVect.subVectors(e,h).normalize(),p=this.tmpVect.addVectors(h,l.multiplyScalar(o-c));return(a=ae.getTriBaryCoord(this.p0p1,this.p2p0,this.v[0].getPos(),p)).u<=1&&a.v<=1&&a.u+a.v<=1&&a.u>=0&&a.v>=0?ae.getMeanThick(this,a.u,a.v):1e4*this.max_thick}getAcc(t,e){for(var i=0,s=1e5*this.max_thick;i<3;i++){var r=this.getAccSegment(t,this.segParams[i]);r.intersect&&(s=s>r.currAcc?r.currAcc:s)}var o=1e5*this.max_thick;s!==this.min_thick&&(o=this.getAccTri(t));var h=Math.min(s,o);return h!==1e5*this.max_thick?h*e:this.max_thick*e}getNiceAcc(t){return this.getAcc(t,ne.nice)}getCurrAcc(t){return this.getAcc(t,ne.curr)}getRawAcc(t){return this.getAcc(t,ne.raw)}getMinAcc(){return ne.curr*this.min_thick}getMinRawAcc=function(){return ne.raw*this.min_thick};getAxisProjectionMinStep(t,e){for(var i=Number.MAX_VALUE,s=0;s<3;++s)i=Math.min(i,this.segAreas[s].getAxisProjectionMinStep(t,e));return i}};const pe=r.default,ue=a,me=b,ve=dt,_e=xt,ge=mt,de=le,ye=se;class be extends ve{static type="ScalisTriangle";static fromJSON(t){var e=[_e.fromJSON(t.v[0]),_e.fromJSON(t.v[1]),_e.fromJSON(t.v[2])],i=[me.fromJSON(t.materials[0]),me.fromJSON(t.materials[1]),me.fromJSON(t.materials[2])];return new be(e,t.volType,1,i)}constructor(t,e,i,s){if(super(),1!==i)throw"Error in ScalisTriangle : cannot use a density different from 1.0, not implemented.";this.volType=e,this.materials=null!==s?s:[me.defaultMaterial.clone(),me.defaultMaterial.clone(),me.defaultMaterial.clone()],this.v=t,this.v[0].setPrimitive(this),this.v[1].setPrimitive(this),this.v[2].setPrimitive(this),this.min_thick=Math.min(this.v[0].getThickness(),this.v[1].getThickness(),this.v[2].getThickness()),this.max_thick=Math.max(this.v[0].getThickness(),this.v[1].getThickness(),this.v[2].getThickness()),this.res_gseg={},this.tmp_res_gseg={},this.p0p1=new pe.Vector3,this.p1p2=new pe.Vector3,this.p2p0=new pe.Vector3,this.unit_normal=new pe.Vector3,this.unit_p0p1=new pe.Vector3,this.unit_p1p2=new pe.Vector3,this.unit_p2p0=new pe.Vector3,this.length_p0p1=0,this.length_p1p2=0,this.length_p2p0=0,this.diffThick_p0p1=0,this.diffThick_p0p1=0,this.diffThick_p0p1=0,this.diffThick_p1p2=0,this.diffThick_p2p0=0,this.main_dir=new pe.Vector3,this.point_iso_zero=new pe.Vector3,this.ortho_dir=new pe.Vector3,this.unsigned_ortho_dir=new pe.Vector3,this.proj_dir=new pe.Vector3,this.equal_weights=!1,this.coord_max=0,this.coord_middle=0,this.unit_delta_weight=0,this.longest_dir_special=new pe.Vector3,this.max_seg_length=0,this.half_dir_1=new pe.Vector3,this.point_half=new pe.Vector3,this.half_dir_2=new pe.Vector3,this.point_min=new pe.Vector3,this.weight_min=0,this.valid_aabb=!1}getType(){return be.type}toJSON(){return{...super.toJSON()}}prepareForEval(){this.valid_aabb||(this.computeHelpVariables(),this.valid_aabb=!0)}getAreas(){if(this.valid_aabb){var t=[];return t.push({norm:this.length_p0p1,diffThick:this.diffThick_p0p1,dir:this.unit_p0p1,v:[this.v[0],this.v[1]],ortho_vec_x:this.v[0].getThickness()-this.v[1].getThickness(),ortho_vec_y:this.length_p0p1}),t.push({norm:this.length_p1p2,diffThick:this.diffThick_p1p2,dir:this.unit_p1p2,v:[this.v[1],this.v[2]],ortho_vec_x:this.v[1].getThickness()-this.v[2].getThickness(),ortho_vec_y:this.length_p1p2}),t.push({norm:this.length_p2p0,diffThick:this.diffThick_p2p0,dir:this.unit_p2p0,v:[this.v[2],this.v[0]],ortho_vec_x:this.v[2].getThickness()-this.v[0].getThickness(),ortho_vec_y:this.length_p2p0}),[{aabb:this.aabb,bv:new de(this.v,this.unit_normal,this.main_dir,t,this.min_thick,this.max_thick),obj:this}]}return console.log("ERROR : Cannot get area of invalid primitive"),[]}computeHelpVariables(){ye.computeVectorsDirs(this),this.computeAABB()}mutableVolType(){return!0}setVolType(t){if(t!=ve.CONVOL&&t!=ve.DIST)throw"ERROR : volType must be set to ScalisPrimitive.CONVOL or ScalisPrimitive.DIST";this.volType!=t&&(this.volType=t,this.invalidAABB())}getVolType(){return this.volType}clamp(t,e,i){return Math.max(e,Math.min(i,t))}distanceTo=function(){var t=new pe.Vector3,e=new pe.Vector3,i=new pe.Vector3,s=new pe.Vector3;return function(r){let o=this;if(t.subVectors(r,o.v[0].getPos()),e.subVectors(r,o.v[1].getPos()),i.subVectors(r,o.v[2].getPos()),s.crossVectors(o.p0p1,t).dot(o.unit_normal)>0&&s.crossVectors(o.p1p2,e).dot(o.unit_normal)>0&&s.crossVectors(o.p2p0,i).dot(o.unit_normal)>0)return Math.abs(t.dot(o.unit_normal));var h=t.dot(o.p0p1)/o.length_p0p1;h=o.clamp(h,0,1),s.copy(o.p0p1).multiplyScalar(h).add(o.v[0].getPos()),h=r.distanceToSquared(s);var a=e.dot(o.p1p2)/o.length_p1p2;a=o.clamp(a,0,1),s.copy(o.p1p2).multiplyScalar(a).add(o.v[1].getPos()),a=r.distanceToSquared(s);var n=i.dot(o.p2p0)/o.length_p2p0;return n=o.clamp(n,0,1),s.copy(o.p2p0).multiplyScalar(n).add(o.v[2].getPos()),n=r.distanceToSquared(s),Math.sqrt(Math.min(Math.min(h,a),n))}}();heuristicStepWithin(){return this.weight_min/3}value(t,e){switch(this.volType){case ve.DIST:return this.evalDist(t,e);case ve.CONVOL:return this.evalConvol(t,e);default:throw"Unknown volType, use Orga"}}evalDist=function(){var t={v:0},e=new pe.Vector3;return function(i,s){let r=this;var o=new pe.Vector3;o.subVectors(i,r.v[0].getPos());var h=r.unit_normal.clone().multiplyScalar(-1);if(!r.equal_weights){var a=h,n=r.unsigned_ortho_dir,c=r.main_dir.clone().multiplyScalar(-1),l=-r.v[0].getPos().dot(a),p=-i.dot(n),u=-r.point_iso_zero.dot(c),m=new pe.Vector3;m.crossVectors(n,c),m.multiplyScalar(-l);var v=new pe.Vector3;v.crossVectors(c,a),v.multiplyScalar(-p);var _=new pe.Vector3;_.crossVectors(a,n),_.multiplyScalar(-u);var g=new pe.Vector3;g.crossVectors(n,c);var d=new pe.Vector3(m.x+v.x+_.x,m.y+v.y+_.y,m.z+v.z+_.z);d.divideScalar(a.dot(g));var y=new pe.Vector3(d.x-i.x,d.y-i.y,d.z-i.z);r.proj_dir=new pe.Vector3,r.proj_dir.crossVectors(y,r.unsigned_ortho_dir),r.proj_dir.normalize()}var b=new pe.Vector3;b.copy(r.proj_dir),b.multiplyScalar(-o.dot(h)/r.proj_dir.dot(h)),b.add(i);var f=new pe.Vector3,w=new pe.Vector3,x=new pe.Vector3,V=new pe.Vector3;if(w.subVectors(b,r.v[0].getPos()),x.subVectors(b,r.v[1].getPos()),V.subVectors(b,r.v[2].getPos()),f.crossVectors(r.unit_p0p1,w).dot(h)>0&&f.crossVectors(r.unit_p1p2,x).dot(h)>0&&f.crossVectors(r.unit_p2p0,V).dot(h)>0){f.subVectors(i,b),s.v=f.lengthSq();var S=r.v[0].getPos(),A=r.v[1].getPos(),M=r.v[2].getPos(),T=new pe.Vector3;f.subVectors(A,S),T.subVectors(M,S);var B=new pe.Vector3;B.crossVectors(f,T),f.subVectors(M,A);var N=new pe.Vector3;N.crossVectors(f,x),f.subVectors(S,M);var P=new pe.Vector3;P.crossVectors(f,V),f.subVectors(A,S);var F=new pe.Vector3;F.crossVectors(f,w);var z=B.lengthSq(),k=B.dot(N),D=B.dot(P),E=B.dot(F),O=(k*r.v[0].getThickness()+D*r.v[1].getThickness()+E*r.v[2].getThickness())/z;s.v=ge.Poly6Eval(Math.sqrt(s.v)/O)*ge.Poly6NF0D,s.m&&s.m.triMean(r.materials[0],r.materials[1],r.materials[2],k,D,E,z)}else{var R=0;if(r.GenericSegmentComputation(i,r.v[0].getPos(),r.p0p1,r.length_p0p1,r.length_p0p1*r.length_p0p1,r.v[0].getThickness(),r.v[1].getThickness()-r.v[0].getThickness(),r.res_gseg),r.res_gseg.sqrdist=r.res_gseg.proj_to_p.lengthSq(),r.res_gseg.ratio=r.res_gseg.sqrdist/(r.res_gseg.weight_proj*r.res_gseg.weight_proj),r.GenericSegmentComputation(i,r.v[1].getPos(),r.p1p2,r.length_p1p2,r.length_p1p2*r.length_p1p2,r.v[1].getThickness(),r.v[2].getThickness()-r.v[1].getThickness(),r.tmp_res_gseg),r.tmp_res_gseg.sqrdist=r.tmp_res_gseg.proj_to_p.lengthSq(),r.tmp_res_gseg.ratio=r.tmp_res_gseg.sqrdist/(r.tmp_res_gseg.weight_proj*r.tmp_res_gseg.weight_proj),r.res_gseg.ratio>r.tmp_res_gseg.ratio&&(r.res_gseg.sqrdist=r.tmp_res_gseg.sqrdist,r.res_gseg.proj_to_p=r.tmp_res_gseg.proj_to_p,r.res_gseg.weight_proj=r.tmp_res_gseg.weight_proj,r.res_gseg.ratio=r.tmp_res_gseg.ratio,r.res_gseg.t=r.tmp_res_gseg.t,R=1),r.GenericSegmentComputation(i,r.v[2].getPos(),r.p2p0,r.length_p2p0,r.length_p2p0*r.length_p2p0,r.v[2].getThickness(),r.v[0].getThickness()-r.v[2].getThickness(),r.tmp_res_gseg),r.tmp_res_gseg.sqrdist=r.tmp_res_gseg.proj_to_p.lengthSq(),r.tmp_res_gseg.ratio=r.tmp_res_gseg.sqrdist/(r.tmp_res_gseg.weight_proj*r.tmp_res_gseg.weight_proj),r.res_gseg.ratio>r.tmp_res_gseg.ratio&&(r.res_gseg.sqrdist=r.tmp_res_gseg.sqrdist,r.res_gseg.proj_to_p=r.tmp_res_gseg.proj_to_p,r.res_gseg.weight_proj=r.tmp_res_gseg.weight_proj,r.res_gseg.ratio=r.tmp_res_gseg.ratio,r.res_gseg.t=r.tmp_res_gseg.t,R=2),s.v=ge.Poly6Eval(Math.sqrt(r.res_gseg.sqrdist)/r.res_gseg.weight_proj)*ge.Poly6NF0D,s.m)switch(R){case 0:s.m.copy(r.materials[0]),s.m.lerp(r.materials[1],r.res_gseg.t);break;case 1:s.m.copy(r.materials[1]),s.m.lerp(r.materials[2],r.res_gseg.t);break;case 2:s.m.copy(r.materials[2]),s.m.lerp(r.materials[0],r.res_gseg.t);break;default:throw"Error : seg_case unknown"}}if(s.g){var C=1e-5;e.copy(i),e.x+=C,r.evalDist(e,t),s.g.x=(t.v-s.v)/C,e.x-=C,e.y+=C,r.evalDist(e,t),s.g.y=(t.v-s.v)/C,e.y-=C,e.z+=C,r.evalDist(e,t),s.g.z=(t.v-s.v)/C}}}();GenericSegmentComputation(t,e,i,s,r,o,h,a){var n=new pe.Vector3;n.subVectors(t,e);var c=n.dot(i),l=n.lengthSq(),p=r*o+c*h,u=h<0?0:1;return p>0&&(u=(u=(c*o+l*h)/p)<0?0:u>1?1:u),a.proj_to_p=new pe.Vector3(u*i.x-n.x,u*i.y-n.y,u*i.z-n.z),a.weight_proj=o+u*h,a.t=u,a}evalConvol=function(){var t=new pe.Vector3,e=new me,i={v:0,g:null,m:null},s=new pe.Vector3,r=new me,o={v:0,g:null,m:null};return function(h,a){let n=this;i.g=a.g?t:null,i.m=a.m?e:null;var c={l1:0,l2:0};if(n.ComputeTParam(h,c)){var l=c.l1,p=c.l2,u=n.weight_min+l*n.unit_delta_weight,m=n.warpAbscissa((p-l)/u),v=2*(5*m+1),_=m/v,g=_;_*=2;for(var d=0,y=new pe.Vector3,b=1;b<v;b+=2)n.computeLineIntegral(n.unwarpAbscissa(g)*u+l,h,i),d+=i.v,a.g&&y.addVectors(y,i.g),g+=_;var f=0,w=new pe.Vector3;g=0;for(var x=2;x<v;x+=2)g+=_,n.computeLineIntegral(n.unwarpAbscissa(g)*u+l,h,i),a.g&&w.addVectors(w,i.g),f+=i.v;o.g=a.g?s:null,o.m=a.m?r:null;var V=n.computeLineIntegral(l,h,i),S=n.computeLineIntegral(p,h,o);a.v=V.v+4*d+2*f+V.v;var A=m/(3*v)*ge.Poly6NF2D;if(a.v*=A,a.g){var M=new pe.Vector3;M.addVectors(M,V.g),M.addVectors(M,y.multiplyScalar(4)),M.addVectors(M,w.multiplyScalar(2)),M.addVectors(M,S.g),a.g=M.multiplyScalar(A)}}else a.v=0,a.g=new pe.Vector3;a.m&&(i.g=null,n.evalDist(h,i),a.m.copy(i.m))}}();warpAbscissa(t){var e=t*this.unit_delta_weight,i=1/(e+2),s=e*i;return 2*t*i*(1+(s*=s)*(1/3+s*(.2+s*(1/7+s*(1/9+s*(1/11+s*(1/13)))))))}unwarpAbscissa(t){var e=t*this.unit_delta_weight;return t*(1+e*(.5+e*(1/6+e*(1/24+e*(1/120+1*e/720)))))}computeLineIntegral(t,e,i){var s=this.weight_min+t*this.unit_delta_weight,r=new pe.Vector3;r.addVectors(this.point_min,this.longest_dir_special.clone().multiplyScalar(t));var o=t<this.coord_middle?t/this.coord_middle*this.max_seg_length:(this.coord_max-t)/(this.coord_max-this.coord_middle)*this.max_seg_length;return i.g?this.consWeightEvalGradForSeg(r,s,this.ortho_dir,o,e,i):this.consWeightEvalForSeg(r,s,this.ortho_dir,o,e,i),i}homotheticClippingSpecial(t,e,i){var s=-t.z,r=-t.y,o=-t.x,h=r*r-s*o;if(h>=0){var a=r+Math.sqrt(h);if(a<0||e*a<o)return!1;var n=o/a;i.l1=n<0?0:n;var c=s*n;return i.l2=2*r<c+s*e?o/c:e,!0}return!1}consWeightEvalForSeg(t,e,i,s,r,o){var h=new pe.Vector3;h.subVectors(r,t);var a=i.dot(h),n=h.lengthSq(),c=new pe.Vector3;c.set(e*e-ge.KIS2*n,-ge.KIS2*a,-ge.KIS2);var l={l1:0,l2:0};if(this.homotheticClippingSpecial(c,s,l)){var p=1/e;c.x=1-ge.KIS2*(l.l1*(l.l1-2*a)+n)*p*p,c.y=-ge.KIS2*(a-l.l1)*p,o.v=this.homotheticCompactPolynomial_segment_F_i6_cste((l.l2-l.l1)*p,c)}else o=0;return o}consWeightEvalGradForSeg(t,e,i,s,r,o){var h=new pe.Vector3;h.subVectors(r,t);var a=i.dot(h),n=h.lengthSq(),c=new pe.Vector3;c.set(e*e-ge.KIS2*n,-ge.KIS2*a,-ge.KIS2);var l={l1:0,l2:0};if(this.homotheticClippingSpecial(c,s,l)){var p=1/e;c.x=1-ge.KIS2*(l.l1*(l.l1-2*a)+n)*p*p,c.y=-ge.KIS2*(a-l.l1)*p;var u=new pe.Vector3;this.homotheticCompactPolynomial_segment_FGradF_i6_cste((l.l2-l.l1)*p,c,u),o.v=u.x,u.y*=p;var m=i.clone();m.multiplyScalar(u.z+l.l1*u.y),h.multiplyScalar(-u.y),h.addVectors(h,m),o.g=h.multiplyScalar(6*ge.KIS2*p)}else o.v=0,o.g.set(0,0,0);return o}ComputeTParam(t,e){var i=new pe.Vector3;i.subVectors(t,this.point_min);var s=i.dot(this.main_dir),r=i.dot(this.unit_normal),o=s*s+r*r,h=new pe.Vector3;return h.set(this.weight_min*this.weight_min-ge.KIS2*o,-this.unit_delta_weight*this.weight_min-ge.KIS2*s,this.unit_delta_weight*this.unit_delta_weight-ge.KIS2),this.homotheticClippingSpecial(h,this.coord_max,e)}homotheticCompactPolynomial_segment_F_i6_cste(t,e){var i=e.z,s=i*t,r=e.y,o=e.x,h=i*o-r*r,a=1/i,n=h*a,c=o+(-2*r+s)*t,l=s-r,p=l*(c*c),u=r*(o*o);return(1.2*(4/3*(2*h*t+l*c+r*o)*n+p+u)*n+c*p+o*u)*a/7}homotheticCompactPolynomial_segment_FGradF_i6_cste(t,e,i){var s=e.z,r=s*t,o=e.y,h=e.x,a=s*h-o*o,n=1/s,c=a*n,l=h+(-2*o+r)*t,p=r-o,u=l*l,m=h*h,v=4/3*(2*a*t+p*l+o*h)*c+p*u+o*m,_=v*n/5,g=h*m,d=l*u;i.x=(1.2*v*c+p*d+o*g)*n/7,i.y=_,i.z=(o*_+d/6-g/6)*n}}ue.register(be.type,be);var fe=be;const we=a;class xe{static type="DistanceFunctor";static fromJSON(t){return we.fromJSON(t)}getType(){return xe.type}toJSON(){return{type:this.getType()}}value(t){throw"Error : not implemented. Must be reimplemented in children classes."}numericalGradient(t,e){var i=e||1e-5;return(this.value(t+i)-this.value(t-i))/(2*i)}gradient(t){return this.numericalGradient(t,1e-5)}getSupport(){return 1/0}}we.register(xe.type,xe);var Ve=xe;const Se=a,Ae=Ve;class Me extends Ae{static type="Poly6DistanceFunctor";static fromJSON(t){return new Me(t.scale)}static evalStandard(t){if(t<0)return 1;var e=1-t*t;return e>0?e*e*e:0}constructor(t){super(),this.scale=t||1}getType(){return Me.type}toJSON(){return{...super.toJSON(),scale:this.scale}}value(t){var e=t/(2*this.scale);return e+=.5,Me.evalStandard(e)/Me.evalStandard(.5)}gradient(t){var e=t/(2*this.scale)+.5,i=1-e*e;return i=-6/(2*this.scale)*e*i*i/Me.evalStandard(.5)}getSupport(){return this.scale}}Se.register(Me.type,Me);var Te=Me;const Be=r.default,Ne=g,Pe=a;class Fe extends Ne{static type="SDFNode";constructor(){super(),this.aabb.set(new Be.Vector3(-1/0,-1/0,-1/0),new Be.Vector3(1/0,1/0,1/0)),this.children}getType(){return Fe.type}computeAABB(){}computeDistanceAABB(t){let e=new Be.Box3;for(let i=0;i<this.children.length;++i)e.union(this.children[i].computeDistanceAABB(t));return e}addChild(t){return super.addChild(t)}getAreas(){throw"No Areas for SDFNode, except for the SDFRootNode."}getDistanceAreas(t){let e=[];for(let i=0;i<this.children.length;++i){let s=this.children[i];e.push(...s.getDistanceAreas(t))}return e}distanceTo(t){throw"distanceTo should be reimplemented in every children classes of SDFNode."}heuristicStepWithin(){throw"heuristicStepWithin may not make sens for all SDFNode, except for the SDFRootNode."}}Pe.register(Fe.type,Fe);var ze=Fe;const ke=r.default,De=u,Ee=a;class Oe extends De{static type="SDFPrimitive";constructor(){super(),this.aabb.set(new ke.Vector3(-1/0,-1/0,-1/0),new ke.Vector3(1/0,1/0,1/0))}getType(){return Oe.type}computeAABB(){}computeDistanceAABB(t){return console.error("computeDistanceAABB is an abstract function of SDFPrimitive. Please reimplement it in children classes."),(new ke.Box3).makeEmpty()}getAreas(){throw"No Areas for SDFPrimitive."}getDistanceAreas(t){return console.error("getDistanceAreas is an abstract function of SDFPrimitive. Please reimplement in children classes"),[]}distanceTo=function(){var t={v:0};return e=>(this.value(e,t),t.v)}();heuristicStepWithin(){return console.error("SDFPrimitive.heuristicStepWithin is Not implemented"),1}}Ee.register(Oe.type,Oe);var Re=Oe;const Ce=r.default,qe=a,Je=ze,je=nt,Ie=b,Ke=Ve,Ge=Re;class He extends je{static type="SDFRootNode";static fromJSON(t){let e=qe.fromJSON(t.f),i=Ie.fromJSON(t.materials[0]),s=qe.fromJSON(t.sdfRoot);if(!(e instanceof Ke))throw new Error("SDFRootNode parsing resulted in the wrong type of object for parameter f.");return i instanceof Ie||(console.error("SDFRootNode parsing resulted in the wrong type of object for parameter material, using default."),i=null),s instanceof Je||s instanceof Ge||(console.error("SDFRootNode parsing resulted in the wrong type of object for parameter sdfRoot, using default."),s=null),new He(e,i,s)}constructor(t,e,i){super(),this.f=t,this.materials.push(e?e.clone():new Ie),this.sdfRoot=i?i instanceof Je?i:(new Je).addChild(i):new Je,this.tmp_res={v:0,g:null},this.tmp_g=new Ce.Vector3(0,0,0)}getType(){return He.type}addChild(t){if(0!==this.sdfRoot.children.length)throw"Error : SDFRootNode can have only one child.";this.sdfRoot.addChild.call(this,t)}removeChild(t){this.sdfRoot.removeChild(t)}toJSON(){return{...super.toJSON(),f:this.f.toJSON(),sdfRoot:this.sdfRoot.toJSON()}}prepareForEval(){if(!this.valid_aabb){this.aabb=new Ce.Box3;for(let t=0;t<this.sdfRoot.children.length;++t){let e=this.sdfRoot.children[t];e.prepareForEval(),this.aabb.union(e.computeDistanceAABB(this.f.getSupport()))}this.valid_aabb=!0}}getAreas(){if(this.valid_aabb){let t=this.sdfRoot.getDistanceAreas(this.f.getSupport()),e=[];return t.forEach((t=>{e.push({aabb:t.aabb,bv:t.bv,obj:this})})),e}throw"ERROR : Cannot get area of invalid node"}value(t,e){var i=this.tmp_res;i.g=e.g?this.tmp_g:null,e.v=0,e.m&&e.m.copy(Ie.defaultMaterial),e.g||void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)?(this.sdfRoot.children[0].value(t,i),e.v=this.f.value(i.v),e.g&&e.g.copy(i.g).multiplyScalar(this.f.gradient(e.v)),e.m&&e.m.copy(this.materials[0])):void 0!==e.step&&(e.step=this.aabb.distanceToPoint(t)+.3)}}qe.register(He.type,He);var Ue=He;const Le=r.default,We=a,$e=Re,Xe=Bt;class Ze extends $e{static type="SDFPoint";static fromJSON(t){return new Ze(new Le.Vector3(t.p.x,t.p.y,t.p.z),t.acc)}constructor(t,e){super(),this.p=t.clone(),this.acc=e||1}getType(){return Ze.type}toJSON(){return{...super.toJSON(),p:{x:this.p.x,y:this.p.y,z:this.p.z},acc:this.acc}}setAccuracy(t){this.acc=t,this.invalidAABB()}getAccuracy(){return this.acc}setPosition(t){this.p.copy(t),this.invalidAABB()}getPosition(){return this.p}computeDistanceAABB(t){return new Le.Box3(this.p.clone().add(new Le.Vector3(-t,-t,-t)),this.p.clone().add(new Le.Vector3(t,t,t)))}prepareForEval(){this.valid_aabb||(this.valid_aabb=!0)}getDistanceAreas(t){if(this.valid_aabb)return[{aabb:this.computeDistanceAABB(t),bv:new Xe(this.p,t,this.acc),obj:this}];throw"ERROR : Cannot get area of invalid primitive"}value=function(){var t=new Le.Vector3;return function(e,i){if(!this.valid_aabb)throw"Error : PrepareForEval should have been called";t.subVectors(e,this.p);var s=t.length();i.v=s,i.g&&i.g.copy(t).multiplyScalar(1/s)}}()}We.register(Ze.type,Ze);var Ye=Ze;const Qe=r.default,ti=Vt,ei=St;var ii=class extends ti{constructor(t,e,i,s,r,o){super(),this.p1=t.clone(),this.p2=e.clone(),this.r1=i,this.r2=s,this.accFactor1=r||1,this.accFactor2=o||1,this.unit_dir=(new Qe.Vector3).subVectors(e,t),this.length=this.unit_dir.length(),this.unit_dir.normalize(),this.vector=new Qe.Vector3,this.p1_to_p=this.vector,this.p1_to_p_sqrnorm=0,this.x_p_2D=0,this.y_p_2D=0,this.y_p_2DSq=0,this.ortho_vec_x=this.r1-this.r2,this.ortho_vec_y=this.length,this.p_proj_x=0,this.p_proj_y=0,this.abs_diff_thick=Math.abs(this.ortho_vec_x)}proj_computation(t){this.p1_to_p=this.vector,this.p1_to_p.subVectors(t,this.p1),this.p1_to_p_sqrnorm=this.p1_to_p.lengthSq(),this.x_p_2D=this.p1_to_p.dot(this.unit_dir),this.y_p_2DSq=this.p1_to_p_sqrnorm-this.x_p_2D*this.x_p_2D,this.y_p_2D=this.y_p_2DSq>0?Math.sqrt(this.y_p_2DSq):0;var e=-this.y_p_2D/this.ortho_vec_y;this.p_proj_x=this.x_p_2D+e*this.ortho_vec_x,this.p_proj_y=0}sphereIntersect(t){if(this.proj_computation(t.center),this.p_proj_x<0)return Math.sqrt(this.p1_to_p_sqrnorm)-t.radius<this.r1;if(this.p_proj_x>this.length)return this.vector.subVectors(t.center,this.p2),Math.sqrt(this.vector.lengthSq())-t.radius<this.r2;var e=this.x_p_2D-this.p_proj_x,i=e*e+this.y_p_2DSq,s=this.p_proj_x/this.length,r=this.r1*(1-s)+s*this.r2,o=t.radius+r;return i<o*o}contains(t){if(this.proj_computation(t),this.p_proj_x<0)return this.p1_to_p_sqrnorm<this.r1*this.r1;if(this.p_proj_x>this.length)return this.vector.subVectors(t,this.p2),this.vector.lengthSq()<this.r2*this.r2;var e=this.x_p_2D-this.p_proj_x,i=this.y_p_2D-this.p_proj_y,s=e*e+i*i,r=this.p_proj_x/this.length,o=this.r1*(1-r)+r*this.r2;return s<o*o}getAcc(t,e){this.proj_computation(t.center);var i=this.abs_diff_thick/this.length,s=t.radius*Math.sqrt(1+i*i)*.5,r=this.p_proj_x;if((r+=this.r1>this.r2?s:-s)<0)return this.r1*this.accFactor1*e;if(r>this.length)return this.r2*this.accFactor2*e;var o=r/this.length;return(this.r1*this.accFactor1*(1-o)+o*this.r2*this.accFactor2)*e}getNiceAcc(t){return this.getAcc(t,ei.nice)}getCurrAcc(t){return this.getAcc(t,ei.curr)}getRawAcc(t){return this.getAcc(t,ei.raw)}getMinAcc(){return ei.curr*Math.min(this.r1*this.accFactor1,this.r2*this.accFactor2)}getMinRawAcc(){return ei.raw*Math.min(this.r1*this.accFactor1,this.r2*this.accFactor2)}getAxisProjectionMinStep(t,e){var i,s,r,o=Number.MAX_VALUE,h=this.p1[t]<this.p2[t]?this.p1:this.p2;h===this.p1?(i=this.p2,s=this.r1*this.accFactor1,r=this.r2*this.accFactor2):(i=this.p1,s=this.r2,r=this.r1*this.accFactor1);var a=e-h[t];a<-2*s?o=Math.min(o,Math.max(Math.abs(a+2*s),ei.curr*s)):a<2*s&&(o=Math.min(o,ei.curr*s)),(a=e-i[t])<-2*r?o=Math.min(o,Math.max(Math.abs(a+2*r),ei.curr*r)):a<2*r&&(o=Math.min(o,ei.curr*r));var n=e-h[t],c=i[t]-h[t];return n>0&&n<c&&0!==c&&(o=Math.min(o,ei.curr*(s+n/c*(r-s)))),o}};const si=r.default,ri=a,oi=Re,hi=ii;class ai extends oi{static type="SDFSegment";static fromJSON(t){return new ai(new si.Vector3(t.p1.x,t.p1.y,t.p1.z),new si.Vector3(t.p2.x,t.p2.y,t.p2.z),t.acc)}constructor(t,e,i){super(),this.p1=t.clone(),this.p2=e.clone(),this.acc=i||1,this.l=new si.Line3(this.p1,this.p2)}getType(){return ai.type}toJSON(){return{...super.toJSON(),p1:{x:this.p1.x,y:this.p1.y,z:this.p1.z},p2:{x:this.p2.x,y:this.p2.y,z:this.p2.z},acc:this.acc}}setAccuracy(t){this.acc=t,this.invalidAABB()}getAccuracy(){return this.acc}setPosition1(t){this.p1.copy(t),this.invalidAABB()}setPosition2(t){this.p2.copy(t),this.invalidAABB()}getPosition1(){return this.p1}getPosition2(){return this.p2}computeDistanceAABB(t){var e=new si.Box3(this.p1.clone().add(new si.Vector3(-t,-t,-t)),this.p1.clone().add(new si.Vector3(t,t,t))),i=new si.Box3(this.p2.clone().add(new si.Vector3(-t,-t,-t)),this.p2.clone().add(new si.Vector3(t,t,t)));return e.union(i)}prepareForEval(){this.valid_aabb||(this.l.set(this.p1,this.p2),this.valid_aabb=!0)}getDistanceAreas(t){if(this.valid_aabb)return[{aabb:this.computeDistanceAABB(t),bv:new hi(this.p1,this.p2,t,t,this.acc,this.acc),obj:this}];throw"ERROR : Cannot get area of invalid primitive"}value=function(){var t=new si.Vector3,e=new si.Vector3;return function(i,s){this.l.closestPointToPoint(i,!0,t),s.v=e.subVectors(i,t).length(),s.g&&s.g.copy(e).divideScalar(s.v)}}()}ri.register(ai.type,ai);var ni=ai;const ci=r.default,li=a,pi=Re,ui=Bt;class mi extends pi{static type="SDFSphere";static fromJSON(t){return new mi(new ci.Vector3(t.p.x,t.p.y,t.p.z),t.r)}constructor(t,e){super(),this.p=t.clone(),this.r=e}getType(){return mi.type}toJSON(){return{...super.toJSON(),p:{x:this.p.x,y:this.p.y,z:this.p.z},r:this.r}}setRadius(t){this.r=t,this.invalidAABB()}getRadius(){return this.r}setPosition(t){this.p.copy(t),this.invalidAABB()}getPosition(){return this.p}computeDistanceAABB(t){return new ci.Box3(this.p.clone().add(new ci.Vector3(-this.r-t,-this.r-t,-this.r-t)),this.p.clone().add(new ci.Vector3(this.r+t,this.r+t,this.r+t)))}prepareForEval(){this.valid_aabb||(this.valid_aabb=!0)}getDistanceAreas(t){if(this.valid_aabb)return[{aabb:this.computeDistanceAABB(t),bv:new ui(this.p,this.r+t,this.r/(this.r+t)),obj:this}];throw"ERROR : Cannot get area of invalid primitive"}value=function(){var t=new ci.Vector3;return function(e,i){let s=this;if(!s.valid_aabb)throw"Error : PrepareForEval should have been called";t.subVectors(e,s.p);var r=t.length();i.v=r-s.r,i.g&&i.g.copy(t).multiplyScalar(1/r)}}()}li.register(mi.type,mi);var vi=mi;const _i=r.default,gi=a,di=Re,yi=ii;class bi extends di{static type="SDFCapsule";static fromJSON(t){return new bi(new _i.Vector3(t.p1.x,t.p1.y,t.p1.z),new _i.Vector3(t.p2.x,t.p2.y,t.p2.z),t.r1,t.r2)}constructor(t,e,i,s){super(),this.p1=t.clone(),this.p2=e.clone(),this.r1=i,this.r2=s,this.rdiff=this.r2-this.r1,this.unit_dir=(new _i.Vector3).subVectors(this.p2,this.p1),this.lengthSq=this.unit_dir.lengthSq(),this.length=this.unit_dir.length(),this.unit_dir.normalize()}getType(){return bi.type}toJSON(){return{...super.toJSON(),p1:{x:this.p1.x,y:this.p1.y,z:this.p1.z},r1:this.r1,p2:{x:this.p2.x,y:this.p2.y,z:this.p2.z},r2:this.r2}}setRadius1(t){this.r1=t,this.invalidAABB()}setRadius2(t){this.r2=t,this.invalidAABB()}getRadius1(){return this.r1}getRadius2(){return this.r2}setPosition1(t){this.p1.copy(t),this.invalidAABB()}setPosition2(t){this.p2.copy(t),this.invalidAABB()}getPosition1(){return this.p1}getPosition2(){return this.p2}computeDistanceAABB(t){var e=new _i.Box3(this.p1.clone().add(new _i.Vector3(-this.r1-t,-this.r1-t,-this.r1-t)),this.p1.clone().add(new _i.Vector3(this.r1+t,this.r1+t,this.r1+t))),i=new _i.Box3(this.p2.clone().add(new _i.Vector3(-this.r2-t,-this.r2-t,-this.r2-t)),this.p2.clone().add(new _i.Vector3(this.r2+t,this.r2+t,this.r2+t)));return e.union(i)}prepareForEval(){this.valid_aabb||(this.valid_aabb=!0)}getDistanceAreas(t){if(this.valid_aabb)return[{aabb:this.computeDistanceAABB(t),bv:new yi(this.p1,this.p2,this.r1+t,this.r2+t,this.r1/(this.r1+t),this.r2/(this.r2+t)),obj:this}];throw"ERROR : Cannot get area of invalid primitive"}value=function(){var t=new _i.Vector3,e=new _i.Vector3;return function(i,s){let r=this;t.subVectors(i,r.p1);var o=t.lengthSq(),h=t.dot(r.unit_dir),a=h+-Math.sqrt(Math.max(0,o-h*h))/r.length*(r.r1-r.r2),n=_i.MathUtils.clamp(a/r.length,0,1);e.copy(r.p1).lerp(r.p2,n);var c=t.subVectors(i,e).length();s.v=c-(n*r.r2+(1-n)*r.r1),s.g&&s.g.copy(t).divideScalar(c)}}()}gi.register(bi.type,bi);var fi=bi,wi={EdgeVMap:[[0,4],[1,5],[2,6],[3,7],[0,2],[1,3],[4,6],[5,7],[0,1],[2,3],[4,5],[6,7]],VertexTopo:[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]]};const{Box2:xi}=r.default,Vi=r.default,Si=b,Ai=B,Mi=wi;class Ti extends xi{constructor(t,e,i,s){super(t,e);var r=Math.max(this.max.x-this.min.x,this.max.y-this.min.y);this.nice_acc=1e7,this.nice_acc=void 0===i||null===i&&r>0?r:i,this.raw_acc=this.raw_acc?this.nice_acc:s}unionWithAcc(t){super.union(t),this.raw_acc=Math.min(t.raw_acc,this.raw_acc),this.nice_acc=Math.min(t.nice_acc,this.nice_acc)}getRawAcc(){return this.raw_acc}getNiceAcc(){return this.nice_acc}setRawAcc(t){this.raw_acc=Math.max(0,t)}setNiceAcc(t){this.nice_acc=Math.max(0,t)}toString(){return"("+this.min.x.toFixed(2)+", "+this.min.y.toFixed(2)+") -> ("+this.max.x.toFixed(2)+", "+this.max.y.toFixed(2)+") "}setWithAcc(t,e,i,s,r,o){this.min.set(t,e),this.max.set(i,s),void 0!==r&&(this.nice_acc=r),void 0!==o&&(this.raw_acc=o)}getMinCorner(){return this.min}}var Bi=class{constructor(t,e){if(!e)throw new Error("smcParams must be provided for SlidingMarchingCubes, to use all default values, please use {}");this.blobtree=t,this.uniformZ="uniform"===e.zResolution,this.detail_ratio=e.detailRatio?Math.max(.01,e.detailRatio):1,e.convergence?(this.convergence=e.convergence,this.convergence.ratio=this.convergence.ratio||.01,this.convergence.step=this.convergence.step||10):this.convergence=null,this.progress=e.progress?e.progress:function(t){},this.reso=new Int32Array(3),this.steps={x:null,y:null,z:null},this.curr_steps={x:0,y:0,z:0},this.curr_step_vol=0,this.values_xy=[null,null],this.vertices_xy=[null,null],this.areas=[],this.min_acc=1,this.values=new Array(8),this.x=0,this.y=0,this.z=0,this.mask=0,this.edge_cross=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.vertex=new Vi.Vector3(0,0,0),this.vertex_n=new Vi.Vector3(0,0,0),this.vertex_m=new Si,this.extended=!1,this.dis_o_aabb=new Vi.Box3,this.ext_p=new Vi.Vector3,this.geometry=null,this.minCurvOrient=!0,this._isMinCurvatureTriangulation=function(){let t=new Vi.Vector3,e=new Vi.Vector3,i=new Vi.Vector3,s=new Vi.Vector3,r=new Vi.Vector3,o=new Vi.Vector3,h=new Vi.Vector3,a=new Vi.Vector3,n=new Vi.Vector3,c=new Vi.Vector3,l=new Vi.Vector3,p=new Vi.Vector3,u=new Vi.Vector3;return function(m,v,_,g){t.x=this.geometry.position[3*m],t.y=this.geometry.position[3*m+1],t.z=this.geometry.position[3*m+2],e.x=this.geometry.position[3*v],e.y=this.geometry.position[3*v+1],e.z=this.geometry.position[3*v+2],i.x=this.geometry.position[3*_],i.y=this.geometry.position[3*_+1],i.z=this.geometry.position[3*_+2],s.x=this.geometry.position[3*g],s.y=this.geometry.position[3*g+1],s.z=this.geometry.position[3*g+2],r.subVectors(t,e),o.subVectors(i,e),h.subVectors(s,e),a.subVectors(t,s),n.subVectors(i,s),c.copy(o),c.cross(r).normalize(),l.copy(a),l.cross(n).normalize(),p.copy(o),p.cross(h).normalize(),u.copy(a),u.cross(h.multiplyScalar(-1)).normalize();let d=c.dot(l);return p.dot(u)<d}}()}initGeometry(){this.geometry={position:[],normal:[],color:[],metalness:[],roughness:[],nVertices:0,faces:[],nFaces:0,addVertex:function(t){this.position.push(t.p.x,t.p.y,t.p.z),this.normal.push(t.n.x,t.n.y,t.n.z),this.color.push(t.c.r,t.c.g,t.c.b),this.roughness.push(t.r),this.metalness.push(t.m),this.nVertices++},addFace:function(t,e,i){this.faces.push(t,e,i),this.nFaces++}}}buildResultingBufferGeometry(){var t=new Vi.BufferGeometry;return t.setAttribute("position",new Vi.BufferAttribute(new Float32Array(this.geometry.position),3)),t.setAttribute("normal",new Vi.BufferAttribute(new Float32Array(this.geometry.normal),3)),t.setAttribute("color",new Vi.BufferAttribute(new Float32Array(this.geometry.color),3)),t.setAttribute("roughness",new Vi.BufferAttribute(new Float32Array(this.geometry.roughness),1)),t.setAttribute("metalness",new Vi.BufferAttribute(new Float32Array(this.geometry.metalness),1)),t.setIndex(new Vi.BufferAttribute(this.geometry.nVertices>65535?new Uint32Array(this.geometry.faces):new Uint16Array(this.geometry.faces),1)),t}setFrontToZero(){for(let t=0;t<this.values_xy[1].length;++t)this.values_xy[1][t]=0}setFrontToMinus(){for(let t=0;t<this.values_xy[1].length;++t)this.values_xy[1][t]=-1}setFrontToZeroIfMinus(){for(let t=0;t<this.values_xy[1].length;++t)-1===this.values_xy[1][t]&&(this.values_xy[1][t]=0)}interpolateInBox(t,e,i,s,r,o,h){let a=this.values_xy[1],n=r-s,c=h-o;if(n>1){let t=o*this.reso[0],e=a[t+s],i=(a[t+r]-e)/n;for(var l=1;l<n;++l)-1===a[t+s+l]&&(a[t+s+l]=e+l*i)}if(c>1){let t=h*this.reso[0],e=a[t+s],i=(a[t+r]-e)/n;for(let r=1;r<n;++r)-1===a[t+s+r]&&(a[t+s+r]=e+r*i);for(let t=0;t<=n;++t){e=a[o*this.reso[0]+s+t],i=(a[h*this.reso[0]+s+t]-e)/c;for(var p=1;p<c;++p)-1===a[(o+p)*this.reso[0]+s+t]&&(a[(o+p)*this.reso[0]+s+t]=e+p*i)}}}computeFrontValAt(t,e,i,s,r){this.computeFrontValAtClosure(t,e,i,s,r)}computeFrontValAtClosure=function(){var t={v:0},e=new Vi.Vector3;return function(i,s,r,o,h){let a=this;var n=h*a.reso[0]+o;t.v=a.blobtree.getNeutralValue(),-1===a.values_xy[1][n]&&(e.set(i+o*a.min_acc,s+h*a.min_acc,r),a.blobtree.value(e,t),a.values_xy[1][n]=t.v)}}();computeFrontValAtBoxCorners(t,e,i,s,r){this.computeFrontValAt(t,e,i,s.x,s.y),this.computeFrontValAt(t,e,i,s.x,r.y),this.computeFrontValAt(t,e,i,r.x,s.y),this.computeFrontValAt(t,e,i,r.x,r.y)}computeFrontValInBox(t,e,i,s,r){for(var o=s.x;o<=r.x;++o)for(var h=s.y;h<=r.y;++h)this.computeFrontValAt(t,e,i,o,h)}setFrontValZeroInBox(t,e){for(var i=t.x;i<=e.x;++i)for(var s=t.y;s<=e.y;++s)this.values_xy[1][s*this.reso[0]+i]=0}computeBoxMask(t,e){var i=0;return i|=this.values_xy[1][t.y*this.reso[0]+t.x]>this.blobtree.getIsoValue()?1:0,i|=this.values_xy[1][t.y*this.reso[0]+e.x]>this.blobtree.getIsoValue()?2:0,i|=this.values_xy[1][e.y*this.reso[0]+e.x]>this.blobtree.getIsoValue()?4:0,i|=this.values_xy[1][e.y*this.reso[0]+t.x]>this.blobtree.getIsoValue()?8:0}checkZeroBox(t,e){return this.values_xy[1][t.y*this.reso[0]+t.x]+this.values_xy[1][t.y*this.reso[0]+e.x]+this.values_xy[1][e.y*this.reso[0]+e.x]+this.values_xy[1][e.y*this.reso[0]+t.x]}recursiveBoxComputation(t,e,i,s,r){var o=null,h=new Vi.Vector2(Math.round(s.max.x-s.min.x),Math.round(s.max.y-s.min.y));if(h.x>1&&h.x>=h.y){var a=s.min.x+Math.floor(h.x/2);o=[new Ti(s.min,new Vi.Vector2(a,s.max.y),1e4,1e4),new Ti(new Vi.Vector2(a,s.min.y),s.max,1e4,1e4)],this.computeFrontValAt(t,e,i,a,s.min.y),this.computeFrontValAt(t,e,i,a,s.max.y)}else{if(!(h.y>1))return;var n=s.min.y+Math.floor(h.y/2);o=[new Ti(s.min,new Vi.Vector2(s.max.x,n),1e4,1e4),new Ti(new Vi.Vector2(s.min.x,n),s.max,1e4,1e4)],this.computeFrontValAt(t,e,i,s.min.x,n),this.computeFrontValAt(t,e,i,s.max.x,n)}for(var c=[[],[]],l=0;l<r.length;++l)for(var p=0;p<o.length;++p)o[p].intersectsBox(r[l])&&(o[p].setRawAcc(Math.min(o[p].getRawAcc(),r[l].getRawAcc())),o[p].setNiceAcc(Math.min(o[p].getNiceAcc(),r[l].getNiceAcc())),c[p].push(r[l]));for(let s=0;s<o.length;++s){let r=o[s],h=r.getSize(new Vi.Vector2);if(0===c[s].length)this.setFrontValZeroInBox(r.min,r.max);else if(h.x<=r.getRawAcc()&&h.y<=r.getRawAcc()){let o=this.computeBoxMask(r.min,r.max);15===o||0===o||h.x<=r.getNiceAcc()&&h.y<=r.getNiceAcc()?this.interpolateInBox(t,e,i,r.min.x,r.max.x,r.min.y,r.max.y):this.recursiveBoxComputation(t,e,i,r,c[s])}else this.recursiveBoxComputation(t,e,i,r,c[s])}}computeFrontValues(t,e,i){this.setFrontToMinus();var s=this.blobtree.getAreas(),r=new Ti;r.makeEmpty();for(var o=[],h=0;h<s.length;++h){var a=Math.round(s[h].bv.getMinRawAcc()*this.detail_ratio/this.min_acc),n=Math.round(s[h].bv.getMinAcc()*this.detail_ratio/this.min_acc),c=Math.max(0,Math.floor((s[h].aabb.min.x-t)/this.min_acc)),l=Math.max(0,Math.floor((s[h].aabb.min.y-e)/this.min_acc)),p=Math.min(this.reso[0]-1,Math.ceil((s[h].aabb.max.x-t)/this.min_acc)),u=Math.min(this.reso[1]-1,Math.ceil((s[h].aabb.max.y-e)/this.min_acc));o.push(new Ti(new Vi.Vector2(c,l),new Vi.Vector2(p,u),n,a)),r.unionWithAcc(o[o.length-1])}r.intersect(new Ti(new Vi.Vector2(0,0),new Vi.Vector2(this.reso[0],this.reso[1]),r.getNiceAcc(),r.getRawAcc())),this.computeFrontValAtBoxCorners(t,e,i,r.min,r.max),this.recursiveBoxComputation(t,e,i,r,o),this.setFrontToZeroIfMinus()}getMinAcc(t){for(var e=this.blobtree.getAreas(),i=Number.MAX_VALUE,s=0;s<e.length;s++){var r=e[s];if(r.aabb.intersectsBox(t)&&r.bv){var o=r.bv.getMinAcc();o<i&&(i=o)}}return i*this.detail_ratio}getMaxAcc(t){for(var e=this.blobtree.getAreas(),i=0,s=0;s<e.length;s++){var r=e[s];if(r.aabb.intersectsBox(t)&&r.bv){var o=r.bv.getMinAcc();o>i&&(i=o)}}return i*this.detail_ratio}compute(t,e){this.initGeometry();var i=(new Date).getTime();this.blobtree.prepareForEval();var s=null;if(s=t?t.clone():this.blobtree.getAABB(),this.extended=void 0!==e&&e,this.extended){let t=s.getSize(new Vi.Vector3),e=Math.min(Math.min(this.getMinAcc(s),t[0]),Math.min(t[1],t[2])),i=s.clone(),r=s.clone(),o=["x","y","z"];for(let t=0;t<o.length;++t){i.max[o[t]]=s.min[o[t]]+e;let h=this.getMaxAcc(i);0!==h&&(r.min[o[t]]=r.min[o[t]]-h),i.max[o[t]]=s.max[o[t]]-e,h=this.getMaxAcc(i),0!==h&&(r.max[o[t]]=r.max[o[t]]+h)}s.copy(r)}var r=[],o=[];if(t&&(this.blobtree.externalTrim(s,r,o),this.blobtree.prepareForEval()),this.areas=this.blobtree.getAreas(),0===this.areas.length)return this.progress(100),new Vi.BufferGeometry;this.min_acc=0!==this.areas.length?this.areas[0].bv.getMinAcc():1;for(let t=0;t<this.areas.length;++t)this.areas[t].bv.getMinAcc()<this.min_acc&&(this.min_acc=this.areas[t].bv.getMinAcc());this.min_acc=this.min_acc*this.detail_ratio;var h=s.min,a=s.getSize(new Vi.Vector3);this.steps.z=new Float32Array(Math.ceil(a.z/this.min_acc)+2),this.steps.z[0]=h.z;for(var n=1,c=this.blobtree.getAreas();this.steps.z[n-1]<h.z+a.z;){var l=a.z;if(this.uniformZ)l=this.min_acc;else for(let t=0;t<c.length;++t)l=Math.min(l,c[t].bv.getAxisProjectionMinStep("z",this.steps.z[n-1])*this.detail_ratio);this.steps.z[n]=this.steps.z[n-1]+l,n++}if(this.reso[2]=n,this.reso[0]=Math.ceil(a.x/this.min_acc)+2,this.reso[1]=Math.ceil(a.y/this.min_acc)+2,this.extended){var p=0;for(this.dis_o_aabb.set(new Vi.Vector3(-1,-1,-1),new Vi.Vector3(-1,-1,-1));p<this.reso[2]&&-1===this.dis_o_aabb.min.z;)this.steps.z[p]>=t.min.z&&(this.dis_o_aabb.min.z=p),p++;for(p>this.reso[2]-1&&(this.dis_o_aabb.min.z=this.reso[2]-1),p=this.reso[2]-1;p>=0&&-1===this.dis_o_aabb.max.z;)this.steps.z[p]<t.max.z&&(this.dis_o_aabb.max.z=p),p--;p<0&&(this.dis_o_aabb.max.z=0),this.dis_o_aabb.min.x=Math.round((t.min.x-s.min.x)/this.min_acc),this.dis_o_aabb.min.y=Math.round((t.min.y-s.min.y)/this.min_acc),this.dis_o_aabb.max.x=this.reso[0]-2-Math.round((s.max.x-t.max.x)/this.min_acc),this.dis_o_aabb.max.y=this.reso[1]-2-Math.round((s.max.y-t.max.y)/this.min_acc)}this.values_xy[0]=new Float32Array(this.reso[0]*this.reso[1]),this.values_xy[1]=new Float32Array(this.reso[0]*this.reso[1]),this.vertices_xy[0]=new Int32Array(this.reso[0]*this.reso[1]),this.vertices_xy[1]=new Int32Array(this.reso[0]*this.reso[1]);var u=new Vi.Box3;this.computeFrontValues(h.x,h.y,h.z);for(var m=0,v=0;v<this.reso[2]-1;++v){let t=this.values_xy[0];this.values_xy[0]=this.values_xy[1],this.values_xy[1]=t;let e=this.vertices_xy[0];this.vertices_xy[0]=this.vertices_xy[1],this.vertices_xy[1]=e;var _=this.steps.z[v+1];u.set(new Vi.Vector3(h.x,h.y,_-this.min_acc/64),new Vi.Vector3(h.x+this.reso[0]*this.min_acc,h.y+this.reso[1]*this.min_acc,_+this.min_acc/64)),this.blobtree.internalTrim(u),this.blobtree.prepareForEval(),this.computeFrontValues(h.x,h.y,_),this.blobtree.internalUntrim(),this.blobtree.prepareForEval(),this.z=this.steps.z[v],this.curr_steps.z=this.steps.z[v+1]-this.steps.z[v],this.curr_steps.x=this.min_acc,this.curr_steps.y=this.min_acc,this.curr_step_vol=this.curr_steps.x*this.curr_steps.y*this.curr_steps.z;for(var g=0;g<this.reso[1]-1;++g)for(var d=0;d<this.reso[0]-1;++d)this.y=h.y+g*this.min_acc,this.fetchAndTriangulate(d,g,v,h);Math.round(100*v/this.reso[2])>m&&(m=Math.round(100*v/this.reso[2]),this.progress(m))}t&&(this.blobtree.untrim(r,o),this.blobtree.prepareForEval());var y=(new Date).getTime();return console.log("Sliding Marching Cubes computed in "+(y-i)+"ms"),this.values_xy[0]=null,this.values_xy[1]=null,this.vertices_xy[0]=null,this.vertices_xy[1]=null,this.progress(100),this.buildResultingBufferGeometry()}fetchAndTriangulate(t,e,i,s){var r=e*this.reso[0]+t,o=(e+1)*this.reso[0]+t;this.values[0]=this.values_xy[0][r],this.values[1]=this.values_xy[1][r],this.values[2]=this.values_xy[0][o],this.values[3]=this.values_xy[1][o],this.values[4]=this.values_xy[0][r+1],this.values[5]=this.values_xy[1][r+1],this.values[6]=this.values_xy[0][o+1],this.values[7]=this.values_xy[1][o+1],this.computeMask(),0!==this.mask&&255!==this.mask&&(this.x=s.x+t*this.min_acc,this.computeVertex(),this.geometry.addVertex({p:this.vertex,n:this.vertex_n,c:this.vertex_m.getColor(),r:this.vertex_m.getRoughness(),m:this.vertex_m.getMetalness()}),this.vertices_xy[1][r]=this.geometry.nVertices-1,this.triangulate(t,e,i))}pushDirectFaces(t,e,i,s){this.geometry.addFace(t,e,i),this.geometry.addFace(i,s,t)}pushUndirectFaces(t,e,i,s){this.geometry.addFace(i,e,t),this.geometry.addFace(t,s,i)}triangulate(t,e,i){let s=e*this.reso[0]+t;if(this.edge_cross[0]&&0!==e&&0!==i){let i=this.vertices_xy[1][s],r=this.vertices_xy[1][(e-1)*this.reso[0]+t],o=this.vertices_xy[0][(e-1)*this.reso[0]+t],h=this.vertices_xy[0][s];if(this.minCurvOrient){if(!this._isMinCurvatureTriangulation(i,r,o,h)){let t=i;i=r,r=o,o=h,h=t}}1&this.mask?this.pushDirectFaces(i,r,o,h):this.pushUndirectFaces(i,r,o,h)}if(this.edge_cross[4]&&0!==t&&0!==i){let t=this.vertices_xy[1][s],e=this.vertices_xy[0][s],i=this.vertices_xy[0][s-1],r=this.vertices_xy[1][s-1];if(this.minCurvOrient){if(!this._isMinCurvatureTriangulation(t,e,i,r)){let s=t;t=e,e=i,i=r,r=s}}1&this.mask?this.pushDirectFaces(t,e,i,r):this.pushUndirectFaces(t,e,i,r)}if(this.edge_cross[8]&&0!==t&&0!==e){let i=this.vertices_xy[1][s],r=this.vertices_xy[1][s-1],o=this.vertices_xy[1][(e-1)*this.reso[0]+t-1],h=this.vertices_xy[1][(e-1)*this.reso[0]+t];if(this.minCurvOrient){if(!this._isMinCurvatureTriangulation(i,r,o,h)){let t=i;i=r,r=o,o=h,h=t}}1&this.mask?this.pushDirectFaces(i,r,o,h):this.pushUndirectFaces(i,r,o,h)}}computeVertex=function(){var t={v:null,g:new Vi.Vector3(0,0,0),m:new Si},e=new Vi.Vector3;return function(){t.v=this.blobtree.getNeutralValue();var i=0;this.vertex.set(0,0,0);for(var s=0;s<12;++s){var r=Mi.EdgeVMap[s][0],o=Mi.EdgeVMap[s][1],h=Mi.VertexTopo[r],a=Mi.VertexTopo[o],n=this.values[r],c=this.values[o];if(this.edge_cross[s]=n>this.blobtree.getIsoValue()!=c>this.blobtree.getIsoValue(),this.edge_cross[s]){++i;var l=c-n,p=0;Math.abs(l)>1e-6&&(p=(this.blobtree.getIsoValue()-n)/l,this.vertex.x+=(1-p)*h[0]+p*a[0],this.vertex.y+=(1-p)*h[1]+p*a[1],this.vertex.z+=(1-p)*h[2]+p*a[2])}}this.vertex.x=this.x+this.curr_steps.x*this.vertex.x/i,this.vertex.y=this.y+this.curr_steps.y*this.vertex.y/i,this.vertex.z=this.z+this.curr_steps.z*this.vertex.z/i,this.convergence&&(Ai.safeNewton3D(this.blobtree,this.vertex,this.blobtree.getIsoValue(),this.min_acc*this.convergence.ratio,this.convergence.step,this.min_acc,e),this.vertex.copy(e)),this.blobtree.value(this.vertex,t),t.g.normalize(),this.vertex_n.copy(t.g).multiplyScalar(-1),this.vertex_m.copy(t.m)}}();computeMask(){this.mask=0;for(var t=0;t<8;++t){var e=this.values[t];this.mask|=e>this.blobtree.getIsoValue()?1<<t:0}}};const Ni=r.default,Pi=a,Fi=g,zi=b;class ki extends Fi{static type="MaxNode";static fromJSON(t){for(var e=new ki,i=0;i<t.children.length;++i)e.addChild(Pi.fromJSON(t.children[i]));return e}constructor(t){if(super(),t){var e=this;t.forEach((function(t){e.addChild(t)}))}this.tmp_res={v:0,g:null,m:null},this.tmp_g=new Ni.Vector3,this.tmp_m=new zi}getType=function(){return ki.type};prepareForEval(){if(!this.valid_aabb){this.aabb=new Ni.Box3;for(var t=0;t<this.children.length;++t){var e=this.children[t];e.prepareForEval(),this.aabb.union(e.getAABB())}this.valid_aabb=!0}}value(t,e){var i=this.children.length,s=this.tmp_res;if(s.g=e.g?this.tmp_g:null,s.m=e.m?this.tmp_m:null,e.v=0,e.m&&e.m.copy(zi.defaultMaterial),e.g?e.g.set(0,0,0):void 0!==e.step&&(e.step=1e9),this.aabb.containsPoint(t)&&0!==i){e.v=Number.MAX_VALUE;for(var r=0;r<i;++r){if(this.children[r].value(t,s),s.v>e.v&&(e.v=s.v,e.g&&e.g.copy(s.g),e.m&&e.m.copy(s.m),e.step||e.stepOrtho))throw"Not implemented";e.v=Math.max(e.v,s.v)}}else if(e.step||e.stepOrtho)throw"Not implemented"}}Pi.register(ki.type,ki);var Di=ki;const{BufferGeometryUtils:Ei}=o.default,Oi=D,Ri=A,Ci=Di,qi=Rt,Ji=Zt,ji=fe,Ii=Bi;class Ki{constructor(t,e){var i=e||{};this.blobtree=t,this.uniformRes=i.uniformRes||!1,this.min_acc=null,this.minAccs=[],this.subPolygonizer=i.subPolygonizer?i.subPolygonizer:{class:Ii,detailRatio:1},this.ricciThreshold=i.ricciThreshold||64,this.progress=i.progress?i.progress:function(t){},this.subtrees=[],this.progCoeff=[],this.totalCoeff=0,this.setBlobtree(t)}}Ki.prototype.constructor=Ki,Ki.prototype.setBlobtree=function(t){this.blobtree=t,this.blobtree.prepareForEval();var e=function(t){for(var e=t.getAreas(),i=0!==e.length?e[0].bv.getMinAcc():null,s=0;s<e.length;++s)e[s].bv.getMinAcc()<i&&(i=e[s].bv.getMinAcc());return i};this.min_acc=e(this.blobtree),this.subtrees=[],this.progCoeff=[],this.totalCoeff=0;var i=this,s=function(t){var s=null;t instanceof Oi?s=t.clone():(s=new Oi).addChild(t.clone()),i.subtrees.push(s),s.prepareForEval(),i.minAccs.push(e(s)),i.progCoeff.push(s.count(qi)+s.count(Ji)+s.count(ji)),i.totalCoeff+=i.progCoeff[i.progCoeff.length-1]},r=function(t){if(t instanceof Ri)if(t.getRicciN()<i.ricciThreshold)0!==t.children.length&&s(t);else for(var e=0;e<t.children.length;++e)r(t.children[e]);else if(t instanceof Ci)for(let e=0;e<t.children.length;++e)r(t.children[e]);else s(t)};r(this.blobtree)},Ki.prototype.compute=function(){this.blobtree.isValidAABB()||this.setBlobtree(this.blobtree);var t=this;this.progress(0);for(var e=0,i=[],s=0;s<this.subtrees.length;++s){var r=this.subPolygonizer.detailRatio||1;this.uniformRes&&this.min_acc&&(this.subPolygonizer.detailRatio=r*this.min_acc/this.minAccs[s]),this.subPolygonizer.progress=function(i){t.progress(100*(e+i/100*t.progCoeff[s])/t.totalCoeff)};var o=new this.subPolygonizer.class(this.subtrees[s],this.subPolygonizer);i.push(o.compute()),this.subPolygonizer.detailRatio=r,e+=this.progCoeff[s]}var h=Ei.mergeBufferGeometries(i);return this.progress(100),h};var Gi=Ki;const Hi=r.default,Ui=b,Li=wi,Wi=B,$i=Bi;var Xi=class extends $i{constructor(t,e){if(super(t,e),!e.metaBlobtree)throw"Error : SplitSMC needs a meta blobtree in params (from which normals will be computed).";this.metaBlobtree=e.metaBlobtree,this.metaBlobtree.prepareForEval()}computeVertex=function(){var t={v:null,g:new Hi.Vector3(0,0,0),m:new Ui},e=new Hi.Vector3;return function(){let i=this;t.v=i.blobtree.getNeutralValue();let s=0;i.vertex.set(0,0,0);for(let t=0;t<12;++t){var r=Li.EdgeVMap[t][0],o=Li.EdgeVMap[t][1],h=Li.VertexTopo[r],a=Li.VertexTopo[o],n=i.values[r],c=i.values[o];if(i.edge_cross[t]=n>i.blobtree.getIsoValue()!=c>i.blobtree.getIsoValue(),i.edge_cross[t]){++s;var l=c-n,p=0;Math.abs(l)>1e-6&&(p=(i.blobtree.getIsoValue()-n)/l,i.vertex.x+=(1-p)*h[0]+p*a[0],i.vertex.y+=(1-p)*h[1]+p*a[1],i.vertex.z+=(1-p)*h[2]+p*a[2])}}i.vertex.x=i.x+i.curr_steps.x*i.vertex.x/s,i.vertex.y=i.y+i.curr_steps.y*i.vertex.y/s,i.vertex.z=i.z+i.curr_steps.z*i.vertex.z/s,i.convergence&&(Wi.safeNewton3D(i.blobtree,i.vertex,i.blobtree.getIsoValue(),i.min_acc*i.convergence.ratio,i.convergence.step,i.min_acc,e),i.vertex.copy(e)),i.metaBlobtree.value(i.vertex,t),t.g.normalize(),i.vertex_n.copy(t.g).multiplyScalar(-1),i.vertex_m.copy(t.m)}}()};const Zi="1.0.0";var Yi=Object.freeze({__proto__:null,version:Zi,Types:a,Element:u,Node:g,RootNode:D,RicciNode:A,DifferenceNode:J,MinNode:U,MaxNode:U,TwistNode:Y,ScaleNode:rt,Primitive:nt,ScalisMath:mt,ScalisPrimitive:dt,ScalisPoint:Rt,ScalisSegment:Zt,ScalisTriangle:fe,ScalisVertex:xt,DistanceFunctor:Ve,Poly6DistanceFunctor:Te,SDFRootNode:Ue,SDFPrimitive:Re,SDFPoint:Ye,SDFSegment:ni,SDFSphere:vi,SDFCapsule:fi,Material:b,Accuracies:St,Area:Vt,AreaScalisSeg:It,AreaScalisTri:le,AreaSphere:Bt,AreaCapsule:ii,SlidingMarchingCubes:Bi,SplitMaxPolygonizer:Gi,SplitSMC:Xi});const Qi="three-js-blobtree";return function(t,e){try{if(THREE.REVISION!=e)throw new Error(`${t} depends on THREE revision ${e}, but current revision is ${THREE.REVISION}.`)}catch(e){if(e.message.match(/depends on THREE revision/))throw e;console.warn(`${t}: Revision check unavailable. ${e}`)}}(Qi,130),h(Qi,"BufferGeometryUtils",i.BufferGeometryUtils),h(Qi,"Blobtree",Yi),t.Accuracies=St,t.Area=Vt,t.AreaCapsule=ii,t.AreaScalisSeg=It,t.AreaScalisTri=le,t.AreaSphere=Bt,t.DifferenceNode=J,t.DistanceFunctor=Ve,t.Element=u,t.Material=b,t.MaxNode=U,t.MinNode=U,t.Node=g,t.Poly6DistanceFunctor=Te,t.Primitive=nt,t.RicciNode=A,t.RootNode=D,t.SDFCapsule=fi,t.SDFPoint=Ye,t.SDFPrimitive=Re,t.SDFRootNode=Ue,t.SDFSegment=ni,t.SDFSphere=vi,t.ScaleNode=rt,t.ScalisMath=mt,t.ScalisPoint=Rt,t.ScalisPrimitive=dt,t.ScalisSegment=Zt,t.ScalisTriangle=fe,t.ScalisVertex=xt,t.SlidingMarchingCubes=Bi,t.SplitMaxPolygonizer=Gi,t.SplitSMC=Xi,t.TwistNode=Y,t.Types=a,t.version=Zi,Object.defineProperty(t,"__esModule",{value:!0}),t}({},THREE,THREE);
